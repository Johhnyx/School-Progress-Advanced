<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>School Progress</title>

  <style>
    *{ box-sizing:border-box; }
    body{
      font-family: Arial, sans-serif;
      background:#f4f4f4;
      margin:0;
      padding:24px;
      color:#222;
    }
    .wrap{ max-width:1080px; margin:0 auto; }
    h1{
      margin:0 0 14px 0;
      text-align:center;
      font-weight:900;
      letter-spacing:0.2px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      margin-bottom:12px;
    }
    .btn{
      border:none;
      padding:10px 12px;
      border-radius:10px;
      background:#111;
      color:#fff;
      font-weight:800;
      cursor:pointer;
      white-space:nowrap;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width:900px){
      .grid2{ grid-template-columns: 1fr; }
      body{ padding:16px; }
    }

    .colHead{
      text-align:center;
      font-weight:900;
      color:#666;
      margin:0 0 8px 0;
      font-size:13px;
      letter-spacing:0.3px;
    }

    .block{
      background:#fff;
      padding:16px 16px 12px;
      border-radius:12px;
      margin:12px 0;
      box-shadow:0 2px 10px rgba(0,0,0,0.06);
    }
    .rowTitle{
      margin:0 0 10px 0;
      font-size:18px;
      font-weight:900;
    }

    .line{
      position:relative;
      width:100%;
      height:3px;
      background:#e0e0e0;
      border-radius:999px;
      overflow:hidden;
    }
    .fill{
      position:absolute;
      left:0; top:0;
      height:100%;
      width:0%;
      background:#3bb54a;
      border-radius:999px;
      transition: width 0.35s ease;
    }
    .fill.weekend{ background:#ff9800; }

    .label{
      margin:10px 0 0 0;
      font-weight:800;
    }

    .hint{
      margin:10px 0 0 0;
      color:#666;
      font-size:13px;
      line-height:1.35;
    }

    .hidden{ display:none; }
    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      margin:8px 0;
      font-weight:800;
    }

    /* Daily */
    .dailyRow{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      background:#eee;
      font-weight:900;
      font-size:13px;
    }
    .badge.live{ background:#e8f5e9; }
    .badge.free{ background:#fff3cd; } /* ≈ælut√° */
    .badge.err{ background:#fdecea; }
    .dailyText{ font-weight:800; }

    .iframe{
      width:100%;
      height:520px;
      border:1px solid #eee;
      border-radius:10px;
    }

    .statusOk{ color:#0a7a1f; font-weight:900; }
    .statusBad{ color:#b00020; font-weight:900; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>School Progress</h1>

    <div class="topbar">
      <button id="settingsBtn" class="btn" type="button">Nastaven√≠ ‚öôÔ∏è</button>
    </div>

    <div id="settingsPanel" class="block hidden">
      <div class="rowTitle">Nastaven√≠</div>

      <label class="toggle">
        <input type="checkbox" id="toggleTimetable" checked />
        <span>Zobrazit rozvrh</span>
      </label>

      <label class="toggle">
        <input type="checkbox" id="toggleDaily" checked />
        <span>Zobrazit denn√≠ progres</span>
      </label>

      <p class="hint" id="statusHint">Status: inicializace‚Ä¶</p>
    </div>

    <!-- 2 sloupce: Real-Time vs Raw-Time -->
    <div class="grid2">
      <!-- LEFT = Real-Time -->
      <div>
        <div class="colHead">Real-Time</div>

        <div class="block">
          <div class="rowTitle">T√Ωden</div>
          <div class="line"><div class="fill" id="rt-week"></div></div>
          <p class="label" id="rt-week-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Mƒõs√≠c</div>
          <div class="line"><div class="fill" id="rt-month"></div></div>
          <p class="label" id="rt-month-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">≈†koln√≠ rok</div>
          <div class="line"><div class="fill" id="rt-year"></div></div>
          <p class="label" id="rt-year-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Celkem</div>
          <div class="line"><div class="fill" id="rt-total"></div></div>
          <p class="label" id="rt-total-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Maturita</div>
          <p class="label" id="rt-maturita-label"></p>
        </div>
      </div>

      <!-- RIGHT = Raw-Time -->
      <div>
        <div class="colHead">Raw-Time</div>

        <div class="block">
          <div class="rowTitle">T√Ωden</div>
          <div class="line"><div class="fill" id="raw-week"></div></div>
          <p class="label" id="raw-week-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Mƒõs√≠c</div>
          <div class="line"><div class="fill" id="raw-month"></div></div>
          <p class="label" id="raw-month-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">≈†koln√≠ rok</div>
          <div class="line"><div class="fill" id="raw-year"></div></div>
          <p class="label" id="raw-year-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Celkem</div>
          <div class="line"><div class="fill" id="raw-total"></div></div>
          <p class="label" id="raw-total-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Maturita</div>
          <p class="label" id="raw-maturita-label"></p>
        </div>
      </div>
    </div>

    <!-- Daily -->
    <div id="dailyBlock" class="block">
      <div class="rowTitle">Denn√≠ progres</div>
      <div class="dailyRow">
        <div class="badge" id="dailyBadge">Rozvrh</div>
        <div class="dailyText" id="dailyText">Naƒç√≠t√°m rozvrh‚Ä¶</div>
      </div>
      <div class="line" style="margin-top:10px;">
        <div class="fill" id="daybar"></div>
      </div>
      <p class="label" id="daylabel"></p>
      <p class="hint" id="dailyDebug"></p>
    </div>

    <!-- Timetable -->
    <div id="timetableBlock" class="block">
      <div class="rowTitle">Rozvrh</div>
      <div class="hint">Zdroj: ve≈ôejn√Ω Bakal√°≈ôi</div>
      <iframe class="iframe"
              src="https://1kspa-kladno.bakalari.cz/Timetable/Public/Permanent/Class/5A"
              loading="lazy"
              referrerpolicy="no-referrer"></iframe>
    </div>
  </div>

  <script>
    // ==============================
    // CONFIG
    // ==============================
    const TIMETABLE_URL = "https://1kspa-kladno.bakalari.cz/Timetable/Public/Permanent/Class/5A";
    const CORS_PROXY = "https://api.allorigins.win/raw?url=";

    // 4 roky dohromady
    const HS_START = localDate(2023, 9, 4);
    const HS_END   = localDateEnd(2027, 6, 30);

    // Maturita: chce≈° "obvykle" a staƒç√≠ mƒõs√≠c ‚Üí d√°me orientaƒçnƒõ kvƒõten 2027 (1.5.)
    const MATURITA_APPROX = localDateEnd(2027, 5, 1);

    // Pr√°zdniny/volna pro RAW (bez v√≠kend≈Ø a bez pr√°zdnin)
    // P≈ôidal jsem i LETN√ç pr√°zdniny, aby RAW nepoƒç√≠tal ƒçervenec/srpen jako ≈°kolu.
    const BREAKS = [
      // 2023/24
      r("2023-10-26","2023-10-27"),
      r("2023-12-23","2024-01-02"),
      r("2024-02-02","2024-02-02"),
      r("2024-02-26","2024-03-03"), // jarn√≠ Kladno
      r("2024-07-01","2024-08-31"), // letn√≠

      // 2024/25
      r("2024-10-29","2024-10-30"),
      r("2024-12-23","2025-01-03"),
      r("2025-01-31","2025-01-31"),
      r("2025-03-03","2025-03-09"), // jarn√≠ Kladno
      r("2025-07-01","2025-08-31"), // letn√≠

      // 2025/26
      r("2025-10-27","2025-10-29"),
      r("2025-12-22","2026-01-02"),
      r("2026-01-30","2026-01-30"),
      r("2026-03-09","2026-03-15"), // jarn√≠ Kladno
      r("2026-07-01","2026-08-31"), // letn√≠

      // 2026/27
      r("2026-10-29","2026-10-30"),
      r("2026-12-23","2027-01-03"),
      r("2027-01-29","2027-01-29"),
      r("2027-02-01","2027-02-07"), // jarn√≠ Kladno
    ];

    // Pokud bude≈° m√≠t ≈ôeditelsk√© volno, p≈ôidej sem ISO datumy:
    const DIRECTOR_DAYS = [
      // "2026-11-20",
    ];

    // ==============================
    // STATE
    // ==============================
    let timetable = null; // { times:[{startMin,endMin}], days:{Mon:[{subj,room}...],...} }
    let timetableStatus = "Naƒç√≠t√°m rozvrh‚Ä¶";

    // ==============================
    // DOM helpers
    // ==============================
    const $ = (id) => document.getElementById(id);
    const clamp = (x, a=0, b=100) => Math.max(a, Math.min(b, x));
    const setBar = (id, pct, weekend=false) => {
      const n = $(id);
      if (!n) return;
      n.style.width = clamp(pct).toFixed(2) + "%";
      if (weekend) n.classList.add("weekend"); else n.classList.remove("weekend");
    };
    const setText = (id, txt) => { const n=$(id); if(n) n.textContent = txt; };

    // ==============================
    // Date helpers
    // ==============================
    function localDate(y,m,d){ const dt=new Date(y,m-1,d); dt.setHours(0,0,0,0); return dt; }
    function localDateEnd(y,m,d){ const dt=new Date(y,m-1,d); dt.setHours(23,59,59,999); return dt; }

    function toISO(d){
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,'0');
      const da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    function r(s,e){ return {s,e}; }
    function inBreak(iso){ return BREAKS.some(x => iso>=x.s && iso<=x.e); }

    function isSchoolDay(d){
      const dow = d.getDay();
      if (dow===0 || dow===6) return false;
      const iso = toISO(d);
      if (DIRECTOR_DAYS.includes(iso)) return false;
      if (inBreak(iso)) return false;
      return true;
    }

    function countSchoolDays(start, end){
      const s = new Date(start); s.setHours(0,0,0,0);
      const e = new Date(end);   e.setHours(23,59,59,999);
      let c=0;
      const cur = new Date(s);
      while (cur <= e){
        if (isSchoolDay(cur)) c++;
        cur.setDate(cur.getDate()+1);
      }
      return c;
    }

    function calendarPctBetween(start, end, now){
      const total = end - start;
      if (total<=0) return 0;
      const passed = Math.min(Math.max(now-start, 0), total);
      return (passed/total)*100;
    }

    function rawPctBetween(start, end, now){
      const total = countSchoolDays(start, end);
      const clipped = now < start ? start : (now > end ? end : now);
      const passed = countSchoolDays(start, clipped);
      return total ? (passed/total)*100 : 0;
    }

    function rawDaysUntil(target, now){
      // jen ≈°koln√≠ dny mezi "teƒè" a target (exkluzivnƒõ dnes? ‚Äî prakticky to bereme od z√≠t≈ôka)
      // jednodu≈°e: poƒçet ≈°koln√≠ch dn√≠ v (now..target)
      const start = new Date(now); start.setHours(0,0,0,0);
      const end = new Date(target); end.setHours(23,59,59,999);
      if (end < start) return -countSchoolDays(end, start);
      // vezmeme od dne≈°ka do c√≠le, ale pokud dnes nen√≠ ≈°koln√≠ den, stejnƒõ se to chov√° OK
      return countSchoolDays(start, end);
    }

    // ≈†koln√≠ rok rozsah (jednodu≈°e: 1.9 ‚Äì 30.6)
    function getSchoolYearRange(now){
      const y = (now.getMonth()>=8) ? now.getFullYear() : now.getFullYear()-1; // z√°≈ô√≠=8
      return { start: localDate(y,9,1), end: localDateEnd(y+1,6,30) };
    }

    // ==============================
    // Settings UI
    // ==============================
    function initSettings(){
      const btn = $("settingsBtn");
      const panel = $("settingsPanel");
      const toggleTT = $("toggleTimetable");
      const toggleDaily = $("toggleDaily");
      const timetableBlock = $("timetableBlock");
      const dailyBlock = $("dailyBlock");

      btn.addEventListener("click", () => panel.classList.toggle("hidden"));
      toggleTT.addEventListener("change", () => timetableBlock.classList.toggle("hidden", !toggleTT.checked));
      toggleDaily.addEventListener("change", () => dailyBlock.classList.toggle("hidden", !toggleDaily.checked));
    }

    // ==============================
    // Timetable fetch + parse (subject + room)
    // ==============================
    async function loadTimetable(){
      try{
        timetableStatus = "Naƒç√≠t√°m rozvrh‚Ä¶";
        setDailyLoading();

        const res = await fetch(CORS_PROXY + encodeURIComponent(TIMETABLE_URL), { cache:"no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const html = await res.text();

        timetable = parseBakalari(html);
        timetableStatus = "Rozvrh naƒçten ‚úî";
        setText("dailyDebug", `Parser: times=${timetable.times.length}, Mon=${timetable.days.Mon.length}`);
      } catch(e){
        timetable = null;
        timetableStatus = "Rozvrh se nepoda≈ôilo naƒç√≠st (proxy/CORS) nebo parser nena≈°el strukturu.";
        setDailyError(timetableStatus);
        setText("dailyDebug", String(e && e.message ? e.message : e));
      } finally {
        setStatus();
      }
    }

    function parseBakalari(html){
      // Parse DOM
      const doc = new DOMParser().parseFromString(html, "text/html");

      // 1) naj√≠t v≈°echny time ranges jako "7:55 - 8:40"
      const bodyText = (doc.body ? doc.body.innerText : "") || "";
      const timeRe = /(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/g;
      const times = [];
      let m;
      while ((m = timeRe.exec(bodyText)) !== null){
        const sMin = parseInt(m[1],10)*60 + parseInt(m[2],10);
        const eMin = parseInt(m[3],10)*60 + parseInt(m[4],10);
        if (!times.some(t => t.startMin===sMin && t.endMin===eMin)){
          times.push({startMin:sMin, endMin:eMin});
        }
      }
      times.sort((a,b)=>a.startMin-b.startMin);
      if (!times.length) throw new Error("Nenalezeny ƒçasy hodin v HTML.");

      // 2) pokus: z tabulek vyt√°hnout bu≈àky pro Mon..Fri v po≈ôad√≠ hodin
      // Najdeme table, kter√° m√° nejv√≠c bunƒõk a obsahuje Mon Tue Wed Thu Fri
      const tables = Array.from(doc.querySelectorAll("table"));
      let bestTable = null;
      let bestScore = -1;

      for (const t of tables){
        const txt = (t.innerText || "").toUpperCase();
        const hasDays = txt.includes("MON") && txt.includes("TUE") && txt.includes("WED") && txt.includes("THU") && txt.includes("FRI");
        if (!hasDays) continue;
        const cells = t.querySelectorAll("td,th").length;
        if (cells > bestScore){
          bestScore = cells;
          bestTable = t;
        }
      }

      // fallback: kdy≈æ tabulka nen√≠, jedeme text segmenty (m√©nƒõ p≈ôesn√©)
      const days = { Mon:[], Tue:[], Wed:[], Thu:[], Fri:[] };
      if (!bestTable){
        return parseByTextSegments(bodyText, times);
      }

      // Z headeru se pokus√≠me naj√≠t indexy sloupc≈Ø Mon..Fri
      const rows = Array.from(bestTable.querySelectorAll("tr"));
      if (!rows.length) return parseByTextSegments(bodyText, times);

      // najdi header row s Mon Tue...
      let headerCells = null;
      for (const r of rows){
        const ths = Array.from(r.querySelectorAll("th"));
        const line = ths.map(x => (x.innerText||"").trim().toUpperCase());
        if (line.join(" ").includes("MON") && line.join(" ").includes("TUE") && line.join(" ").includes("FRI")){
          headerCells = ths;
          break;
        }
      }

      // pokud headerCells nenajdeme, fallback
      if (!headerCells){
        return parseByTextSegments(bodyText, times);
      }

      const header = headerCells.map(x => (x.innerText||"").trim().toUpperCase());
      const idxMon = header.findIndex(x => x==="MON");
      const idxTue = header.findIndex(x => x==="TUE");
      const idxWed = header.findIndex(x => x==="WED");
      const idxThu = header.findIndex(x => x==="THU");
      const idxFri = header.findIndex(x => x==="FRI");

      const idxs = { Mon: idxMon, Tue: idxTue, Wed: idxWed, Thu: idxThu, Fri: idxFri };
      if (Object.values(idxs).some(i => i<0)){
        return parseByTextSegments(bodyText, times);
      }

      // Teƒè projdeme ≈ô√°dky a bereme bu≈àky v tƒõch sloupc√≠ch.
      // Chceme v po≈ôad√≠ hodin: times.length polo≈æek pro ka≈æd√Ω den.
      const collected = { Mon:[], Tue:[], Wed:[], Thu:[], Fri:[] };

      for (const r of rows){
        const tds = Array.from(r.querySelectorAll("td"));
        if (!tds.length) continue;

        for (const dayKey of ["Mon","Tue","Wed","Thu","Fri"]){
          const i = idxs[dayKey];
          const cell = tds[i] || null;
          if (!cell) continue;

          const parsed = parseLessonCell(cell.innerText || "");
          // parsed m≈Ø≈æe b√Ωt null (pr√°zdno / okno)
          collected[dayKey].push(parsed);
        }
      }

      // vyƒçistit: nƒõkter√© ≈ô√°dky nejsou hodiny, tak≈æe to p≈ôepln√≠me.
      // vezmeme prvn√≠ times.length nepr√°zdn√Ωch ‚Äúslot≈Ø‚Äù pro ka≈æd√Ω den.
      for (const k of ["Mon","Tue","Wed","Thu","Fri"]){
        const arr = collected[k]
          .map(x => x && (x.subj || x.room) ? x : null)
          .filter(x => x !== undefined); // zachovej i null sloty
        // o≈ô√≠zni na times.length, ale zachovej po≈ôad√≠ ‚Äî kdy≈æ je moc, ber prvn√≠
        days[k] = arr.slice(0, times.length).map(x => x || null);
      }

      return { times, days };
    }

    function parseLessonCell(txt){
      const raw = (txt || "").replace(/\s+/g," ").trim();
      if (!raw) return null;

      // Nechceme ≈°um typu "DN3" nebo "k≈°pa"
      // P≈ôedmƒõt typicky: velk√© p√≠smena (vƒç diakritiky) + p≈ô√≠padnƒõ ƒç√≠slo
      const subjMatch = raw.match(/\b([A-Z√Åƒåƒé√âƒö√ç≈á√ì≈ò≈†≈§√ö≈Æ√ù≈Ω]{2,6}\d?)\b/);
      const subj = subjMatch ? subjMatch[1] : null;

      // Uƒçebna typicky "Uƒå10" / "UC10" / "uƒç10"
      const roomMatch = raw.match(/\b(Uƒå|UC|uƒç|uc)\s*?(\d{1,3})\b/);
      const room = roomMatch ? `Uƒå${roomMatch[2]}` : null;

      // Pokud "subj" vypad√° jako uƒçitel (3 p√≠smena) nebo ≈°um, zahod√≠me
      const badTeacherLike = subj && /^[A-Z√Åƒåƒé√âƒö√ç≈á√ì≈ò≈†≈§√ö≈Æ√ù≈Ω]{3}$/.test(subj);
      if (badTeacherLike) return null;

      // Pokud m√°me jen nƒõco jako DN3 (to projde regexem?), tak filtr:
      if (subj && /^DN\d+$/i.test(subj)) return null;

      // "k≈°pa" je mal√©, to regex ani nevezme jako subj. Good.

      if (!subj && !room) return null;
      return { subj, room };
    }

    function parseByTextSegments(text, times){
      // posledn√≠ z√°chrana: segmenty podle Mon/Tue... a vyzobat p≈ôedmƒõt+uƒçebnu
      const days = { Mon:[], Tue:[], Wed:[], Thu:[], Fri:[] };

      const upper = text.toUpperCase();
      const seg = (a,b) => {
        const i = upper.indexOf(a);
        if (i<0) return "";
        const j = b ? upper.indexOf(b, i+a.length) : -1;
        return j>=0 ? text.slice(i,j) : text.slice(i);
      };

      const segMon = seg("MON","TUE");
      const segTue = seg("TUE","WED");
      const segWed = seg("WED","THU");
      const segThu = seg("THU","FRI");
      const segFri = seg("FRI",null);

      const pack = (s) => {
        const items = [];
        // p≈ôedmƒõt
        const subjRe = /\b([A-Z√Åƒåƒé√âƒö√ç≈á√ì≈ò≈†≈§√ö≈Æ√ù≈Ω]{2,6}\d?)\b/g;
        // uƒçebna
        const roomRe = /\b(Uƒå|UC|uƒç|uc)\s*?(\d{1,3})\b/g;

        const subs = [];
        let m;
        while((m=subjRe.exec(s))!==null){
          const tok=m[1];
          if (["MON","TUE","WED","THU","FRI"].includes(tok)) continue;
          if (/^DN\d+$/i.test(tok)) continue;
          if (/^[A-Z√Åƒåƒé√âƒö√ç≈á√ì≈ò≈†≈§√ö≈Æ√ù≈Ω]{3}$/.test(tok)) continue; // uƒçitel
          subs.push(tok);
        }

        const rooms = [];
        while((m=roomRe.exec(s))!==null){
          rooms.push(`Uƒå${m[2]}`);
        }

        // sp√°ruj hrubƒõ 1:1 podle indexu
        const n = times.length;
        for (let i=0;i<n;i++){
          items.push({ subj: subs[i] || null, room: rooms[i] || null });
        }
        return items;
      };

      days.Mon = pack(segMon);
      days.Tue = pack(segTue);
      days.Wed = pack(segWed);
      days.Thu = pack(segThu);
      days.Fri = pack(segFri);

      return { times, days };
    }

    // ==============================
    // Daily UI
    // ==============================
    function setDailyLoading(){
      const b=$("dailyBadge"); b.className="badge"; b.textContent="Rozvrh";
      setText("dailyText","Naƒç√≠t√°m rozvrh‚Ä¶");
      setBar("daybar",0);
      setText("daylabel","");
    }
    function setDailyError(msg){
      const b=$("dailyBadge"); b.className="badge err"; b.textContent="Chyba";
      setText("dailyText",msg);
      setBar("daybar",0);
      setText("daylabel","");
    }
    function setDailyFree(){
      const b=$("dailyBadge"); b.className="badge free"; b.textContent="Volno";
      setText("dailyText","Volno üòé");
      setBar("daybar",100);
      setText("daylabel","");
    }

    function minutesToHHMM(min){
      const h=String(Math.floor(min/60)).padStart(2,"0");
      const m=String(min%60).padStart(2,"0");
      return `${h}:${m}`;
    }

    function fmtLesson(x){
      if (!x) return null;
      if (!x.subj) return null;
      if (x.room) return `${x.subj} (${x.room})`;
      return `${x.subj}`;
    }

    function updateDaily(now){
      // v√≠kend
      const dow = now.getDay();
      if (dow===0 || dow===6){ setDailyFree(); return; }

      if (!timetable){
        setDailyError(timetableStatus);
        return;
      }

      const key = (dow===1)?"Mon":(dow===2)?"Tue":(dow===3)?"Wed":(dow===4)?"Thu":"Fri";
      const times = timetable.times;
      const lessons = (timetable.days[key] || []).slice(0, times.length);

      const nowMin = now.getHours()*60 + now.getMinutes();
      const first = times[0];
      const last  = times[times.length-1];

      // po ≈°kole
      if (nowMin > last.endMin){
        setDailyFree();
        return;
      }

      // p≈ôed zaƒç√°tkem
      if (nowMin < first.startMin){
        const b=$("dailyBadge"); b.className="badge live"; b.textContent="Dnes";
        const next = fmtLesson(lessons[0]) || "Hodina 1";
        setText("dailyText",`Za chv√≠li zaƒçne: ${next}`);
        setBar("daybar",0);
        setText("daylabel",`Start v ${minutesToHHMM(first.startMin)}`);
        return;
      }

      // bƒõhem dne: hodina / pauza
      for (let i=0;i<times.length;i++){
        const t=times[i];
        const cur = fmtLesson(lessons[i]) || `Hodina ${i+1}`;
        const next = (i+1<times.length) ? (fmtLesson(lessons[i+1]) || `Hodina ${i+2}`) : null;

        // hodina bƒõ≈æ√≠
        if (nowMin >= t.startMin && nowMin <= t.endMin){
          const pct = ((nowMin - t.startMin) / Math.max(1,(t.endMin - t.startMin))) * 100;
          const b=$("dailyBadge"); b.className="badge live"; b.textContent="Pr√°vƒõ";
          setText("dailyText", next ? `Pr√°vƒõ: ${cur} ‚Ä¢ Dal≈°√≠: ${next}` : `Pr√°vƒõ: ${cur}`);
          setBar("daybar", pct);
          setText("daylabel", `Hodina ${i+1} ‚Ä¢ ${minutesToHHMM(t.startMin)}‚Äì${minutesToHHMM(t.endMin)} ‚Ä¢ ${pct.toFixed(0)}%`);
          return;
        }

        // pauza
        const nt = times[i+1];
        if (nt && nowMin > t.endMin && nowMin < nt.startMin){
          const b=$("dailyBadge"); b.className="badge live"; b.textContent="Pauza";
          setText("dailyText", `N√°sleduje: ${next}`);
          setBar("daybar", 0);
          setText("daylabel", `Dal≈°√≠ hodina v ${minutesToHHMM(nt.startMin)}`);
          return;
        }
      }

      // fallback
      setDailyFree();
    }

    // ==============================
    // MAIN update
    // ==============================
    function updateAll(){
      const now = new Date();
      const timeInDay = now.getHours()/24 + now.getMinutes()/1440;

      // WEEK: Po‚ÄìP√° (5 dn√≠), v√≠kend = orange + Weekend üòé
      const dow = now.getDay(); // Ne=0
      const weekend = (dow===0 || dow===6);
      const workIndex = (dow===1)?0:(dow===2)?1:(dow===3)?2:(dow===4)?3:(dow===5)?4:4;
      const weekPct = weekend ? 100 : ((workIndex + timeInDay)/5)*100;

      // Real-time week
      setBar("rt-week", weekPct, weekend);
      setText("rt-week-label", weekend ? "Weekend üòé" : `T√Ωden: ${weekPct.toFixed(1)}%`);

      // Raw-time week = stejn√° logika (u≈æ je bez v√≠kend≈Ø)
      setBar("raw-week", weekPct, false);
      setText("raw-week-label", `T√Ωden: ${weekPct.toFixed(1)}%`);

      // MONTH: calendar
      const dim = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
      const monthPct = ((now.getDate()-1 + timeInDay)/dim)*100;
      setBar("rt-month", monthPct);
      setText("rt-month-label", `Mƒõs√≠c: ${monthPct.toFixed(1)}%`);

      // MONTH raw: school days only in this month
      const mStart = localDate(now.getFullYear(), now.getMonth()+1, 1);
      const mEnd   = localDateEnd(now.getFullYear(), now.getMonth()+1, dim);
      const monthRaw = rawPctBetween(mStart, mEnd, now);
      setBar("raw-month", monthRaw);
      setText("raw-month-label", `Mƒõs√≠c: ${monthRaw.toFixed(1)}%`);

      // SCHOOL YEAR realtime
      const yr = getSchoolYearRange(now);
      const yearPct = calendarPctBetween(yr.start, yr.end, now);
      setBar("rt-year", yearPct);
      setText("rt-year-label", `≈†koln√≠ rok: ${yearPct.toFixed(1)}%`);

      // SCHOOL YEAR raw
      const yearRaw = rawPctBetween(yr.start, yr.end, now);
      setBar("raw-year", yearRaw);
      setText("raw-year-label", `≈†koln√≠ rok: ${yearRaw.toFixed(1)}%`);

      // TOTAL realtime
      const totalPct = calendarPctBetween(HS_START, HS_END, now);
      setBar("rt-total", totalPct);
      setText("rt-total-label", `Celkem: ${totalPct.toFixed(1)}%`);

      // TOTAL raw
      const totalRaw = rawPctBetween(HS_START, HS_END, now);
      setBar("raw-total", totalRaw);
      setText("raw-total-label", `Celkem: ${totalRaw.toFixed(1)}%`);

      // MATURITA realtime: kalend√°≈ôn√≠ dny do (orientaƒçnƒõ kvƒõten 2027)
      const daysUntil = Math.ceil((MATURITA_APPROX - now) / (1000*60*60*24));
      setText("rt-maturita-label",
        (daysUntil>=0)
          ? `Real-Time: ~${daysUntil} dn√≠ (kvƒõten 2027)`
          : `Real-Time: hotovo (${Math.abs(daysUntil)} dn√≠ zpƒõt)`
      );

      // MATURITA raw: ≈°koln√≠ dny do c√≠le
      const rawDays = rawDaysUntil(MATURITA_APPROX, now);
      setText("raw-maturita-label",
        (rawDays>=0)
          ? `Raw-Time: ~${rawDays} ≈°koln√≠ch dn√≠ (bez v√≠kend≈Ø/pr√°zdnin)`
          : `Raw-Time: hotovo (${Math.abs(rawDays)} ≈°koln√≠ch dn√≠ zpƒõt)`
      );

      // Daily (pokud zapnuto)
      const toggleDaily = $("toggleDaily");
      if (!toggleDaily || toggleDaily.checked){
        updateDaily(now);
      }

      setStatus(true);
    }

    function setStatus(ok=true){
      const el = $("statusHint");
      if (!el) return;
      const base = timetable ? "Rozvrh: OK" : ("Rozvrh: " + timetableStatus);
      el.innerHTML = ok
        ? `<span class="statusOk">Status: OK</span> ‚Ä¢ ${base}`
        : `<span class="statusBad">Status: CHYBA</span> ‚Ä¢ ${base}`;
    }

    // ==============================
    // BOOT
    // ==============================
    function boot(){
      initSettings();

      // first render
      try{ updateAll(); } catch(e){
        timetableStatus = "JS chyba: " + e.message;
        setStatus(false);
      }

      // load timetable async
      loadTimetable().finally(() => {
        try{ updateAll(); } catch(e){
          timetableStatus = "JS chyba po rozvrhu: " + e.message;
          setStatus(false);
        }
      });

      setInterval(() => {
        try{ updateAll(); } catch(e){
          timetableStatus = "JS chyba v interval: " + e.message;
          setStatus(false);
        }
      }, 30_000);
    }

    document.addEventListener("DOMContentLoaded", boot);
  </script>
</body>
</html>