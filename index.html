<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>School Progress</title>

  <style>
    /* =========================
       THEMES via CSS variables
       ========================= */
    body{
      --bg:#f4f4f4;
      --card:#ffffff;
      --text:#222;
      --muted:#666;
      --shadow: rgba(0,0,0,0.06);
      --linebg:#e0e0e0;
      --green:#3bb54a;
      --orange:#ff9800;

      --btn:#111;
      --btnText:#fff;

      --badge:#eee;
      --badgeLive:#e8f5e9;
      --badgeFree:#fff3cd;
      --badgeErr:#fdecea;

      --border:#eee;

      --accent:#ff2ea6;
      --accent2:#ff5fd1;
      --glow: rgba(255,46,166,0.45);

      --bgImage: none;
      --bgOverlay: linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.0));

      /* Fancy timetable state colors */
      --substBg: rgba(255, 80, 80, 0.18);
      --substBorder: rgba(255, 80, 80, 0.40);

      --cancelBg: rgba(255, 0, 60, 0.22);
      --cancelBorder: rgba(255, 0, 60, 0.55);

      --eventBg: rgba(59,181,74,0.22);
      --eventBorder: rgba(59,181,74,0.55);

      /* unified timetable subject color */
      --ttSubjColor: rgba(20, 35, 60, 0.92);
      --ttSubjGlow: none;
    }

    body.theme-dark{
      --bg:#0f1115;
      --card:#171a21;
      --text:#e7e9ee;
      --muted:#a6acb8;
      --shadow: rgba(0,0,0,0.35);
      --linebg:#2a2f3a;

      --btn:#e7e9ee;
      --btnText:#111;

      --badge:#232836;
      --badgeLive:#1f3a2a;
      --badgeFree:#3a311f;
      --badgeErr:#3a1f23;

      --border:#2a2f3a;

      --substBg: rgba(255, 80, 80, 0.20);
      --substBorder: rgba(255, 80, 80, 0.48);

      --cancelBg: rgba(255, 0, 60, 0.26);
      --cancelBorder: rgba(255, 0, 60, 0.60);

      --eventBg: rgba(59,181,74,0.18);
      --eventBorder: rgba(59,181,74,0.50);

      --ttSubjColor: rgba(235, 240, 250, 0.95);
      --ttSubjGlow: none;
    }

    body.theme-loona{
      --bg:#08060b;
      --card: rgba(18, 12, 22, 0.78);
      --text:#ffe9f6;
      --muted:#d7a6c4;
      --shadow: rgba(0,0,0,0.55);
      --linebg: rgba(255, 70, 190, 0.18);

      --btn:#ff2ea6;
      --btnText:#120812;

      --badge: rgba(255, 46, 166, 0.18);
      --badgeLive: rgba(0, 255, 170, 0.12);
      --badgeFree: rgba(255, 190, 60, 0.16);
      --badgeErr: rgba(255, 80, 80, 0.16);

      --border: rgba(255, 70, 190, 0.20);

      --accent:#ff2ea6;
      --accent2:#ff6bd8;
      --glow: rgba(255,46,166,0.55);

      --bgImage: url("loona.png");
      --bgOverlay: linear-gradient(180deg, rgba(8,6,11,0.78), rgba(8,6,11,0.92));

      --substBg: rgba(255, 46, 166, 0.22);
      --substBorder: rgba(255, 46, 166, 0.52);

      --cancelBg: rgba(255, 0, 90, 0.28);
      --cancelBorder: rgba(255, 0, 90, 0.62);

      --eventBg: rgba(59,181,74,0.20);
      --eventBorder: rgba(59,181,74,0.55);

      --ttSubjColor: rgba(255, 107, 216, 0.98);
      --ttSubjGlow: 0 0 14px rgba(255, 46, 166, 0.35);
    }

    body.theme-sobokill{
      --bg:#070604;
      --card: rgba(18, 14, 8, 0.82);
      --text:#fff3dc;
      --muted:#d2b98b;
      --shadow: rgba(0,0,0,0.60);
      --linebg: rgba(212, 175, 55, 0.18);

      --btn:#d4af37;
      --btnText:#1a1206;

      --badge: rgba(212,175,55,0.16);
      --badgeLive: rgba(0, 210, 160, 0.12);
      --badgeFree: rgba(255,190,60,0.16);
      --badgeErr: rgba(255,80,80,0.16);

      --border: rgba(212,175,55,0.22);

      --accent:#d4af37;
      --accent2:#f1d07a;
      --glow: rgba(212,175,55,0.40);

      --bgImage: url("sobokill.png");
      --bgOverlay: linear-gradient(180deg, rgba(7,6,4,0.76), rgba(7,6,4,0.92));

      --substBg: rgba(212, 175, 55, 0.22);
      --substBorder: rgba(212, 175, 55, 0.50);

      --cancelBg: rgba(255, 0, 60, 0.24);
      --cancelBorder: rgba(255, 0, 60, 0.58);

      --eventBg: rgba(59,181,74,0.20);
      --eventBorder: rgba(59,181,74,0.55);

      --ttSubjColor: rgba(241, 208, 122, 0.98);
      --ttSubjGlow: 0 0 14px rgba(212, 175, 55, 0.30);
    }

    /* =========================
       BASE STYLES
       ========================= */
    *{ box-sizing:border-box; }
    body{
      font-family: Arial, sans-serif;
      margin:0;
      padding:24px;
      color:var(--text);
      background:
        var(--bgOverlay),
        var(--bgImage),
        radial-gradient(1200px 700px at 15% 15%, rgba(255,46,166,0.14), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(255,95,209,0.12), transparent 60%),
        radial-gradient(1000px 650px at 30% 90%, rgba(212,175,55,0.10), transparent 60%),
        var(--bg);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      transition: background .2s ease, color .2s ease;
    }

    .wrap{ max-width:1180px; margin:0 auto; }
    h1{
      margin:0 0 14px 0;
      text-align:center;
      font-weight:900;
      letter-spacing:0.2px;
      text-shadow: 0 0 0 transparent;
    }
    body.theme-loona h1,
    body.theme-sobokill h1{
      text-shadow: 0 0 18px var(--glow);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      margin-bottom:12px;
      gap:10px;
    }
    .btn{
      border:none;
      padding:10px 12px;
      border-radius:10px;
      background:var(--btn);
      color:var(--btnText);
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
      box-shadow: 0 0 0 transparent;
    }
    body.theme-loona .btn,
    body.theme-sobokill .btn{
      box-shadow: 0 0 18px var(--glow);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width:980px){
      .grid2{ grid-template-columns: 1fr; }
      body{ padding:16px; }
    }

    .colHead{
      text-align:center;
      font-weight:900;
      color:var(--muted);
      margin:0 0 8px 0;
      font-size:13px;
      letter-spacing:0.3px;
    }

    .block{
      background:var(--card);
      padding:16px 16px 12px;
      border-radius:12px;
      margin:12px 0;
      border: 1px solid var(--border);
      box-shadow:0 2px 10px var(--shadow);
      backdrop-filter: blur(10px);
    }
    body.theme-loona .block,
    body.theme-sobokill .block{
      box-shadow: 0 6px 26px rgba(0,0,0,0.55), 0 0 0.5px rgba(255,255,255,0.05);
    }

    .rowTitle{
      margin:0 0 10px 0;
      font-size:18px;
      font-weight:900;
      color: var(--text);
    }
    body.theme-loona .rowTitle{ color: var(--accent2); }
    body.theme-sobokill .rowTitle{ color: var(--accent2); }

    .line{
      position:relative;
      width:100%;
      height:3px;
      background:var(--linebg);
      border-radius:999px;
      overflow:hidden;
    }
    .fill{
      position:absolute;
      left:0; top:0;
      height:100%;
      width:0%;
      background:var(--green);
      border-radius:999px;
      transition: width 0.35s ease;
    }
    .fill.weekend{ background:var(--orange); }

    .label{ margin:10px 0 0 0; font-weight:900; }
    .hint{ margin:10px 0 0 0; color:var(--muted); font-size:13px; line-height:1.35; }

    .hidden{ display:none !important; }
    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      margin:8px 0;
      font-weight:900;
    }

    .field{
      display:flex;
      align-items:center;
      gap:10px;
      margin:10px 0 6px;
      font-weight:900;
    }
    select{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background: transparent;
      color: var(--text);
      font-weight:900;
      outline:none;
    }

    .dailyRow{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      background:var(--badge);
      font-weight:900;
      font-size:13px;
    }
    .badge.live{ background:var(--badgeLive); }
    .badge.free{ background:var(--badgeFree); }
    .badge.err{ background:var(--badgeErr); }
    .dailyText{ font-weight:900; }

    /* =========================
       SIDE PANELS: Events + Cafa
       ========================= */
    .stackList{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .stackItem{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background: rgba(255,255,255,0.04);
      box-shadow: 0 1px 6px var(--shadow);
    }
    .stackItem.muted{
      color: var(--muted);
      font-weight: 900;
    }
    .eventItem{
      border-left: 4px solid var(--green);
    }
    .eventTitle{
      font-weight: 1000;
      font-size: 14px;
      line-height: 1.2;
    }
    .eventMeta{
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 900;
      line-height: 1.3;
    }
    .eventDesc{
      margin-top: 6px;
      font-size: 12px;
      line-height: 1.35;
      color: var(--text);
      font-weight: 800;
      opacity: .95;
    }

    .trackerCard{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background: rgba(255,255,255,0.04);
      box-shadow: 0 2px 10px var(--shadow);
    }
    .trackerBadge{
      display:inline-block;
      padding:5px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:1000;
      background: var(--badge);
      color: var(--text);
      margin-bottom:8px;
    }
    .trackerBadge.live{ background: var(--badgeLive); }
    .trackerBadge.shadow{ background: var(--badgeFree); }
    .trackerBadge.err{ background: var(--badgeErr); }
    .trackerMain{
      font-weight: 1000;
      font-size: 15px;
      line-height: 1.25;
    }
    .trackerSub{
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 900;
      line-height: 1.35;
    }

    /* =========================
       FANCY TIMETABLE
       ========================= */
    .timetable .tt-top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
      flex-wrap: wrap;
    }
    .tt-sub{
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      margin-top: 2px;
    }
    .tt-badge{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      margin-left: 8px;
    }
    .tt-metaRow{
      display:flex;
      align-items:center;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
    }

    .tt-gridWrap{
      overflow-x:auto;
      padding-bottom:4px;
    }

    .tt-grid{
      display:grid;
      grid-template-columns: 58px repeat(var(--cols), minmax(120px, 1fr));
      gap:10px;
      min-width: 920px;
    }

    .tt-corner{ height:44px; }

    .tt-h{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background: rgba(255,255,255,0.04);
      text-align:center;
      font-weight: 900;
    }
    .tt-h span{
      display:block;
      font-size: 11px;
      font-weight: 900;
      color: var(--muted);
      margin-top: 4px;
    }

    .tt-day{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 0;
      text-align:center;
      font-weight: 900;
      color: var(--muted);
      background: rgba(255,255,255,0.03);
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 78px;
    }

    .tt-cell{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background: rgba(255,255,255,0.04);
      box-shadow: 0 2px 10px var(--shadow);
      position: relative;
      overflow: hidden;
      min-height: 78px;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      cursor: default;
    }
    .tt-cell:hover{
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
    }

    .tt-topline{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      font-weight: 1000;
      font-size: 11px;
      color: var(--muted);
      opacity: 0.95;
    }
    .tt-topline .cls{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .tt-topline .room{ white-space:nowrap; opacity: 0.95; }

    .tt-subj{
      font-weight: 1000;
      letter-spacing: .2px;
      margin-top: 6px;
      font-size: 22px;
      color: var(--ttSubjColor) !important;
      text-shadow: var(--ttSubjGlow);
      line-height: 1;
    }

    .tt-teacher{
      font-weight: 900;
      color: var(--muted);
      font-size: 11px;
      margin-top: 8px;
      opacity: 0.95;
    }

    .tt-empty{
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--muted);
      font-weight: 900;
      background: rgba(255,255,255,0.02);
      box-shadow: none;
    }

    .tt-event{
      border-color: var(--eventBorder);
      background: var(--eventBg);
      box-shadow: 0 0 0 1px var(--eventBorder) inset, 0 0 18px rgba(59,181,74,0.25);
    }

    .tt-subst{
      border-color: var(--substBorder);
      background: var(--substBg);
      box-shadow: 0 0 0 1px var(--substBorder) inset, 0 0 22px rgba(255,80,80,0.30);
    }
    body.theme-loona .tt-subst{ box-shadow: 0 0 0 1px var(--substBorder) inset, 0 0 24px rgba(255,46,166,0.30); }
    body.theme-sobokill .tt-subst{ box-shadow: 0 0 0 1px var(--substBorder) inset, 0 0 24px rgba(212,175,55,0.28); }

    .tt-cancel{
      border-color: var(--cancelBorder);
      background:
        repeating-linear-gradient(
          135deg,
          rgba(255,255,255,0.14) 0px,
          rgba(255,255,255,0.14) 10px,
          rgba(0,0,0,0.00) 10px,
          rgba(0,0,0,0.00) 20px
        ),
        var(--cancelBg);
      box-shadow: 0 0 0 1px var(--cancelBorder) inset, 0 0 24px rgba(255,0,60,0.28);
    }

    .tt-cell.current{
      outline: 2px solid rgba(0,170,255,0.85);
      outline-offset: -2px;
      box-shadow: 0 0 0 1px rgba(0,170,255,0.55) inset, 0 0 20px rgba(0,170,255,0.22);
    }

    /* Tooltip */
    .tt-tooltip{
      position: fixed;
      z-index: 9999;
      max-width: 360px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(20, 20, 26, 0.92);
      color: #fff;
      box-shadow: 0 12px 40px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
      font-weight: 900;
      font-size: 12px;
      line-height: 1.35;
      transform: translate(12px, 12px);
      display:none;
      pointer-events:none;
    }
    .tt-tooltip .t-title{
      font-size: 13px;
      letter-spacing: .2px;
      margin-bottom: 6px;
    }
    .tt-tooltip .t-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      border-top: 1px solid rgba(255,255,255,0.10);
      padding-top: 6px;
      margin-top: 6px;
    }
    .tt-tooltip .k{ color: rgba(255,255,255,0.70); }
    .tt-tooltip .v{ color: #fff; text-align:right; }

    .footer{
      margin-top: 18px;
      padding: 14px 0 2px;
      text-align: center;
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      letter-spacing: .2px;
      user-select: none;
    }
  </style>
</head>

<body class="theme-dark">
  <div class="wrap">
    <h1>School Progress</h1>

    <div class="topbar">
      <button id="settingsBtn" class="btn" type="button">Nastavení ⚙️</button>
    </div>

    <div id="settingsPanel" class="block hidden">
      <div class="rowTitle">Nastavení</div>

      <div class="field">
        <span>Theme</span>
        <select id="themeSelect" aria-label="Theme">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
          <option value="loona">Loona</option>
          <option value="sobokill">SOBOKILL</option>
        </select>
      </div>

      <label class="toggle">
        <input type="checkbox" id="toggleTimetable" checked />
        <span>Zobrazit rozvrh</span>
      </label>

      <label class="toggle">
        <input type="checkbox" id="toggleDaily" checked />
        <span>Zobrazit denní progres</span>
      </label>

      <p class="hint" id="statusHint">Status: OK</p>
      <p class="hint">Hover / tap na buňku rozvrhu = detail. Backend fallback na lokální data je zapnutý.</p>
    </div>

    <div class="grid2">
      <div>
        <div class="colHead">Real-Time</div>

        <div class="block">
          <div class="rowTitle">Týden</div>
          <div class="line"><div class="fill" id="rt-week"></div></div>
          <p class="label" id="rt-week-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Měsíc</div>
          <div class="line"><div class="fill" id="rt-month"></div></div>
          <p class="label" id="rt-month-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Školní rok</div>
          <div class="line"><div class="fill" id="rt-year"></div></div>
          <p class="label" id="rt-year-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Celkem</div>
          <div class="line"><div class="fill" id="rt-total"></div></div>
          <p class="label" id="rt-total-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Maturita</div>
          <p class="label" id="rt-maturita-label"></p>
        </div>

        <div class="block" id="eventsBlock">
          <div class="rowTitle">Události</div>
          <div id="eventsList" class="stackList">
            <div class="stackItem muted">Načítání událostí…</div>
          </div>
        </div>

        <div class="block" id="cafaBlock">
          <div class="rowTitle">Cáfa Tracker</div>
          <div class="trackerCard">
            <div class="trackerBadge" id="cafaBadge">Cáfa</div>
            <div class="trackerMain" id="cafaMain">Hledám stopu v rozvrhu…</div>
            <div class="trackerSub" id="cafaSub">—</div>
          </div>
        </div>
      </div>

      <div>
        <div class="colHead">Raw-Time</div>

        <div class="block">
          <div class="rowTitle">Týden</div>
          <div class="line"><div class="fill" id="raw-week"></div></div>
          <p class="label" id="raw-week-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Měsíc</div>
          <div class="line"><div class="fill" id="raw-month"></div></div>
          <p class="label" id="raw-month-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Školní rok</div>
          <div class="line"><div class="fill" id="raw-year"></div></div>
          <p class="label" id="raw-year-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Celkem</div>
          <div class="line"><div class="fill" id="raw-total"></div></div>
          <p class="label" id="raw-total-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Maturita</div>
          <p class="label" id="raw-maturita-label"></p>
        </div>
      </div>
    </div>

    <div id="dailyBlock" class="block">
      <div class="rowTitle">Denní progres</div>
      <div class="dailyRow">
        <div class="badge" id="dailyBadge">Rozvrh</div>
        <div class="dailyText" id="dailyText">—</div>
      </div>
      <div class="line" style="margin-top:10px;">
        <div class="fill" id="daybar"></div>
      </div>
      <p class="label" id="daylabel"></p>
      <p class="hint" id="dailyDebug"></p>
    </div>

    <div id="timetableBlock" class="block timetable">
      <div class="tt-top">
        <div>
          <div class="rowTitle">Rozvrh</div>
          <div class="tt-sub" id="ttSub">DE3A • Týdenní přehled</div>
        </div>
        <div class="tt-metaRow">
          <span class="tt-badge" id="ttSourceBadge">Zdroj: —</span>
          <span class="tt-badge" id="ttUpdated">Aktualizováno: —</span>
        </div>
      </div>

      <div class="tt-gridWrap">
        <div class="tt-grid" id="ttGrid" style="--cols: 7;"></div>
      </div>

      <p class="hint">Legenda: zelená = akce • theme barva = suplování • červená šrafovaná = odpadlo</p>
    </div>

    <div class="footer">© 2026 All rights reserved • Version 1.2.27</div>
  </div>

  <div class="tt-tooltip" id="ttTooltip" aria-hidden="true"></div>

<script>
  /* =========================
     CONFIG
     ========================= */
  // TODO: změň na svůj worker
  const API_BASE = "https://YOUR-WORKER.workers.dev";

  // Třída (backend endpoint /api/timetable?class=5A&type=Actual)
  const CLASS_ID = "5A";
  const CLASS_NAME = "DE3A";

  // Jan Cafourek teacher endpoint (z tvého linku)
  const CAFA_TEACHER_ID = "UV069";

  // Endpointy (worker)
  const CLASS_URL = `${API_BASE}/api/timetable?class=${encodeURIComponent(CLASS_ID)}&type=Actual`;
  const TEACHER_URL = `${API_BASE}/api/timetable?teacher=${encodeURIComponent(CAFA_TEACHER_ID)}&type=Actual`;

  /* =========================
     LOCAL FALLBACK TIMETABLE DATA (DE3A)
     ========================= */
  const TIMES = [
    {start:"07:55", end:"08:40"},
    {start:"08:50", end:"09:35"},
    {start:"09:50", end:"10:35"},
    {start:"10:45", end:"11:30"},
    {start:"11:35", end:"12:20"},
    {start:"12:50", end:"13:35"},
    {start:"13:40", end:"14:25"},
  ];

  // fallback DE3A
  const SCHEDULE = {
    Mon: [
      {subj:"MAT", room:"UČ10", teacher:"RYB"},
      {subj:"NEJ", room:"UČ11", teacher:"PRH"},
      {subj:"OBN", room:"UČ10", teacher:"ZYJ"},
      {subj:"EKO", room:"UČ11", teacher:"FRP"},
      {subj:"VYT", room:"UČ10", teacher:"KIN"},
      {subj:"NEJ", room:"UČ21", teacher:"PRH"},
      {subj:"MAT", room:"UČ9", teacher:"RYB"},
    ],
    Tue: [
      {subj:"KAJ", room:"UČ2", teacher:"BUI"},
      {subj:"PSK", room:"VT1", teacher:"KOO"},
      {subj:"ZPG", room:"UČ10", teacher:"KUO"},
      {subj:"ZPG", room:"UČ10", teacher:"KUO"},
      {subj:"ČJL", room:"UČ10", teacher:"BAP"},
      {subj:"ČJL", room:"UČ10", teacher:"BAP"},
      {subj:"ELT", room:"UČ10", teacher:"CAJ"},
    ],
    Wed: [
      {subj:"NEJ", room:"UČ10", teacher:"PRH"},
      {subj:"MAT", room:"UČ10", teacher:"RYB"},
      {subj:"VYA", room:"UČ10", teacher:"KOO"},
      {subj:"ELT", room:"UČ10", teacher:"CAJ"},
      {subj:"SWA", room:"UČ10", teacher:"CAJ"},
      {subj:"ANJ", room:"UČ14", teacher:"KLM"},
      {subj:"ANJ", room:"UČ14", teacher:"KLM"},
    ],
    Thu: [
      {subj:"VYT", room:"UČ10", teacher:"KIN"},
      {subj:"VYA", room:"UČ10", teacher:"KOO"},
      {subj:"ANJ", room:"UČ2", teacher:"KLM"},
      {subj:"VYA", room:"UČ13", teacher:"KOO"},
      null,
      {subj:"TVY", room:"TV3", teacher:"PRM"},
      {subj:"TVY", room:"TV3", teacher:"PRM"},
    ],
    Fri: [
      {subj:"SWA", room:"UČ10", teacher:"CAJ"},
      {subj:"SWA", room:"UČ10", teacher:"CAJ"},
      {subj:"ČJL", room:"UČ10", teacher:"BAP"},
      {subj:"PSK", room:"UČ10", teacher:"KOO"},
      {subj:"ČJL", room:"UČ20", teacher:"BAP"},
      null,
      null,
    ],
  };

  // fallback "události" / markery do fancy rozvrhu
  const FALLBACK_MARKS = [
    { day:"Wed", idx:0, type:"event", title:"Akce", room:"", note:"Školní akce / placeholder" },
    { day:"Wed", idx:1, type:"event", title:"Akce", room:"", note:"Školní akce / placeholder" },
    { day:"Wed", idx:2, type:"event", title:"Akce", room:"", note:"Školní akce / placeholder" }
  ];

  // fallback pro Cáfu z fotky (teacher UV069) – orientační, než backend teacher parser poběží dobře
  // indexy 0..13 = hodiny 1..14 na teacher rozvrhu
  const CAFA_FALLBACK_TEACHER_TIMES = [
    {start:"07:55", end:"08:40"},
    {start:"08:50", end:"09:35"},
    {start:"09:50", end:"10:35"},
    {start:"10:45", end:"11:30"},
    {start:"11:35", end:"12:20"},
    {start:"12:50", end:"13:35"},
    {start:"13:40", end:"14:25"},
    {start:"14:30", end:"15:15"},
    {start:"15:20", end:"16:05"},
    {start:"16:10", end:"16:55"},
    {start:"17:00", end:"17:45"},
    {start:"17:45", end:"18:30"},
    {start:"18:30", end:"19:15"},
    {start:"19:15", end:"20:00"},
  ];

  // Podle screenshotu teacher UV069 (orientační fallback; backend má mít prioritu)
  const CAFA_FALLBACK_SCHEDULE = {
    Mon: [
      {subj:"TEK", room:"uČ04", className:"DE1E"},
      {subj:"TEK", room:"uČ04", className:"DE1E"},
      {subj:"FYZ", room:"uČ04", className:"DE1E"},
      null,
      {subj:"FYZ", room:"uČ06", className:"DE1B"},
      null,null,null,null,null,null,null,null,null
    ],
    Tue: [
      {subj:"ZPG", room:"uČ13", className:"DE4C"},
      {subj:"ZPG", room:"uČ13", className:"DE4C"},
      {subj:"FYZ", room:"uČ9", className:"DE1A"},
      {subj:"SWA", room:"uČ13", className:"DE4C"},
      {subj:"SWA", room:"uČ13", className:"DE4C"},
      null,
      {subj:"ELT", room:"uČ10", className:"DE3A"},
      null,
      {subj:"ZPG", room:"VT3", className:"DS3IT"},
      {subj:"ZPG", room:"VT3", className:"DS3IT"},
      {subj:"PGR", room:"VT3", className:"DS3IT"},
      {subj:"PGR", room:"VT3", className:"DS3IT"},
      {subj:"SWA", room:"VT3", className:"DS3IT"},
      {subj:"SWA", room:"VT3", className:"DS3IT"},
    ],
    Wed: [
      {subj:"Akce", room:"", className:"", type:"event", note:"Školní akce / suplovaná pohotovost"},
      {subj:"Akce", room:"", className:"", type:"event", note:"Školní akce / suplovaná pohotovost"},
      {subj:"Akce", room:"", className:"", type:"event", note:"Školní akce / suplovaná pohotovost"},
      {subj:"ELT", room:"uČ10", className:"DE3A"},
      {subj:"SWA", room:"uČ10", className:"DE3A"},
      null,
      null,
      null,
      {subj:"PGR", room:"VT3", className:"DS3IT"},
      {subj:"PGR", room:"VT3", className:"DS3IT"},
      {subj:"ZPG", room:"VT3", className:"DS3IT"},
      {subj:"ZPG", room:"VT3", className:"DS3IT"},
      {subj:"ZPG", room:"VT1", className:"DS3IT"},
      {subj:"ZPG", room:"VT1", className:"DS3IT"},
    ],
    Thu: [
      null,null,null,null,null,
      {subj:"SWA", room:"uČ10", className:"DE2A"},
      {subj:"SWA", room:"uČ10", className:"DE2A"},
      null,null,null,null,null,null,null
    ],
    Fri: [
      {subj:"SWA", room:"uČ10", className:"DE3A"},
      {subj:"SWA", room:"uČ10", className:"DE3A"},
      {subj:"TEK", room:"uČ18", className:"DE4B"},
      {subj:"FYZ", room:"uČ9", className:"DE1A"},
      {subj:"SWA", room:"VT3", className:"DE4C"},
      {subj:"TEK", room:"uČ18", className:"DE4B"},
      null,null,null,null,null,null,null,null
    ]
  };

  /* =========================
     PROGRESS DATA
     ========================= */
  const HS_START = localDate(2023, 9, 4);
  const HS_END   = localDateEnd(2027, 6, 30);
  const MATURITA_APPROX = localDateEnd(2027, 5, 1);

  const BREAKS = [
    r("2023-10-26","2023-10-27"),
    r("2023-12-23","2024-01-02"),
    r("2024-02-02","2024-02-02"),
    r("2024-02-26","2024-03-03"),
    r("2024-07-01","2024-08-31"),
    r("2024-10-29","2024-10-30"),
    r("2024-12-23","2025-01-03"),
    r("2025-01-31","2025-01-31"),
    r("2025-03-03","2025-03-09"),
    r("2025-07-01","2025-08-31"),
    r("2025-10-27","2025-10-29"),
    r("2025-12-22","2026-01-02"),
    r("2026-01-30","2026-01-30"),
    r("2026-03-09","2026-03-15"),
    r("2026-07-01","2026-08-31"),
    r("2026-10-29","2026-10-30"),
    r("2026-12-23","2027-01-03"),
    r("2027-01-29","2027-01-29"),
    r("2027-02-01","2027-02-07"),
  ];
  const DIRECTOR_DAYS = [];

  /* =========================
     LIVE DATA STATE
     ========================= */
  let LIVE_SOURCE = "local";             // "backend" | "local"
  let LIVE_SOURCE_DETAIL = "fallback";
  let ACTIVE_TIMES = structuredClone(TIMES);
  let ACTIVE_SCHEDULE = structuredClone(SCHEDULE);
  let ACTIVE_MARKS = structuredClone(FALLBACK_MARKS);
  let ACTIVE_EVENTS = [];                // panel Události
  let ACTIVE_CLASS_META = { className: CLASS_NAME, updatedAt: null };
  let ACTIVE_TEACHER_FEED = null;        // parsed current/next for Cáfa if backend supports it
  let ACTIVE_TEACHER_RAW = null;         // teacher timetable raw normalized
  let LAST_BACKEND_ERROR = "";

  const CAFA_TEACHER_MATCH = ["cafourek", "jan cafourek", "caj", "caf"];

  /* =========================
     Helpers
     ========================= */
  const $ = (id) => document.getElementById(id);
  const clamp = (x, a=0, b=100) => Math.max(a, Math.min(b, x));
  const safeStr = (v) => (v == null ? "" : String(v)).trim();

  const setBar = (id, pct, weekend=false) => {
    const n = $(id); if (!n) return;
    n.style.width = clamp(pct).toFixed(2) + "%";
    weekend ? n.classList.add("weekend") : n.classList.remove("weekend");
  };
  const setText = (id, txt) => { const n=$(id); if(n) n.textContent = txt; };

  function localDate(y,m,d){ const dt=new Date(y,m-1,d); dt.setHours(0,0,0,0); return dt; }
  function localDateEnd(y,m,d){ const dt=new Date(y,m-1,d); dt.setHours(23,59,59,999); return dt; }
  function r(s,e){ return {s,e}; }

  function toISO(d){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const da=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }

  function two(n){ return String(n).padStart(2,"0"); }

  function formatDateCZ(d){
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}.${mm}.${yy}`;
  }

  function formatDateTimeCZ(d){
    return `${formatDateCZ(d)} ${two(d.getHours())}:${two(d.getMinutes())}`;
  }

  function timeToMin(hhmm){
    const s = safeStr(hhmm).replace(/\s/g,'');
    const m = s.match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return null;
    return Number(m[1])*60 + Number(m[2]);
  }

  function normalizeTimeStr(str){
    const s = safeStr(str);
    if (!s) return "";
    const m = s.match(/^(\d{1,2}):(\d{1,2})$/);
    if (!m) return s;
    return `${two(Number(m[1]))}:${two(Number(m[2]))}`;
  }

  function getTimesMin(){
    return (ACTIVE_TIMES || []).map(t => ({
      startMin: timeToMin(t.start),
      endMin: timeToMin(t.end)
    }));
  }

  function inBreak(iso){ return BREAKS.some(x => iso>=x.s && iso<=x.e); }
  function isSchoolDay(d){
    const dow = d.getDay();
    if (dow===0 || dow===6) return false;
    const iso = toISO(d);
    if (DIRECTOR_DAYS.includes(iso)) return false;
    if (inBreak(iso)) return false;
    return true;
  }
  function countSchoolDays(start, end){
    const s = new Date(start); s.setHours(0,0,0,0);
    const e = new Date(end);   e.setHours(23,59,59,999);
    let c=0;
    const cur = new Date(s);
    while (cur <= e){
      if (isSchoolDay(cur)) c++;
      cur.setDate(cur.getDate()+1);
    }
    return c;
  }
  function calendarPctBetween(start, end, now){
    const total = end - start; if (total<=0) return 0;
    const passed = Math.min(Math.max(now-start, 0), total);
    return (passed/total)*100;
  }
  function rawPctBetween(start, end, now){
    const total = countSchoolDays(start, end);
    const clipped = now < start ? start : (now > end ? end : now);
    const passed = countSchoolDays(start, clipped);
    return total ? (passed/total)*100 : 0;
  }
  function rawDaysUntil(target, now){
    const start = new Date(now); start.setHours(0,0,0,0);
    const end = new Date(target); end.setHours(23,59,59,999);
    if (end < start) return -countSchoolDays(end, start);
    return countSchoolDays(start, end);
  }
  function getSchoolYearRange(now){
    const y = (now.getMonth()>=8) ? now.getFullYear() : now.getFullYear()-1;
    return { start: localDate(y,9,1), end: localDateEnd(y+1,6,30) };
  }

  function dayNumToKey(n){
    return n===1?"Mon":n===2?"Tue":n===3?"Wed":n===4?"Thu":n===5?"Fri":null;
  }
  function dayKeyToCZ(k){
    return ({Mon:"Po", Tue:"Út", Wed:"St", Thu:"Čt", Fri:"Pá"})[k] || k || "";
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  /* =========================
     Theme switching
     ========================= */
  function applyTheme(theme){
    const body = document.body;
    body.classList.remove("theme-light","theme-dark","theme-loona","theme-sobokill");
    body.classList.add("theme-" + theme);
    localStorage.setItem("sp_theme", theme);
    const sel = $("themeSelect");
    if (sel) sel.value = theme;
  }

  function initSettings(){
    const btn = $("settingsBtn");
    const panel = $("settingsPanel");
    const toggleTT = $("toggleTimetable");
    const toggleDaily = $("toggleDaily");
    const timetableBlock = $("timetableBlock");
    const dailyBlock = $("dailyBlock");
    const themeSelect = $("themeSelect");

    btn.addEventListener("click", () => panel.classList.toggle("hidden"));
    toggleTT.addEventListener("change", () => timetableBlock.classList.toggle("hidden", !toggleTT.checked));
    toggleDaily.addEventListener("change", () => dailyBlock.classList.toggle("hidden", !toggleDaily.checked));
    themeSelect.addEventListener("change", () => applyTheme(themeSelect.value));

    const saved = localStorage.getItem("sp_theme") || "dark";
    applyTheme(saved);
  }

  /* =========================
     Backend normalization
     ========================= */

  // Normalize backend class timetable to our structure
  function normalizeBackendClassPayload(data){
    const result = {
      ok: false,
      times: structuredClone(TIMES),
      schedule: structuredClone(SCHEDULE),
      marks: [],
      events: [],
      classMeta: { className: CLASS_NAME, updatedAt: new Date().toISOString() }
    };

    if (!data || typeof data !== "object") return result;
    if (!data.ok) return result;

    // times
    if (Array.isArray(data.times) && data.times.length){
      const times = data.times.map(t => ({
        start: normalizeTimeStr(t?.start || ""),
        end: normalizeTimeStr(t?.end || "")
      })).filter(t => t.start && t.end);
      if (times.length) result.times = times;
    }

    // days
    const backendDays = data.days || data.timetable || {};
    const normalizedDays = { Mon:[], Tue:[], Wed:[], Thu:[], Fri:[] };
    for (const key of ["Mon","Tue","Wed","Thu","Fri"]){
      const arr = Array.isArray(backendDays[key]) ? backendDays[key] : [];
      normalizedDays[key] = arr.map(x => {
        if (!x) return null;
        return {
          subj: safeStr(x.subj || x.subject || x.code || x.abbr || x.name),
          room: safeStr(x.room || x.classroom || x.location),
          teacher: safeStr(x.teacher || x.teacherCode || x.teacherShort || x.teacherName),
          className: safeStr(x.className || x.class || CLASS_NAME),
          note: safeStr(x.note || x.description || x.text),
          type: safeStr(x.type || "")
        };
      });
      while (normalizedDays[key].length < result.times.length){
        normalizedDays[key].push(null);
      }
    }
    // pokud backend vrátil aspoň něco smysluplného
    const hasAnyLesson = Object.values(normalizedDays).some(arr =>
      arr.some(cell => cell && (cell.subj || cell.room || cell.teacher))
    );
    if (hasAnyLesson){
      result.schedule = normalizedDays;
    }

    // markery / události v buňkách
    // podporované inputy: data.marks[] nebo příznaky přímo v cells
    const marks = [];
    if (Array.isArray(data.marks)){
      for (const m of data.marks){
        const day = safeStr(m.day);
        const idx = Number(m.idx);
        if (!["Mon","Tue","Wed","Thu","Fri"].includes(day)) continue;
        if (!Number.isInteger(idx)) continue;
        marks.push({
          day,
          idx,
          type: safeStr(m.type || "").toLowerCase(), // event | subst | cancel
          title: safeStr(m.title || "Akce"),
          room: safeStr(m.room),
          note: safeStr(m.note || m.description || m.text)
        });
      }
    }

    // Heuristika: když buňka má type/event/subst/cancel, zvedneme mark
    for (const day of ["Mon","Tue","Wed","Thu","Fri"]){
      (result.schedule[day] || []).forEach((cell, idx) => {
        if (!cell) return;
        const t = safeStr(cell.type).toLowerCase();
        if (["event","subst","cancel"].includes(t)){
          marks.push({
            day, idx, type:t,
            title: safeStr(cell.subj || "Akce"),
            room: safeStr(cell.room || ""),
            note: safeStr(cell.note || "")
          });
        }
      });
    }
    result.marks = dedupeMarks(marks);

    // events panel
    result.events = normalizeBackendEvents(data.events || data.schoolEvents || []);

    // meta
    const className = safeStr(data.className || data.source?.classId || CLASS_NAME);
    const updatedAt = safeStr(data.generatedAt || data.updatedAt || new Date().toISOString());
    result.classMeta = { className, updatedAt };

    result.ok = true;
    return result;
  }

  function dedupeMarks(list){
    const map = new Map();
    for (const m of list || []){
      const key = `${m.day}|${m.idx}`;
      if (!map.has(key)) map.set(key, m);
    }
    return [...map.values()];
  }

  function normalizeBackendEvents(list){
    if (!Array.isArray(list)) return [];
    return list.map(ev => {
      const title = safeStr(ev.title || ev.name || ev.subject || ev.label || "Akce");
      const desc = safeStr(ev.desc || ev.description || ev.note || ev.text);
      const place = safeStr(ev.place || ev.room || ev.location);

      let dateLabel = safeStr(ev.dateLabel || ev.date || "");
      let timeLabel = safeStr(ev.timeLabel || ev.time || "");
      let ts = null;

      const rawDateTime = safeStr(ev.datetime || ev.dateTime || ev.start);
      if (rawDateTime){
        const d = new Date(rawDateTime);
        if (!Number.isNaN(d.getTime())){
          ts = d.getTime();
          if (!dateLabel) dateLabel = formatDateCZ(d);
          if (!timeLabel) timeLabel = `${two(d.getHours())}:${two(d.getMinutes())}`;
        }
      }
      return { title, desc, place, dateLabel, timeLabel, _ts: ts };
    }).filter(ev => ev.title || ev.desc || ev.place);
  }

  // Normalize teacher payload (Cáfa) from backend worker
  // Supports:
  // 1) explicit { current, next }
  // 2) timetable-like { times, days }
  function normalizeBackendTeacherPayload(data){
    if (!data || typeof data !== "object" || !data.ok) return null;

    // explicit tracker feed
    const explicit = data.teacherTracker || data.tracker || data.currentNext;
    if (explicit && typeof explicit === "object"){
      const out = {
        current: explicit.current ? normalizeTeacherCurrentNextItem(explicit.current) : null,
        next: explicit.next ? normalizeTeacherCurrentNextItem(explicit.next) : null,
        source: "explicit"
      };
      if (out.current || out.next) return out;
    }

    // timetable-like
    const times = Array.isArray(data.times) ? data.times.map(t => ({
      start: normalizeTimeStr(t?.start || ""),
      end: normalizeTimeStr(t?.end || "")
    })) : null;

    const daysObj = data.days && typeof data.days === "object" ? data.days : null;
    if (times && times.length && daysObj){
      const days = { Mon:[], Tue:[], Wed:[], Thu:[], Fri:[] };
      for (const key of ["Mon","Tue","Wed","Thu","Fri"]){
        const arr = Array.isArray(daysObj[key]) ? daysObj[key] : [];
        days[key] = arr.map(x => x ? ({
          subj: safeStr(x.subj || x.subject || x.code || x.abbr || x.name),
          room: safeStr(x.room || x.classroom || x.location),
          teacher: safeStr(x.teacher || x.teacherName || "Jan Cafourek"),
          className: safeStr(x.className || x.class || ""),
          note: safeStr(x.note || x.description || x.text),
          type: safeStr(x.type || "")
        }) : null);
      }
      return { times, days, source: "timetable" };
    }

    return null;
  }

  function normalizeTeacherCurrentNextItem(x){
    return {
      subj: safeStr(x.subj || x.subject || x.name),
      room: safeStr(x.room || x.classroom || x.location),
      teacher: safeStr(x.teacher || x.teacherName || "Jan Cafourek"),
      className: safeStr(x.className || x.class || ""),
      note: safeStr(x.note || x.description || x.text),
      start: normalizeTimeStr(x.start || ""),
      end: normalizeTimeStr(x.end || "")
    };
  }

  async function loadBackendClassTimetable(){
    try{
      const res = await fetch(CLASS_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const norm = normalizeBackendClassPayload(data);

      if (!norm.ok){
        throw new Error("Backend class payload not usable");
      }

      ACTIVE_TIMES = norm.times;
      ACTIVE_SCHEDULE = norm.schedule;
      ACTIVE_MARKS = norm.marks.length ? norm.marks : structuredClone(FALLBACK_MARKS);
      ACTIVE_EVENTS = norm.events;
      ACTIVE_CLASS_META = norm.classMeta;
      LIVE_SOURCE = "backend";
      LIVE_SOURCE_DETAIL = "class";
      LAST_BACKEND_ERROR = "";

      return true;
    }catch(err){
      LAST_BACKEND_ERROR = err?.message || String(err);
      ACTIVE_TIMES = structuredClone(TIMES);
      ACTIVE_SCHEDULE = structuredClone(SCHEDULE);
      ACTIVE_MARKS = structuredClone(FALLBACK_MARKS);
      ACTIVE_EVENTS = [];
      ACTIVE_CLASS_META = { className: CLASS_NAME, updatedAt: new Date().toISOString() };
      LIVE_SOURCE = "local";
      LIVE_SOURCE_DETAIL = "fallback";
      return false;
    }
  }

  async function loadBackendCafaTeacher(){
    try{
      const res = await fetch(TEACHER_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const norm = normalizeBackendTeacherPayload(data);

      if (!norm){
        ACTIVE_TEACHER_FEED = null;
        ACTIVE_TEACHER_RAW = null;
        return false;
      }

      if (norm.source === "explicit"){
        ACTIVE_TEACHER_FEED = norm;
        ACTIVE_TEACHER_RAW = null;
      } else {
        ACTIVE_TEACHER_FEED = null;
        ACTIVE_TEACHER_RAW = norm;
      }
      return true;
    }catch(err){
      ACTIVE_TEACHER_FEED = null;
      ACTIVE_TEACHER_RAW = null;
      return false;
    }
  }

  /* =========================
     Fancy timetable rendering
     ========================= */
  function getMark(day, idx){
    return (ACTIVE_MARKS || []).find(m => m.day===day && Number(m.idx)===Number(idx)) || null;
  }

  function fmtClassLesson(x){
    if (!x) return null;
    return x.room ? `${x.subj} (${x.room})` : x.subj;
  }

  function getCurrentClassSlot(now){
    const dayKey = dayNumToKey(now.getDay());
    if (!dayKey) return null;
    const timesMin = getTimesMin();
    const nowMin = now.getHours()*60 + now.getMinutes();

    for (let i=0;i<timesMin.length;i++){
      const t = timesMin[i];
      if (t.startMin == null || t.endMin == null) continue;
      if (nowMin >= t.startMin && nowMin <= t.endMin){
        return { dayKey, idx:i };
      }
    }
    return null;
  }

  const tooltip = $("ttTooltip");
  function showTooltip(html, x, y){
    tooltip.innerHTML = html;
    tooltip.style.left = x + "px";
    tooltip.style.top = y + "px";
    tooltip.style.display = "block";
    tooltip.setAttribute("aria-hidden", "false");
  }
  function moveTooltip(x, y){
    tooltip.style.left = x + "px";
    tooltip.style.top = y + "px";
  }
  function hideTooltip(){
    tooltip.style.display = "none";
    tooltip.setAttribute("aria-hidden", "true");
  }

  function tooltipHTML(data){
    return `
      <div class="t-title">${escapeHtml(data.dayLabel)} • ${escapeHtml(data.dateLong)} • Hodina ${data.hourIdx+1}/${data.totalHours} (${escapeHtml(data.time)})</div>
      <div class="t-row"><div class="k">Třída</div><div class="v">${escapeHtml(data.className || "-")}</div></div>
      <div class="t-row"><div class="k">Předmět</div><div class="v">${escapeHtml(data.subj || "-")}</div></div>
      <div class="t-row"><div class="k">Učebna</div><div class="v">${escapeHtml(data.room || "-")}</div></div>
      <div class="t-row"><div class="k">Učitel</div><div class="v">${escapeHtml(data.teacher || "-")}</div></div>
      ${data.type ? `<div class="t-row"><div class="k">Typ</div><div class="v">${escapeHtml(data.type)}</div></div>` : ``}
      ${data.note ? `<div class="t-row"><div class="k">Popis</div><div class="v">${escapeHtml(data.note)}</div></div>` : ``}
    `;
  }

  function renderFancyTimetable(){
    const grid = $("ttGrid");
    if (!grid) return;

    const times = ACTIVE_TIMES || TIMES;
    const schedule = ACTIVE_SCHEDULE || SCHEDULE;
    const cols = times.length;

    grid.style.setProperty("--cols", cols);
    grid.innerHTML = "";

    const corner = document.createElement("div");
    corner.className = "tt-corner";
    grid.appendChild(corner);

    times.forEach((t, i) => {
      const h = document.createElement("div");
      h.className = "tt-h";
      h.innerHTML = `${i+1}<br><span>${escapeHtml(t.start)}–${escapeHtml(t.end)}</span>`;
      grid.appendChild(h);
    });

    const dayOrder = [
      {key:"Mon", label:"Po"},
      {key:"Tue", label:"Út"},
      {key:"Wed", label:"St"},
      {key:"Thu", label:"Čt"},
      {key:"Fri", label:"Pá"},
    ];

    const currentSlot = getCurrentClassSlot(new Date());

    for (const d of dayOrder){
      const dayCell = document.createElement("div");
      dayCell.className = "tt-day";
      dayCell.textContent = d.label;
      grid.appendChild(dayCell);

      for (let i=0;i<cols;i++){
        const base = (schedule[d.key] && schedule[d.key][i]) ? schedule[d.key][i] : null;
        const mark = getMark(d.key, i);

        const cell = document.createElement("div");
        cell.className = "tt-cell";

        if (currentSlot && currentSlot.dayKey === d.key && currentSlot.idx === i){
          cell.classList.add("current");
        }

        if (!base && !mark){
          cell.classList.add("tt-empty");
          cell.textContent = "—";
          grid.appendChild(cell);
          continue;
        }

        let typeLabel = "";
        if (mark?.type === "event"){ cell.classList.add("tt-event"); typeLabel = "Akce"; }
        if (mark?.type === "subst"){ cell.classList.add("tt-subst"); typeLabel = "Suplování"; }
        if (mark?.type === "cancel"){ cell.classList.add("tt-cancel"); typeLabel = "Odpadlo"; }

        const subj = (mark?.type === "event")
          ? (mark.title || "Akce")
          : (base?.subj || "");

        const room = (mark?.type === "event")
          ? (mark.room || "")
          : (base?.room || "");

        const teacher = (mark?.type === "event")
          ? ""
          : (base?.teacher || "");

        const className = safeStr(base?.className || ACTIVE_CLASS_META?.className || CLASS_NAME || "DE3A");
        const note = safeStr(mark?.note || base?.note || "");

        const topline = document.createElement("div");
        topline.className = "tt-topline";
        topline.innerHTML = `<span class="cls">${escapeHtml(className)}</span><span class="room">${escapeHtml(room)}</span>`;
        cell.appendChild(topline);

        const subjEl = document.createElement("div");
        subjEl.className = "tt-subj";
        subjEl.textContent = subj || "—";
        cell.appendChild(subjEl);

        const teacherEl = document.createElement("div");
        teacherEl.className = "tt-teacher";
        teacherEl.textContent = teacher || "";
        cell.appendChild(teacherEl);

        const now = new Date();
        const tdata = {
          dayLabel: d.label,
          dateLong: formatDateCZ(now),
          hourIdx: i,
          totalHours: cols,
          time: `${times[i]?.start || "?"}–${times[i]?.end || "?"}`,
          className,
          subj,
          room,
          teacher,
          note,
          type: typeLabel
        };

        cell.addEventListener("mouseenter", (e) => showTooltip(tooltipHTML(tdata), e.clientX, e.clientY));
        cell.addEventListener("mousemove", (e) => moveTooltip(e.clientX, e.clientY));
        cell.addEventListener("mouseleave", () => hideTooltip());
        cell.addEventListener("click", (e) => {
          const visible = tooltip.style.display === "block";
          if (visible) hideTooltip();
          else showTooltip(tooltipHTML(tdata), e.clientX || (window.innerWidth/2), e.clientY || (window.innerHeight/2));
          e.stopPropagation();
        });

        grid.appendChild(cell);
      }
    }

    $("ttSub").textContent = `${ACTIVE_CLASS_META?.className || CLASS_NAME} • Týdenní přehled`;
    $("ttUpdated").textContent = "Aktualizováno: " + formatDateTimeCZ(new Date());
    $("ttSourceBadge").textContent = `Zdroj: ${LIVE_SOURCE === "backend" ? "Bakaláři (backend)" : "Lokální fallback"}`;
  }

  /* =========================
     Events panel
     ========================= */
  function renderEventsPanel(){
    const root = $("eventsList");
    if (!root) return;
    root.innerHTML = "";

    const events = Array.isArray(ACTIVE_EVENTS) ? ACTIVE_EVENTS : [];

    if (!events.length){
      const div = document.createElement("div");
      div.className = "stackItem muted";
      div.textContent = (LIVE_SOURCE === "backend")
        ? "Žádné události v datech."
        : "Události nejsou dostupné (local fallback).";
      root.appendChild(div);
      return;
    }

    const sorted = [...events].sort((a,b) => {
      const ta = a._ts || Number.MAX_SAFE_INTEGER;
      const tb = b._ts || Number.MAX_SAFE_INTEGER;
      return ta - tb;
    }).slice(0, 8);

    for (const ev of sorted){
      const item = document.createElement("div");
      item.className = "stackItem eventItem";

      const title = document.createElement("div");
      title.className = "eventTitle";
      title.textContent = ev.title || "Akce";
      item.appendChild(title);

      const meta = document.createElement("div");
      meta.className = "eventMeta";
      const parts = [];
      if (ev.dateLabel) parts.push(ev.dateLabel);
      if (ev.timeLabel) parts.push(ev.timeLabel);
      if (ev.place) parts.push(ev.place);
      meta.textContent = parts.join(" • ") || "Bez detailů";
      item.appendChild(meta);

      if (ev.desc){
        const desc = document.createElement("div");
        desc.className = "eventDesc";
        desc.textContent = ev.desc;
        item.appendChild(desc);
      }

      root.appendChild(item);
    }
  }

  /* =========================
     Cáfa Tracker
     ========================= */
  function setCafaState(kind, main, sub){
    const badge = $("cafaBadge");
    const mainEl = $("cafaMain");
    const subEl = $("cafaSub");
    if (!badge || !mainEl || !subEl) return;

    badge.className = "trackerBadge";
    if (kind) badge.classList.add(kind);

    if (kind === "live") badge.textContent = "Cáfa • Live";
    else if (kind === "shadow") badge.textContent = "Cáfa • Stíny";
    else if (kind === "err") badge.textContent = "Cáfa • ?";
    else badge.textContent = "Cáfa";

    mainEl.textContent = main || "—";
    subEl.textContent = sub || "—";
  }

  // Teacher tracker from backend explicit current/next
  function findCafaFromExplicitFeed(now){
    if (!ACTIVE_TEACHER_FEED || ACTIVE_TEACHER_FEED.source !== "explicit") return null;

    const cur = ACTIVE_TEACHER_FEED.current;
    const next = ACTIVE_TEACHER_FEED.next;

    if (cur){
      return { state:"live", lesson:cur, time:{start:cur.start, end:cur.end}, className:cur.className };
    }
    if (next){
      return { state:"upcoming", lesson:next, time:{start:next.start, end:next.end}, className:next.className };
    }
    return { state:"shadow", reason:"no-current-next" };
  }

  // Teacher tracker from backend teacher timetable (normalized)
  function findCafaFromTeacherTimetable(now){
    if (!ACTIVE_TEACHER_RAW || ACTIVE_TEACHER_RAW.source !== "timetable") return null;

    const dayKey = dayNumToKey(now.getDay());
    if (!dayKey) return { state:"shadow", reason:"weekend" };

    const times = ACTIVE_TEACHER_RAW.times || [];
    const days = ACTIVE_TEACHER_RAW.days || {};
    const lessons = Array.isArray(days[dayKey]) ? days[dayKey] : [];
    const nowMin = now.getHours()*60 + now.getMinutes();

    for (let i=0;i<times.length;i++){
      const l = lessons[i] || null;
      if (!l) continue;

      const startMin = timeToMin(times[i]?.start || "");
      const endMin = timeToMin(times[i]?.end || "");
      if (startMin == null || endMin == null) continue;

      if (nowMin >= startMin && nowMin <= endMin){
        return { state:"live", dayKey, idx:i, lesson:l, time:times[i], className:l.className || "" };
      }
      if (nowMin < startMin){
        return { state:"upcoming", dayKey, idx:i, lesson:l, time:times[i], className:l.className || "" };
      }
    }
    return { state:"shadow", reason:"no-lesson-now" };
  }

  // fallback from screenshot-based manual schedule
  function findCafaFromFallback(now){
    const dayKey = dayNumToKey(now.getDay());
    if (!dayKey) return { state:"shadow", reason:"weekend" };

    const lessons = CAFA_FALLBACK_SCHEDULE[dayKey] || [];
    const times = CAFA_FALLBACK_TEACHER_TIMES;
    const nowMin = now.getHours()*60 + now.getMinutes();

    for (let i=0;i<times.length;i++){
      const l = lessons[i] || null;
      if (!l) continue;
      const startMin = timeToMin(times[i].start);
      const endMin = timeToMin(times[i].end);

      if (nowMin >= startMin && nowMin <= endMin){
        return { state:"live", dayKey, idx:i, lesson:l, time:times[i], className:l.className || "" };
      }
      if (nowMin < startMin){
        return { state:"upcoming", dayKey, idx:i, lesson:l, time:times[i], className:l.className || "" };
      }
    }

    return { state:"shadow", reason:"no-lesson-now" };
  }

  // fallback from current class schedule if teacher code is present in class row
  function findCafaInClassSchedule(now){
    const dayKey = dayNumToKey(now.getDay());
    if (!dayKey) return { state:"shadow", reason:"weekend" };

    const timesMin = getTimesMin();
    const lessons = (ACTIVE_SCHEDULE[dayKey] || []).slice(0, timesMin.length);
    const nowMin = now.getHours()*60 + now.getMinutes();

    for (let i=0; i<lessons.length; i++){
      const l = lessons[i];
      if (!l) continue;

      const teacher = safeStr(l.teacher).toLowerCase();
      const hasCafa = CAFA_TEACHER_MATCH.some(m => teacher.includes(m));
      if (!hasCafa) continue;

      const t = ACTIVE_TIMES[i];
      const tm = timesMin[i];
      if (!tm || tm.startMin == null || tm.endMin == null) continue;

      if (nowMin >= tm.startMin && nowMin <= tm.endMin){
        return { state:"live", dayKey, idx:i, lesson:l, time:t, className:l.className || ACTIVE_CLASS_META.className || CLASS_NAME };
      }
      if (nowMin < tm.startMin){
        return { state:"upcoming", dayKey, idx:i, lesson:l, time:t, className:l.className || ACTIVE_CLASS_META.className || CLASS_NAME };
      }
    }

    return { state:"shadow", reason:"not-in-class-now" };
  }

  function updateCafaTracker(now){
    let found = null;

    // 1) backend explicit current/next (best)
    found = findCafaFromExplicitFeed(now);

    // 2) backend teacher timetable (very good)
    if (!found) found = findCafaFromTeacherTimetable(now);

    // 3) screenshot/manual fallback for UV069 (good fallback)
    if (!found) found = findCafaFromFallback(now);

    // 4) class schedule fallback (weak)
    if (!found) found = findCafaInClassSchedule(now);

    if (!found){
      setCafaState("err", "Cáfa tracker selhal", "Nedokážu vyhodnotit polohu.");
      return;
    }

    if (found.state === "live"){
      const subj = found.lesson?.subj || "Výuka";
      const room = found.lesson?.room || "—";
      const cls = found.className ? ` • ${found.className}` : "";
      const start = found.time?.start || "??:??";
      const end = found.time?.end || "??:??";

      setCafaState(
        "live",
        `Právě učí: ${subj} (${room})`,
        `${start}–${end}${cls}`
      );
      return;
    }

    if (found.state === "upcoming"){
      const subj = found.lesson?.subj || "Výuka";
      const room = found.lesson?.room || "—";
      const start = found.time?.start || "??:??";
      const cls = found.className ? ` • ${found.className}` : "";
      const dayLabel = dayKeyToCZ(found.dayKey) || "Dnes";

      setCafaState(
        "shadow",
        "Cáfa se skrývá ve stínech…",
        `${dayLabel} • další stopa: ${subj} (${room}) v ${start}${cls}`
      );
      return;
    }

    if (found.reason === "weekend"){
      setCafaState(
        "shadow",
        "Cáfa se skrývá ve stínech 😎",
        `Víkend • ${formatDateCZ(now)}`
      );
      return;
    }

    setCafaState(
      "shadow",
      "Cáfa se skrývá ve stínech…",
      `Mimo aktuální výuku • ${formatDateCZ(now)}`
    );
  }

  /* =========================
     Daily progress (local/active timetable)
     ========================= */
  function countTodayLessons(arr){
    let last = -1;
    for (let i=0;i<arr.length;i++){
      if (arr[i] && (arr[i].subj || arr[i].room || arr[i].teacher)) last = i;
    }
    return Math.max(last+1, 0);
  }
  function setDailyBadge(kind, text){
    const b=$("dailyBadge");
    b.className = "badge" + (kind ? (" "+kind) : "");
    b.textContent = text;
  }

  function updateDaily(now){
    const dow = now.getDay();
    const dayKey = dayNumToKey(dow);

    if (!dayKey){
      setDailyBadge("free","Volno");
      setText("dailyText","Volno 😎");
      setBar("daybar",100);
      setText("daylabel","");
      setText("dailyDebug", `Weekend • ${formatDateCZ(now)}`);
      return;
    }

    const timesMin = getTimesMin();
    const lessons = (ACTIVE_SCHEDULE[dayKey] || []).slice(0, timesMin.length);
    const totalToday = countTodayLessons(lessons) || timesMin.length;

    const nowMin = now.getHours()*60 + now.getMinutes();
    const first = timesMin[0];
    const last = timesMin[totalToday-1] || timesMin[timesMin.length-1];

    if (!first || !last || first.startMin == null || last.endMin == null){
      setDailyBadge("err","Chyba");
      setText("dailyText","Časy hodin nejsou dostupné.");
      setBar("daybar",0);
      setText("daylabel","");
      setText("dailyDebug", `${dayKey} • ${formatDateCZ(now)}`);
      return;
    }

    if (nowMin > last.endMin){
      setDailyBadge("free","Volno");
      setText("dailyText","Volno 😎");
      setBar("daybar",100);
      setText("daylabel","");
      setText("dailyDebug", `${dayKey} • ${formatDateCZ(now)}`);
      return;
    }

    if (nowMin < first.startMin){
      setDailyBadge("live","Dnes");
      const next = fmtClassLesson(lessons[0]) || `Hodina 1/${totalToday}`;
      setText("dailyText",`Za chvíli začne: ${next}`);
      setBar("daybar",0);
      setText("daylabel",`Hodina 1/${totalToday} • start v ${(ACTIVE_TIMES[0]||{}).start || "??:??"}`);
      setText("dailyDebug", `${dayKey} • ${formatDateCZ(now)}`);
      return;
    }

    for (let i=0;i<totalToday;i++){
      const t = timesMin[i];
      if (!t || t.startMin == null || t.endMin == null) continue;

      const cur = fmtClassLesson(lessons[i]) || `Hodina ${i+1}/${totalToday}`;
      const next = (i+1<totalToday) ? (fmtClassLesson(lessons[i+1]) || `Hodina ${i+2}/${totalToday}`) : null;

      if (nowMin >= t.startMin && nowMin <= t.endMin){
        const pct = ((nowMin - t.startMin) / Math.max(1,(t.endMin - t.startMin))) * 100;
        setDailyBadge("live","Právě");
        setText("dailyText", next ? `Právě: ${cur} • Další: ${next}` : `Právě: ${cur}`);
        setBar("daybar", pct);
        setText("daylabel", `Hodina ${i+1}/${totalToday} • ${(ACTIVE_TIMES[i]||{}).start || "?"}–${(ACTIVE_TIMES[i]||{}).end || "?"} • ${pct.toFixed(0)}%`);
        setText("dailyDebug", `${dayKey} • ${formatDateCZ(now)}`);
        return;
      }

      const nt = timesMin[i+1];
      if (nt && nt.startMin != null && nowMin > t.endMin && nowMin < nt.startMin){
        setDailyBadge("live","Pauza");
        setText("dailyText", `Následuje: ${next}`);
        setBar("daybar", 0);
        setText("daylabel", `Další hodina ${i+2}/${totalToday} v ${(ACTIVE_TIMES[i+1]||{}).start || "??:??"}`);
        setText("dailyDebug", `${dayKey} • ${formatDateCZ(now)}`);
        return;
      }
    }

    setDailyBadge("free","Volno");
    setText("dailyText","Volno 😎");
    setBar("daybar",100);
    setText("daylabel","");
    setText("dailyDebug", `${dayKey} • ${formatDateCZ(now)}`);
  }

  /* =========================
     Status/UI helpers
     ========================= */
  function updateStatusHint(){
    const status = $("statusHint");
    if (!status) return;

    if (LIVE_SOURCE === "backend"){
      status.textContent = "Status: OK • Bakaláři backend připojen";
      return;
    }

    status.textContent = `Status: Fallback • Lokální data (${LAST_BACKEND_ERROR || "backend nedostupný"})`;
  }

  /* =========================
     Main update
     ========================= */
  function updateAll(){
    const now = new Date();
    const timeInDay = now.getHours()/24 + now.getMinutes()/1440;

    const dow = now.getDay();
    const weekend = (dow===0 || dow===6);
    const workIndex = (dow===1)?0:(dow===2)?1:(dow===3)?2:(dow===4)?3:(dow===5)?4:4;
    const weekPct = weekend ? 100 : ((workIndex + timeInDay)/5)*100;

    setBar("rt-week", weekPct, weekend);
    setText("rt-week-label", weekend ? "Weekend 😎" : `Týden: ${weekPct.toFixed(1)}%`);
    setBar("raw-week", weekPct, false);
    setText("raw-week-label", `Týden: ${weekPct.toFixed(1)}%`);

    const dim = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
    const monthPct = ((now.getDate()-1 + timeInDay)/dim)*100;
    setBar("rt-month", monthPct);
    setText("rt-month-label", `Měsíc: ${monthPct.toFixed(1)}%`);

    const mStart = localDate(now.getFullYear(), now.getMonth()+1, 1);
    const mEnd   = localDateEnd(now.getFullYear(), now.getMonth()+1, dim);
    const monthRaw = rawPctBetween(mStart, mEnd, now);
    setBar("raw-month", monthRaw);
    setText("raw-month-label", `Měsíc: ${monthRaw.toFixed(1)}%`);

    const yr = getSchoolYearRange(now);
    const yearPct = calendarPctBetween(yr.start, yr.end, now);
    setBar("rt-year", yearPct);
    setText("rt-year-label", `Školní rok: ${yearPct.toFixed(1)}%`);
    const yearRaw = rawPctBetween(yr.start, yr.end, now);
    setBar("raw-year", yearRaw);
    setText("raw-year-label", `Školní rok: ${yearRaw.toFixed(1)}%`);

    const totalPct = calendarPctBetween(HS_START, HS_END, now);
    setBar("rt-total", totalPct);
    setText("rt-total-label", `Celkem: ${totalPct.toFixed(1)}%`);
    const totalRaw = rawPctBetween(HS_START, HS_END, now);
    setBar("raw-total", totalRaw);
    setText("raw-total-label", `Celkem: ${totalRaw.toFixed(1)}%`);

    const daysUntil = Math.ceil((MATURITA_APPROX - now) / (1000*60*60*24));
    setText("rt-maturita-label", (daysUntil>=0)
      ? `Real-Time: ~${daysUntil} dní`
      : `Real-Time: hotovo (${Math.abs(daysUntil)} dní zpět)`
    );

    const rawDays = rawDaysUntil(MATURITA_APPROX, now);
    setText("raw-maturita-label", (rawDays>=0)
      ? `Raw-Time: ~${rawDays} školních dní`
      : `Raw-Time: hotovo (${Math.abs(rawDays)} školních dní zpět)`
    );

    const toggleDaily = $("toggleDaily");
    if (!toggleDaily || toggleDaily.checked){
      updateDaily(now);
    }

    updateCafaTracker(now);
    renderFancyTimetable(); // přebarví current slot
  }

  /* =========================
     Data load orchestration
     ========================= */
  async function refreshLiveData(){
    await loadBackendClassTimetable();
    await loadBackendCafaTeacher();

    updateStatusHint();
    renderEventsPanel();
    renderFancyTimetable();
    updateCafaTracker(new Date());
  }

  function boot(){
    initSettings();

    // close tooltip on outside click
    document.addEventListener("click", () => hideTooltip());

    // první render fallback okamžitě
    updateStatusHint();
    renderEventsPanel();
    renderFancyTimetable();
    updateAll();

    // pak načti backend
    refreshLiveData();

    // timers
    setInterval(updateAll, 30_000);      // progress + current slot + cafa state
    setInterval(refreshLiveData, 180_000); // refresh backend každé 3 min
  }

  document.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>
