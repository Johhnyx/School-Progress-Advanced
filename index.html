<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>School Progress – Fancy Timetable</title>

  <style>
    /* =========================
       THEMES
       ========================= */
    body{
      --bg:#f4f4f4;
      --card:#ffffff;
      --text:#222;
      --muted:#666;
      --shadow: rgba(0,0,0,0.06);
      --linebg:#e0e0e0;

      --btn:#111;
      --btnText:#fff;

      --badge:#eee;
      --border:#eee;

      --bgImage:none;
      --bgOverlay: linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.0));

      /* state colors */
      --substBg: rgba(255, 80, 80, 0.18);
      --substBorder: rgba(255, 80, 80, 0.40);

      --cancelBg: rgba(255, 0, 60, 0.22);
      --cancelBorder: rgba(255, 0, 60, 0.55);

      --eventBg: rgba(59,181,74,0.22);
      --eventBorder: rgba(59,181,74,0.55);

      /* unified timetable subject color */
      --ttSubjColor: rgba(20, 35, 60, 0.92);
      --ttSubjGlow: none;
    }

    body.theme-dark{
      --bg:#0f1115;
      --card:#171a21;
      --text:#e7e9ee;
      --muted:#a6acb8;
      --shadow: rgba(0,0,0,0.35);
      --linebg:#2a2f3a;

      --btn:#e7e9ee;
      --btnText:#111;

      --badge:#232836;
      --border:#2a2f3a;

      --substBg: rgba(255, 80, 80, 0.20);
      --substBorder: rgba(255, 80, 80, 0.48);

      --cancelBg: rgba(255, 0, 60, 0.26);
      --cancelBorder: rgba(255, 0, 60, 0.60);

      --eventBg: rgba(59,181,74,0.18);
      --eventBorder: rgba(59,181,74,0.50);

      --ttSubjColor: rgba(235, 240, 250, 0.95);
      --ttSubjGlow: none;
    }

    body.theme-loona{
      --bg:#08060b;
      --card: rgba(18, 12, 22, 0.78);
      --text:#ffe9f6;
      --muted:#d7a6c4;
      --shadow: rgba(0,0,0,0.55);
      --linebg: rgba(255, 70, 190, 0.18);

      --btn:#ff2ea6;
      --btnText:#120812;

      --badge: rgba(255, 46, 166, 0.18);
      --border: rgba(255, 70, 190, 0.20);

      --bgImage: url("loona.png");
      --bgOverlay: linear-gradient(180deg, rgba(8,6,11,0.78), rgba(8,6,11,0.92));

      --substBg: rgba(255, 46, 166, 0.22);
      --substBorder: rgba(255, 46, 166, 0.52);

      --cancelBg: rgba(255, 0, 90, 0.28);
      --cancelBorder: rgba(255, 0, 90, 0.62);

      --eventBg: rgba(59,181,74,0.20);
      --eventBorder: rgba(59,181,74,0.55);

      --ttSubjColor: rgba(255, 107, 216, 0.98);
      --ttSubjGlow: 0 0 14px rgba(255, 46, 166, 0.35);
    }

    body.theme-sobokill{
      --bg:#070604;
      --card: rgba(18, 14, 8, 0.82);
      --text:#fff3dc;
      --muted:#d2b98b;
      --shadow: rgba(0,0,0,0.60);
      --linebg: rgba(212, 175, 55, 0.18);

      --btn:#d4af37;
      --btnText:#1a1206;

      --badge: rgba(212,175,55,0.16);
      --border: rgba(212,175,55,0.22);

      --bgImage: url("sobokill.png");
      --bgOverlay: linear-gradient(180deg, rgba(7,6,4,0.76), rgba(7,6,4,0.92));

      --substBg: rgba(212, 175, 55, 0.22);
      --substBorder: rgba(212, 175, 55, 0.50);

      --cancelBg: rgba(255, 0, 60, 0.24);
      --cancelBorder: rgba(255, 0, 60, 0.58);

      --eventBg: rgba(59,181,74,0.20);
      --eventBorder: rgba(59,181,74,0.55);

      --ttSubjColor: rgba(241, 208, 122, 0.98);
      --ttSubjGlow: 0 0 14px rgba(212, 175, 55, 0.30);
    }

    /* =========================
       BASE
       ========================= */
    *{ box-sizing:border-box; }
    body{
      font-family: Arial, sans-serif;
      margin:0;
      padding:24px;
      color:var(--text);
      background:
        var(--bgOverlay),
        var(--bgImage),
        radial-gradient(1200px 700px at 15% 15%, rgba(255,46,166,0.10), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(255,95,209,0.08), transparent 60%),
        radial-gradient(1000px 650px at 30% 90%, rgba(212,175,55,0.10), transparent 60%),
        var(--bg);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      transition: background .2s ease, color .2s ease;
    }

    .wrap{ max-width:1080px; margin:0 auto; }
    h1{
      margin:0 0 14px 0;
      text-align:center;
      font-weight:900;
      letter-spacing:0.2px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      margin-bottom:12px;
      gap:10px;
    }
    .btn{
      border:none;
      padding:10px 12px;
      border-radius:10px;
      background:var(--btn);
      color:var(--btnText);
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }

    .block{
      background:var(--card);
      padding:16px 16px 12px;
      border-radius:12px;
      margin:12px 0;
      border: 1px solid var(--border);
      box-shadow:0 2px 10px var(--shadow);
      backdrop-filter: blur(10px);
    }

    .rowTitle{
      margin:0 0 10px 0;
      font-size:18px;
      font-weight:900;
    }

    .hidden{ display:none; }
    .field{
      display:flex;
      align-items:center;
      gap:10px;
      margin:10px 0 6px;
      font-weight:900;
    }
    select{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background: transparent;
      color: var(--text);
      font-weight:900;
      outline:none;
    }
    .hint{
      margin:10px 0 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      font-weight: 900;
    }

    /* =========================
       TIMETABLE (fancy layout)
       ========================= */
    .timetable .tt-top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
      flex-wrap: wrap;
    }
    .tt-sub{
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      margin-top: 2px;
    }
    .tt-badge{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
    }

    .tt-grid{
      display:grid;
      grid-template-columns: 48px repeat(var(--cols), minmax(120px, 1fr));
      gap:10px;
    }
    @media (max-width: 900px){
      .tt-grid{
        overflow:auto;
        grid-template-columns: 48px repeat(var(--cols), 150px);
        padding-bottom: 6px;
      }
    }

    .tt-corner{ height:44px; }

    .tt-h{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background: rgba(255,255,255,0.04);
      text-align:center;
      font-weight: 900;
    }
    .tt-h span{
      display:block;
      font-size: 11px;
      font-weight: 900;
      color: var(--muted);
      margin-top: 4px;
    }

    .tt-day{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 0;
      text-align:center;
      font-weight: 900;
      color: var(--muted);
      background: rgba(255,255,255,0.03);
    }

    .tt-cell{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background: rgba(255,255,255,0.04);
      box-shadow: 0 2px 10px var(--shadow);
      position: relative;
      overflow: hidden;
      min-height: 78px;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .tt-cell:hover{
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
    }

    .tt-topline{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      font-weight: 1000;
      font-size: 11px;
      color: var(--muted);
      opacity: 0.95;
    }
    .tt-topline .cls{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .tt-topline .room{ white-space:nowrap; opacity: 0.95; }

    .tt-subj{
      font-weight: 1000;
      letter-spacing: .2px;
      margin-top: 6px;
      font-size: 22px;
      color: var(--ttSubjColor) !important;
      text-shadow: var(--ttSubjGlow);
    }

    .tt-teacher{
      font-weight: 900;
      color: var(--muted);
      font-size: 11px;
      margin-top: 8px;
      opacity: 0.95;
    }

    .tt-empty{
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--muted);
      font-weight: 900;
      background: rgba(255,255,255,0.02);
      box-shadow: none;
    }

    .tt-event{
      border-color: var(--eventBorder);
      background: var(--eventBg);
      box-shadow: 0 0 0 1px var(--eventBorder) inset, 0 0 18px rgba(59,181,74,0.25);
    }
    .tt-subst{
      border-color: var(--substBorder);
      background: var(--substBg);
      box-shadow: 0 0 0 1px var(--substBorder) inset, 0 0 22px rgba(255,80,80,0.30);
    }
    body.theme-loona .tt-subst{ box-shadow: 0 0 0 1px var(--substBorder) inset, 0 0 24px rgba(255,46,166,0.30); }
    body.theme-sobokill .tt-subst{ box-shadow: 0 0 0 1px var(--substBorder) inset, 0 0 24px rgba(212,175,55,0.28); }

    .tt-cancel{
      border-color: var(--cancelBorder);
      background:
        repeating-linear-gradient(
          135deg,
          rgba(255,255,255,0.14) 0px,
          rgba(255,255,255,0.14) 10px,
          rgba(0,0,0,0.00) 10px,
          rgba(0,0,0,0.00) 20px
        ),
        var(--cancelBg);
      box-shadow: 0 0 0 1px var(--cancelBorder) inset, 0 0 24px rgba(255,0,60,0.28);
    }

    /* Tooltip */
    .tt-tooltip{
      position: fixed;
      z-index: 9999;
      max-width: 340px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(20, 20, 26, 0.92);
      color: #fff;
      box-shadow: 0 12px 40px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
      font-weight: 900;
      font-size: 12px;
      line-height: 1.35;
      transform: translate(12px, 12px);
      display:none;
      pointer-events:none;
    }
    .tt-tooltip .t-title{
      font-size: 13px;
      letter-spacing: .2px;
      margin-bottom: 6px;
    }
    .tt-tooltip .t-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      border-top: 1px solid rgba(255,255,255,0.10);
      padding-top: 6px;
      margin-top: 6px;
    }
    .tt-tooltip .k{ color: rgba(255,255,255,0.70); }
    .tt-tooltip .v{ color: #fff; text-align:right; }

    .footer{
      margin-top: 18px;
      text-align: center;
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      letter-spacing: .2px;
      user-select: none;
    }
  </style>
</head>

<body class="theme-dark">
  <div class="wrap">
    <h1>School Progress</h1>

    <div class="topbar">
      <button id="settingsBtn" class="btn" type="button">Nastavení ⚙️</button>
    </div>

    <div id="settingsPanel" class="block hidden">
      <div class="rowTitle">Nastavení</div>

      <div class="field">
        <span>Theme</span>
        <select id="themeSelect" aria-label="Theme">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
          <option value="loona">Loona</option>
          <option value="sobokill">SOBOKILL</option>
        </select>
      </div>

      <p class="hint">Hover na buňku = detail. Na mobilu tap (přepne tooltip).</p>
      <p class="hint" id="apiStatus">API: fallback (lokální data)</p>
    </div>

    <div id="timetableBlock" class="block timetable">
      <div class="tt-top">
        <div>
          <div class="rowTitle">Rozvrh</div>
          <div class="tt-sub" id="ttSub">DE3A • Týdenní přehled</div>
        </div>
        <div class="tt-meta">
          <span class="tt-badge" id="ttUpdated">Aktualizováno: —</span>
        </div>
      </div>

      <div class="tt-grid" id="ttGrid" style="--cols: 7;"></div>

      <p class="hint">Legenda: zelená = akce • theme = suplování • červená šrafovaná = odpadlo</p>
    </div>

    <div class="footer">© 2026 All rights reserved • Version 1.2.27</div>
  </div>

  <div class="tt-tooltip" id="ttTooltip" aria-hidden="true"></div>

<script>
  /* =========================
     API (DOPLŇ TVOU WORKER URL)
     ========================= */
  const API_URL = "https://TVUJ-WORKER.workers.dev/api/timetable?class=5A&type=Actual";

  let CLASS_NAME = "DE3A";

  let TIMES = [
    {start:"07:55", end:"08:40"},
    {start:"08:50", end:"09:35"},
    {start:"09:50", end:"10:35"},
    {start:"10:45", end:"11:30"},
    {start:"11:35", end:"12:20"},
    {start:"12:50", end:"13:35"},
    {start:"13:40", end:"14:25"},
  ];

  let SCHEDULE = {
    Mon: [
      {subj:"MAT", room:"UČ10", teacher:"BUP"},
      {subj:"NEJ", room:"UČ11", teacher:"PRH"},
      {subj:"OBN", room:"UČ10", teacher:"ZYJ"},
      {subj:"EKO", room:"UČ11", teacher:"FRP"},
      {subj:"VYT", room:"UČ10", teacher:"KIN"},
      {subj:"NEJ", room:"UČ21", teacher:"PRH"},
      {subj:"ČJL", room:"UČ9", teacher:"BAP"},
    ],
    Tue: [
      {subj:"KAJ", room:"UČ2", teacher:"BUI"},
      {subj:"PSK", room:"VT1", teacher:"KOO"},
      {subj:"ZPG", room:"UČ10", teacher:"KUO"},
      {subj:"ZPG", room:"UČ10", teacher:"KUO"},
      {subj:"ČJL", room:"UČ10", teacher:"BAP"},
      {subj:"ČJL", room:"UČ10", teacher:"BAP"},
      {subj:"ELT", room:"UČ10", teacher:"CAJ"},
    ],
    Wed: [
      {subj:"AŠK", room:"", teacher:""},
      {subj:"AŠK", room:"", teacher:""},
      {subj:"AŠK", room:"", teacher:""},
      {subj:"ELT", room:"UČ10", teacher:"CAJ"},
      {subj:"SWA", room:"UČ10", teacher:"CAJ"},
      {subj:"ANJ", room:"UČ11", teacher:"KLE"},
      {subj:"ANJ", room:"UČ10", teacher:"KLE"},
    ],
    Thu: [
      {subj:"VYT", room:"UČ10", teacher:"KIN"},
      {subj:"VYA", room:"UČ10", teacher:"KOO"},
      {subj:"ANJ", room:"UČ2", teacher:"KLM"},
      {subj:"VYA", room:"UČ13", teacher:"KOO"},
      null,
      {subj:"TVY", room:"TV3", teacher:"PRM"},
      {subj:"TVY", room:"TV3", teacher:"PRM"},
    ],
    Fri: [
      {subj:"SWA", room:"UČ10", teacher:"CAJ"},
      {subj:"SWA", room:"UČ10", teacher:"CAJ"},
      {subj:"ČJL", room:"UČ10", teacher:"BAP"},
      {subj:"PSK", room:"UČ10", teacher:"KOO"},
      {subj:"ČJL", room:"UČ20", teacher:"BAP"},
      null,
      null,
    ],
  };

  // Demo stavy (dokud backend nebude vracet změny/supl/akce)
  let MARKS = [
    { day:"Mon", idx:2, type:"event", title:"Akce", room:"Aula", note:"Workshop" },
    { day:"Mon", idx:1, type:"subst", note:"supl: PRH → KLE" },
    { day:"Fri", idx:4, type:"cancel", note:"ODPADLO" },
  ];

  const DAY_ORDER = [
    {key:"Mon", label:"Po"},
    {key:"Tue", label:"Út"},
    {key:"Wed", label:"St"},
    {key:"Thu", label:"Čt"},
    {key:"Fri", label:"Pá"},
  ];

  const $ = (id) => document.getElementById(id);

  function applyTheme(theme){
    const body = document.body;
    body.classList.remove("theme-light","theme-dark","theme-loona","theme-sobokill");
    body.classList.add("theme-" + theme);
    localStorage.setItem("sp_theme", theme);
    const sel = $("themeSelect");
    if (sel) sel.value = theme;
  }

  function initSettings(){
    $("settingsBtn").addEventListener("click", () => $("settingsPanel").classList.toggle("hidden"));
    $("themeSelect").addEventListener("change", () => applyTheme($("themeSelect").value));
    applyTheme(localStorage.getItem("sp_theme") || "dark");
  }

  function two(n){ return String(n).padStart(2,"0"); }
  function formatDateCZ(d){
    return `${two(d.getDate())}.${two(d.getMonth()+1)}.${d.getFullYear()} ${two(d.getHours())}:${two(d.getMinutes())}`;
  }

  function padTime(hhmm){
    const [h,m] = String(hhmm).split(":");
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
  }

  function getMark(day, idx){
    return MARKS.find(m => m.day===day && m.idx===idx) || null;
  }

  function getWeekDatesMonToFri(now = new Date()){
    const d = new Date(now);
    d.setHours(0,0,0,0);
    const day = d.getDay(); // 0-6
    const diffToMon = (day === 0 ? -6 : 1 - day);
    d.setDate(d.getDate() + diffToMon);

    const out = [];
    for (let i=0; i<5; i++){
      const x = new Date(d);
      x.setDate(d.getDate() + i);
      out.push(x);
    }
    return out;
  }

  function normalizeLesson(x){
    if (!x) return null;
    return {
      subj: x.subj || x.subject || "",
      room: x.room || x.classroom || "",
      teacher: x.teacher || "",
    };
  }

  function hasAnyApiLesson(days){
    if (!days || typeof days !== "object") return false;
    const keys = ["Mon","Tue","Wed","Thu","Fri"];
    return keys.some(k => Array.isArray(days[k]) && days[k].some(v => v && (v.subj || v.subject)));
  }

  async function loadFromApi(){
    const statusEl = $("apiStatus");
    try{
      if (API_URL.includes("TVUJ-WORKER")) {
        statusEl.textContent = "API: fallback (doplň API_URL)";
        return false;
      }

      statusEl.textContent = "API: načítám…";
      const res = await fetch(API_URL, { cache: "no-store" });
      const data = await res.json();

      if (!res.ok || !data?.ok) throw new Error(data?.error || `HTTP ${res.status}`);

      // times (to už ti funguje)
      if (Array.isArray(data.times) && data.times.length){
        TIMES = data.times.map(t => ({
          start: padTime(t.start),
          end: padTime(t.end),
        }));
      }

      // lessons only if parser vrátí něco použitelného
      if (hasAnyApiLesson(data.days)){
        const next = {};
        for (const d of ["Mon","Tue","Wed","Thu","Fri"]){
          const arr = Array.isArray(data.days[d]) ? data.days[d] : [];
          next[d] = arr.map(normalizeLesson);
          while (next[d].length < TIMES.length) next[d].push(null);
          next[d] = next[d].slice(0, TIMES.length);
        }
        SCHEDULE = next;
        statusEl.textContent = "API: live data ✅";
      } else {
        statusEl.textContent = "API: parser běží, lessons zatím fallback ⚠️";
      }

      // zkus class id
      if (data?.source?.classId){
        // class=5A z API je ID, ale UI chceš DE3A; nechám DE3A pokud už máš nastaveno
        // případně můžeš odkomentovat:
        // CLASS_NAME = data.source.classId;
      }

      $("ttUpdated").textContent = "Aktualizováno: " + formatDateCZ(new Date());
      return true;
    }catch(err){
      console.error(err);
      statusEl.textContent = "API: error, fallback (lokální data)";
      $("ttUpdated").textContent = "Aktualizováno: " + formatDateCZ(new Date());
      return false;
    }
  }

  const tooltip = $("ttTooltip");
  let tooltipPinned = false;

  function showTooltip(html, x, y){
    tooltip.innerHTML = html;
    tooltip.style.left = x + "px";
    tooltip.style.top = y + "px";
    tooltip.style.display = "block";
    tooltip.setAttribute("aria-hidden", "false");
  }
  function moveTooltip(x, y){
    if (tooltipPinned) return;
    tooltip.style.left = x + "px";
    tooltip.style.top = y + "px";
  }
  function hideTooltip(force = false){
    if (tooltipPinned && !force) return;
    tooltip.style.display = "none";
    tooltip.setAttribute("aria-hidden", "true");
    tooltipPinned = false;
  }

  function tooltipHTML(data){
    return `
      <div class="t-title">${data.dayLabel} • ${data.dateLong} • Hodina ${data.hourIdx+1}/${data.totalHours} (${data.time})</div>
      <div class="t-row"><div class="k">Třída</div><div class="v">${data.className || "-"}</div></div>
      <div class="t-row"><div class="k">Předmět</div><div class="v">${data.subj || "-"}</div></div>
      <div class="t-row"><div class="k">Učebna</div><div class="v">${data.room || "-"}</div></div>
      <div class="t-row"><div class="k">Učitel</div><div class="v">${data.teacher || "-"}</div></div>
      ${data.type ? `<div class="t-row"><div class="k">Typ</div><div class="v">${data.type}</div></div>` : ``}
      ${data.note ? `<div class="t-row"><div class="k">Popis</div><div class="v">${data.note}</div></div>` : ``}
    `;
  }

  function getTotalHoursForDay(dayKey){
    const arr = SCHEDULE[dayKey] || [];
    let last = -1;
    for (let i=0;i<arr.length;i++){
      if (arr[i] && (arr[i].subj || arr[i].subject)) last = i;
    }
    return Math.max(1, last + 1);
  }

  function renderTimetable(){
    const grid = $("ttGrid");
    const cols = TIMES.length;
    grid.style.setProperty("--cols", cols);
    grid.innerHTML = "";

    const corner = document.createElement("div");
    corner.className = "tt-corner";
    grid.appendChild(corner);

    TIMES.forEach((t, i) => {
      const h = document.createElement("div");
      h.className = "tt-h";
      h.innerHTML = `${i+1}<br><span>${padTime(t.start)}–${padTime(t.end)}</span>`;
      grid.appendChild(h);
    });

    const weekDates = getWeekDatesMonToFri(new Date());

    for (let dIndex = 0; dIndex < DAY_ORDER.length; dIndex++){
      const d = DAY_ORDER[dIndex];

      const dayCell = document.createElement("div");
      dayCell.className = "tt-day";
      dayCell.textContent = d.label;
      grid.appendChild(dayCell);

      for (let i=0;i<cols;i++){
        const base = (SCHEDULE[d.key] && SCHEDULE[d.key][i]) ? normalizeLesson(SCHEDULE[d.key][i]) : null;
        const mark = getMark(d.key, i);

        const cell = document.createElement("div");
        cell.className = "tt-cell";

        if (!base && !mark){
          cell.classList.add("tt-empty");
          cell.textContent = "—";
          grid.appendChild(cell);
          continue;
        }

        let type = "";
        if (mark?.type === "event") { cell.classList.add("tt-event"); type = "Akce"; }
        if (mark?.type === "subst") { cell.classList.add("tt-subst"); type = "Suplování"; }
        if (mark?.type === "cancel") { cell.classList.add("tt-cancel"); type = "Odpadlo"; }

        const subj =
          (mark?.type === "event") ? (mark.title || "Akce")
          : (base?.subj || "");

        const room =
          (mark?.type === "event") ? (mark.room || "")
          : (base?.room || "");

        const teacher =
          (mark?.type === "event") ? ""
          : (base?.teacher || "");

        const note = mark?.note || "";

        const topline = document.createElement("div");
        topline.className = "tt-topline";
        topline.innerHTML = `<span class="cls">${CLASS_NAME}</span><span class="room">${room || ""}</span>`;
        cell.appendChild(topline);

        const subjEl = document.createElement("div");
        subjEl.className = "tt-subj";
        subjEl.textContent = subj;
        cell.appendChild(subjEl);

        const teacherEl = document.createElement("div");
        teacherEl.className = "tt-teacher";
        teacherEl.textContent = teacher;
        cell.appendChild(teacherEl);

        const dayDate = weekDates[dIndex];
        const totalHours = getTotalHoursForDay(d.key);

        const tdata = {
          dayLabel: d.label,
          dateLong: dayDate ? `${two(dayDate.getDate())}.${two(dayDate.getMonth()+1)}.${dayDate.getFullYear()}` : "-",
          hourIdx: i,
          totalHours,
          time: `${padTime(TIMES[i].start)}–${padTime(TIMES[i].end)}`,
          className: CLASS_NAME,
          subj,
          room,
          teacher,
          note,
          type
        };

        cell.addEventListener("mouseenter", (e) => {
          tooltipPinned = false;
          showTooltip(tooltipHTML(tdata), e.clientX, e.clientY);
        });
        cell.addEventListener("mousemove", (e) => moveTooltip(e.clientX, e.clientY));
        cell.addEventListener("mouseleave", () => hideTooltip());

        // mobile tap / desktop click pin toggle
        cell.addEventListener("click", (e) => {
          e.stopPropagation();
          const isVisible = tooltip.style.display === "block";
          if (isVisible && tooltipPinned){
            hideTooltip(true);
          } else {
            tooltipPinned = true;
            showTooltip(tooltipHTML(tdata), e.clientX || (window.innerWidth/2), e.clientY || (window.innerHeight/2));
          }
        });

        grid.appendChild(cell);
      }
    }

    $("ttUpdated").textContent = "Aktualizováno: " + formatDateCZ(new Date());
  }

  function boot(){
    initSettings();
    renderTimetable();       // okamžitě fallback
    loadFromApi().then(() => {
      renderTimetable();     // překresli po API (times/live lessons)
    });

    // auto refresh
    setInterval(async () => {
      await loadFromApi();
      renderTimetable();
    }, 5 * 60 * 1000);

    document.addEventListener("click", () => hideTooltip(true));
    window.addEventListener("scroll", () => hideTooltip(true), { passive:true });
    window.addEventListener("resize", () => hideTooltip(true));
  }
  document.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>
