<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>School Progress</title>

  <style>
    /* =========================
       THEMES via CSS variables
       ========================= */
    body{
      --bg:#f4f4f4;
      --card:#ffffff;
      --text:#222;
      --muted:#666;
      --shadow: rgba(0,0,0,0.06);
      --linebg:#e0e0e0;
      --green:#3bb54a;
      --orange:#ff9800;

      --btn:#111;
      --btnText:#fff;

      --badge:#eee;
      --badgeLive:#e8f5e9;
      --badgeFree:#fff3cd;
      --badgeErr:#fdecea;

      --border:#eee;

      --accent:#ff2ea6;
      --accent2:#ff5fd1;
      --glow: rgba(255,46,166,0.45);

      --bgImage: none;
      --bgOverlay: linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.0));

      --uiScale: 1;
    }

    body.theme-dark{
      --bg:#0f1115;
      --card:#171a21;
      --text:#e7e9ee;
      --muted:#a6acb8;
      --shadow: rgba(0,0,0,0.35);
      --linebg:#2a2f3a;

      --btn:#e7e9ee;
      --btnText:#111;

      --badge:#232836;
      --badgeLive:#1f3a2a;
      --badgeFree:#3a311f;
      --badgeErr:#3a1f23;

      --border:#2a2f3a;
    }

    body.theme-loona{
      --bg:#08060b;
      --card: rgba(18, 12, 22, 0.78);
      --text:#ffe9f6;
      --muted:#d7a6c4;
      --shadow: rgba(0,0,0,0.55);
      --linebg: rgba(255, 70, 190, 0.18);

      --btn:#ff2ea6;
      --btnText:#120812;

      --badge: rgba(255, 46, 166, 0.18);
      --badgeLive: rgba(0, 255, 170, 0.12);
      --badgeFree: rgba(255, 190, 60, 0.16);
      --badgeErr: rgba(255, 80, 80, 0.16);

      --border: rgba(255, 70, 190, 0.20);

      --accent:#ff2ea6;
      --accent2:#ff6bd8;
      --glow: rgba(255,46,166,0.55);

      --bgImage: url("loona.png");
      --bgOverlay: linear-gradient(180deg, rgba(8,6,11,0.78), rgba(8,6,11,0.92));
    }

    body.theme-sobokill{
      --bg:#070604;
      --card: rgba(18, 14, 8, 0.82);
      --text:#fff3dc;
      --muted:#d2b98b;
      --shadow: rgba(0,0,0,0.60);
      --linebg: rgba(212, 175, 55, 0.18);

      --btn:#d4af37;
      --btnText:#1a1206;

      --badge: rgba(212,175,55,0.16);
      --badgeLive: rgba(0, 210, 160, 0.12);
      --badgeFree: rgba(255,190,60,0.16);
      --badgeErr: rgba(255,80,80,0.16);

      --border: rgba(212,175,55,0.22);

      --accent:#d4af37;
      --accent2:#f1d07a;
      --glow: rgba(212,175,55,0.40);

      --bgImage: url("sobokill.png");
      --bgOverlay: linear-gradient(180deg, rgba(7,6,4,0.76), rgba(7,6,4,0.92));
    }

    *{ box-sizing:border-box; }
    html, body { min-height:100%; }
    body{
      font-family: Arial, sans-serif;
      margin:0;
      padding: calc(24px * var(--uiScale));
      color:var(--text);
      background:
        var(--bgOverlay),
        var(--bgImage),
        radial-gradient(1200px 700px at 15% 15%, rgba(255,46,166,0.14), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(255,95,209,0.12), transparent 60%),
        radial-gradient(1000px 650px at 30% 90%, rgba(212,175,55,0.10), transparent 60%),
        var(--bg);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      transition: background .2s ease, color .2s ease;
    }

    .wrap{ max-width: 1500px; margin:0 auto; }

    .titleWrap{
      position: relative;
      display:flex;
      justify-content:center;
      align-items:center;
      min-height: calc(54px * var(--uiScale));
      margin-bottom: calc(14px * var(--uiScale));
    }
    h1.mainTitle{
      margin:0;
      text-align:center;
      font-weight:900;
      letter-spacing:0.2px;
      font-size: calc(34px * var(--uiScale));
      line-height: 1.1;
      text-shadow: 0 0 0 transparent;
    }
    body.theme-loona h1.mainTitle,
    body.theme-sobokill h1.mainTitle{
      text-shadow: 0 0 18px var(--glow);
    }

    @font-face {
      font-family: "Monocraft";
      src: url("./Monocraft.ttf") format("truetype");
      font-display: swap;
    }

    .mcSplash{
      position:absolute;
      right: clamp(4px, 7vw, 120px);
      top: 0;
      transform: rotate(-18deg) scale(1);
      transform-origin: center;
      color: #ffd43b;
      text-shadow:
        2px 2px 0 #4a3700,
        0 0 10px rgba(255,212,59,.25);
      font-family: "Monocraft", monospace;
      font-size: calc(13px * var(--uiScale));
      line-height:1;
      white-space: nowrap;
      pointer-events:none;
      user-select:none;
      animation: mcSplashPulse .55s ease-in-out infinite alternate;
      max-width: 40vw;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    @keyframes mcSplashPulse {
      from { transform: rotate(-18deg) scale(0.94); }
      to   { transform: rotate(-18deg) scale(1.08); }
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      margin-bottom: calc(12px * var(--uiScale));
      gap: calc(10px * var(--uiScale));
    }
    .btn{
      border:none;
      padding: calc(10px * var(--uiScale)) calc(12px * var(--uiScale));
      border-radius:10px;
      background:var(--btn);
      color:var(--btnText);
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
      box-shadow: 0 0 0 transparent;
      font-size: calc(14px * var(--uiScale));
    }
    body.theme-loona .btn,
    body.theme-sobokill .btn{
      box-shadow: 0 0 18px var(--glow);
    }

    .layout{
      display:grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr) minmax(260px, 310px);
      gap: calc(14px * var(--uiScale));
      align-items:start;
    }
    .leftMain, .rightMain, .addonCol{ min-width:0; }

    @media (max-width: 1200px){
      .layout{
        grid-template-columns: 1fr;
      }
      .addonCol{ order:3; }
      body{ padding:16px; }
      .mcSplash{ right: 6px; top:-2px; max-width: 55vw; font-size: 10px; }
    }

    .colHead{
      text-align:center;
      font-weight:900;
      color:var(--muted);
      margin:0 0 calc(8px * var(--uiScale)) 0;
      font-size: calc(13px * var(--uiScale));
      letter-spacing:0.3px;
    }

    .block{
      background:var(--card);
      padding: calc(16px * var(--uiScale)) calc(16px * var(--uiScale)) calc(12px * var(--uiScale));
      border-radius:12px;
      margin: calc(12px * var(--uiScale)) 0;
      border: 1px solid var(--border);
      box-shadow:0 2px 10px var(--shadow);
      backdrop-filter: blur(10px);
      min-width: 0;
    }
    body.theme-loona .block,
    body.theme-sobokill .block{
      box-shadow: 0 6px 26px rgba(0,0,0,0.55), 0 0 0.5px rgba(255,255,255,0.05);
    }

    .rowTitle{
      margin:0 0 calc(10px * var(--uiScale)) 0;
      font-size: calc(18px * var(--uiScale));
      font-weight:900;
      color: var(--text);
    }
    body.theme-loona .rowTitle,
    body.theme-sobokill .rowTitle{ color: var(--accent2); }

    .line{
      position:relative;
      width:100%;
      height: calc(3px * var(--uiScale));
      min-height: 3px;
      background:var(--linebg);
      border-radius:999px;
      overflow:hidden;
    }
    .fill{
      position:absolute;
      left:0; top:0;
      height:100%;
      width:0%;
      background:var(--green);
      border-radius:999px;
      transition: width 0.35s ease;
    }
    .fill.weekend{ background:var(--orange); }

    .label{
      margin: calc(10px * var(--uiScale)) 0 0 0;
      font-weight:900;
      font-size: calc(14px * var(--uiScale));
      line-height:1.3;
    }
    .hint{
      margin: calc(10px * var(--uiScale)) 0 0 0;
      color:var(--muted);
      font-size: calc(13px * var(--uiScale));
      line-height:1.35;
    }

    .hidden{ display:none !important; }
    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      margin:8px 0;
      font-weight:900;
      font-size: calc(14px * var(--uiScale));
    }

    .field{
      display:flex;
      align-items:center;
      gap:10px;
      margin:10px 0 6px;
      font-weight:900;
      flex-wrap: wrap;
      font-size: calc(14px * var(--uiScale));
    }
    select{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background: transparent;
      color: var(--text);
      font-weight:900;
      outline:none;
      font-size: calc(14px * var(--uiScale));
    }

    input[type="range"]{
      width: 220px;
      accent-color: var(--accent);
    }

    .dailyRow{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .badge{
      padding:6px 10px;
      border-radius:999px;
      background:var(--badge);
      font-weight:900;
      font-size: calc(13px * var(--uiScale));
    }
    .badge.live{ background:var(--badgeLive); }
    .badge.free{ background:var(--badgeFree); }
    .badge.err{ background:var(--badgeErr); }

    /* Fancy local timetable */
    .ttWrap{
      overflow:hidden;
      border:1px solid var(--border);
      border-radius:12px;
      background: rgba(255,255,255,0.02);
    }
    .ttGrid{
      display:grid;
      grid-template-columns: 70px repeat(7, 1fr);
      gap:8px;
      padding:10px;
      min-width: 0;
    }
    .ttCorner, .ttHourHead, .ttDayHead, .ttCell{
      border-radius:10px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.02);
    }
    .ttCorner{
      min-height: 52px;
      display:flex; align-items:center; justify-content:center;
      color:var(--muted); font-weight:900;
      font-size: 12px;
    }
    .ttHourHead{
      min-height: 52px;
      padding:6px;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      text-align:center;
    }
    .ttHourHead .n{ font-weight:900; font-size: 16px; line-height:1; }
    .ttHourHead .t{ font-size: 11px; color:var(--muted); margin-top:3px; }
    .ttDayHead{
      min-height: 54px;
      display:flex; align-items:center; justify-content:center;
      writing-mode: vertical-rl;
      transform: rotate(180deg);
      font-weight:900;
      color:var(--muted);
      letter-spacing:.3px;
      font-size: 13px;
    }
    .ttCell{
      min-height: 74px;
      padding:8px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:4px;
      overflow:hidden;
      position:relative;
    }
    .ttCell.empty{
      background: rgba(255,255,255,0.01);
      border-style:dashed;
      opacity:.55;
    }
    .ttCell .subj{
      font-weight:900;
      font-size: 14px;
      line-height:1.1;
      word-break: break-word;
    }
    .ttCell .meta{
      font-size: 11px;
      color:var(--muted);
      font-weight:900;
      line-height:1.2;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .ttCell.mark{
      box-shadow: inset 0 0 0 1px rgba(255,60,60,.25);
      background: rgba(255,60,60,.06);
    }
    .ttCell.event{
      box-shadow: inset 0 0 0 1px rgba(59,181,74,.25);
      background: rgba(59,181,74,.07);
    }
    .ttCell.now{
      outline: 2px solid rgba(255,212,59,.6);
      outline-offset: -2px;
    }

    /* Addon panel */
    .addonCol .colHead{
      text-transform: uppercase;
      letter-spacing: .9px;
    }

    .eventsList{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 320px; /* ~3 cards visible */
      overflow-y: auto;
      padding-right: 4px;
      scroll-behavior: smooth;
    }
    .eventsList::-webkit-scrollbar{ width: 8px; }
    .eventsList::-webkit-scrollbar-thumb{
      background: var(--linebg);
      border-radius: 999px;
    }

    .eventItem{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background: rgba(255,255,255,.02);
    }
    .eventItem.event-green{
      border-color: rgba(59,181,74,.4);
      background: rgba(59,181,74,.08);
    }
    .eventItem.event-red{
      border-color: rgba(255,80,80,.35);
      background: rgba(255,80,80,.08);
    }
    .eventTitle{
      font-weight:900;
      font-size: 15px;
      margin-bottom:4px;
    }
    .eventSub{
      color:var(--muted);
      font-weight:900;
      font-size: 12px;
      margin-bottom:3px;
    }
    .eventDesc{
      font-weight:900;
      font-size: 13px;
      line-height:1.25;
      word-break: break-word;
    }

    /* C√°fa Tracker */
    .cafaState{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background: rgba(255,255,255,0.03);
    }
    .cafaState.ct-live{
      border-color: rgba(59,181,74,.45);
      background: rgba(59,181,74,.10);
      box-shadow: inset 0 0 0 1px rgba(59,181,74,.14);
    }
    .cafaState.ct-break{
      border-color: rgba(255,193,7,.45);
      background: rgba(255,193,7,.08);
      box-shadow: inset 0 0 0 1px rgba(255,193,7,.14);
    }
    .cafaState.ct-shadows{
      border-color: rgba(120,120,150,.35);
      background: rgba(120,120,150,.06);
    }
    .cafaState.ct-off{
      border-color: rgba(255,80,80,.30);
      background: rgba(255,80,80,.05);
    }
    .cafaTitle{ font-weight:900; margin-bottom:8px; font-size:15px; }
    .cafaLine1{ font-weight:900; font-size:14px; margin-bottom:6px; line-height:1.3; }
    .cafaLine2{ color:var(--muted); font-weight:900; font-size:13px; line-height:1.35; }
    .cafaMeta{ margin-top:8px; font-size:12px; color:var(--muted); font-weight:900; }

    .footer{
      margin-top: 18px;
      padding: 14px 0 2px;
      text-align: center;
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      letter-spacing: .2px;
      user-select: none;
      line-height: 1.7;
    }
    .footer a{
      color: var(--text);
      text-decoration: none;
      border-bottom: 1px dashed var(--border);
    }
    .footer a:hover{ opacity:.9; }

    @media (max-width:900px){
      .ttGrid{ grid-template-columns: 54px repeat(7, minmax(80px,1fr)); overflow:auto; }
      .ttWrap{ overflow:auto; }
      .ttCell{ min-height: 68px; }
    }
  </style>
</head>

<body class="theme-dark">
  <div class="wrap">
    <div class="titleWrap">
      <h1 class="mainTitle">School Progress</h1>
      <div id="mcSplash" class="mcSplash">Loading splash...</div>
    </div>

    <div class="topbar">
      <button id="settingsBtn" class="btn" type="button">Nastaven√≠ ‚öôÔ∏è</button>
    </div>

    <div id="settingsPanel" class="block hidden">
      <div class="rowTitle">Nastaven√≠</div>

      <div class="field">
        <span>Theme</span>
        <select id="themeSelect" aria-label="Theme">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
          <option value="loona">Loona</option>
          <option value="sobokill">SOBOKILL</option>
        </select>
      </div>

      <div class="field">
        <span>Velikost UI</span>
        <input id="uiScaleRange" type="range" min="85" max="125" step="1" value="100" />
        <span id="uiScaleLabel">100%</span>
      </div>

      <label class="toggle">
        <input type="checkbox" id="toggleTimetable" checked />
        <span>Zobrazit rozvrh</span>
      </label>

      <label class="toggle">
        <input type="checkbox" id="toggleDaily" checked />
        <span>Zobrazit denn√≠ progres</span>
      </label>

      <label class="toggle">
        <input type="checkbox" id="toggleAddon" checked />
        <span>Zobrazit addon panel</span>
      </label>

      <label class="toggle">
        <input type="checkbox" id="toggleEvents" checked />
        <span>Zobrazit Ud√°losti</span>
      </label>

      <label class="toggle">
        <input type="checkbox" id="toggleCafa" checked />
        <span>Zobrazit C√°fa Tracker</span>
      </label>

      <p class="hint" id="statusHint">Status: OK</p>
    </div>

    <div class="layout">
      <!-- LEFT -->
      <div class="leftMain">
        <div class="colHead">Real-Time</div>

        <div class="block">
          <div class="rowTitle">T√Ωden</div>
          <div class="line"><div class="fill" id="rt-week"></div></div>
          <p class="label" id="rt-week-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Mƒõs√≠c</div>
          <div class="line"><div class="fill" id="rt-month"></div></div>
          <p class="label" id="rt-month-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">≈†koln√≠ rok</div>
          <div class="line"><div class="fill" id="rt-year"></div></div>
          <p class="label" id="rt-year-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Celkem</div>
          <div class="line"><div class="fill" id="rt-total"></div></div>
          <p class="label" id="rt-total-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Maturita</div>
          <p class="label" id="rt-maturita-label"></p>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="rightMain">
        <div class="colHead">Raw-Time</div>

        <div class="block">
          <div class="rowTitle">T√Ωden</div>
          <div class="line"><div class="fill" id="raw-week"></div></div>
          <p class="label" id="raw-week-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Mƒõs√≠c</div>
          <div class="line"><div class="fill" id="raw-month"></div></div>
          <p class="label" id="raw-month-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">≈†koln√≠ rok</div>
          <div class="line"><div class="fill" id="raw-year"></div></div>
          <p class="label" id="raw-year-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Celkem</div>
          <div class="line"><div class="fill" id="raw-total"></div></div>
          <p class="label" id="raw-total-label"></p>
        </div>

        <div class="block">
          <div class="rowTitle">Maturita</div>
          <p class="label" id="raw-maturita-label"></p>
        </div>
      </div>

      <!-- ADDON -->
      <div class="addonCol" id="addonPanel">
        <div class="colHead">Addon Panel</div>

        <div id="eventsBlock" class="block">
          <div class="rowTitle">Ud√°losti</div>
          <div id="eventsList" class="eventsList">
            <div class="eventItem">
              <div class="eventTitle">Naƒç√≠t√°n√≠...</div>
              <div class="eventDesc">ƒåek√°m na data z backendu.</div>
            </div>
          </div>
        </div>

        <div id="cafaBlock" class="block">
          <div class="rowTitle">C√°fa Tracker</div>
          <div id="cafaTrackerBody">
            <div class="cafaState ct-off">
              <div class="cafaTitle">C√°fa Tracker</div>
              <div class="cafaLine1">Naƒç√≠t√°n√≠...</div>
              <div class="cafaLine2">ƒåek√°m na rozvrh uƒçitele.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="dailyBlock" class="block">
      <div class="rowTitle">Denn√≠ progres</div>
      <div class="dailyRow">
        <div class="badge" id="dailyBadge">Rozvrh</div>
        <div class="dailyText" id="dailyText" style="font-weight:900;">‚Äî</div>
      </div>
      <div class="line" style="margin-top:10px;">
        <div class="fill" id="daybar"></div>
      </div>
      <p class="label" id="daylabel"></p>
      <p class="hint" id="dailyDebug"></p>
    </div>

    <div id="timetableBlock" class="block">
      <div class="rowTitle">Rozvrh</div>
      <div class="ttWrap">
        <div id="ttFancy" class="ttGrid"></div>
      </div>
      <p class="hint" id="ttSourceHint">Zdroj: naƒç√≠t√°m...</p>
    </div>

    <div class="footer">
      <div>Created By Johnny Hotovost</div>
      <div>¬© 2026 All rights reserved</div>
      <div><a href="https://ko-fi.com/johnny74802" target="_blank" rel="noopener noreferrer">Podpo≈ôit na Ko-fi</a></div>
    </div>
  </div>

<script>
/* =========================
   BACKEND API
   ========================= */
const WORKER_BASE = "https://bakalariapi.janpilat-bp.workers.dev";
const BACKEND_CLASS_API   = `${WORKER_BASE}/api/timetable?class=5A&type=Actual`;
const BACKEND_TEACHER_API = `${WORKER_BASE}/api/timetable?teacher=UV069&type=Actual`;

/* =========================
   LOCAL FALLBACK TIMETABLE DATA
   (pou≈æije se jen kdy≈æ backend sel≈æe)
   ========================= */
const TIMES_FALLBACK = [
  {start:"07:55", end:"08:40"},
  {start:"08:50", end:"09:35"},
  {start:"09:50", end:"10:35"},
  {start:"10:45", end:"11:30"},
  {start:"11:35", end:"12:20"},
  {start:"12:50", end:"13:35"},
  {start:"13:40", end:"14:25"},
];

const SCHEDULE_FALLBACK = {
  Mon: [
    {subj:"MAT", room:"Uƒå10"},
    {subj:"NEJ", room:"Uƒå11"},
    {subj:"OBN", room:"Uƒå10"},
    {subj:"EKO", room:"Uƒå11"},
    {subj:"VYT", room:"Uƒå10"},
    {subj:"NEJ", room:"Uƒå21"},
    {subj:"MAT", room:"Uƒå9"},
  ],
  Tue: [
    {subj:"KAJ", room:"Uƒå10"},
    {subj:"PSK", room:"Uƒå10"},
    {subj:"ZPG", room:"Uƒå10"},
    {subj:"ZPG", room:"Uƒå10"},
    {subj:"ƒåJL", room:"Uƒå10"},
    {subj:"ƒåJL", room:"Uƒå10"},
    {subj:"ELT", room:"Uƒå9"},
  ],
  Wed: [
    {subj:"NEJ", room:"Uƒå10"},
    {subj:"MAT", room:"Uƒå10"},
    {subj:"VYA", room:"Uƒå10"},
    {subj:"ELT", room:"Uƒå10"},
    {subj:"SWA", room:"Uƒå10"},
    {subj:"ANJ", room:"Uƒå14"},
    {subj:"ANJ", room:"Uƒå14"},
  ],
  Thu: [
    {subj:"VYT", room:"Uƒå10"},
    {subj:"VYA", room:"Uƒå10"},
    {subj:"ANJ", room:"Uƒå2"},
    {subj:"VYA", room:"Uƒå13"},
    null,
    {subj:"TVY", room:"TV3"},
    {subj:"TVY", room:"TV3"},
  ],
  Fri: [
    {subj:"SWA", room:"Uƒå10"},
    {subj:"SWA", room:"Uƒå10"},
    {subj:"ƒåJL", room:"Uƒå10"},
    {subj:"PSK", room:"Uƒå10"},
    {subj:"ƒåJL", room:"Uƒå20"},
    null,
    null,
  ],
};

/* =========================
   PROGRESS DATA
   ========================= */
const HS_START = localDate(2023, 9, 4);
const HS_END   = localDateEnd(2027, 6, 30);
const MATURITA_APPROX = localDateEnd(2027, 5, 1);

const BREAKS = [
  r("2023-10-26","2023-10-27"),
  r("2023-12-23","2024-01-02"),
  r("2024-02-02","2024-02-02"),
  r("2024-02-26","2024-03-03"),
  r("2024-07-01","2024-08-31"),
  r("2024-10-29","2024-10-30"),
  r("2024-12-23","2025-01-03"),
  r("2025-01-31","2025-01-31"),
  r("2025-03-03","2025-03-09"),
  r("2025-07-01","2025-08-31"),
  r("2025-10-27","2025-10-29"),
  r("2025-12-22","2026-01-02"),
  r("2026-01-30","2026-01-30"),
  r("2026-03-09","2026-03-15"),
  r("2026-07-01","2026-08-31"),
  r("2026-10-29","2026-10-30"),
  r("2026-12-23","2027-01-03"),
  r("2027-01-29","2027-01-29"),
  r("2027-02-01","2027-02-07"),
];
const DIRECTOR_DAYS = [];

/* =========================
   SUBJECT SHORT MAP (zkratky)
   ========================= */
const SUBJECT_SHORT = {
  "Matematika":"MAT",
  "ƒåesk√Ω jazyk a literatura":"ƒåJL",
  "Elektrotechnika":"ELT",
  "Softwarov√© aplikace":"SWA",
  "Poƒç√≠taƒçov√© s√≠tƒõ a komunikace":"PSK",
  "Z√°kladn√≠ programov√© vybaven√≠":"ZPG",
  "V√Ωvoj aplikac√≠":"VYA",
  "V√Ωpoƒçetn√≠ technika":"VYT",
  "Ekonomie":"EKO",
  "Obƒçansk√° nauka":"OBN",
  "Fyzika":"FYZ",
  "Technick√© kreslen√≠":"TEK",
  "Tƒõlesn√° v√Ωchova":"TV",
  "Tƒõlesn√° v√Ωchova ":"TV",
  "Nƒõmeck√Ω jazyk":"NEJ",
  "Rusk√Ω jazyk":"RUJ",
  "Anglick√Ω jazyk":"ANJ",
  "ANJ1 / ANJ2":"ANJ",
  "RUJ / NEJ":"JAZ",
  "Akce ≈°koly":"A≈†K",
};

function shortSubj(full){
  const s = String(full || "").trim();
  if (!s) return "";
  if (SUBJECT_SHORT[s]) return SUBJECT_SHORT[s];

  // merged combos
  if (s.includes("/")) {
    const parts = s.split("/").map(x => x.trim()).filter(Boolean);
    const mapped = parts.map(p => SUBJECT_SHORT[p] || p.slice(0,3).toUpperCase());
    return [...new Set(mapped)].join("/");
  }

  // fallback normalize 3 letters
  const normalized = s
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^A-Za-z]/g, "");
  return (normalized.slice(0,3) || s.slice(0,3)).toUpperCase();
}

/* =========================
   GLOBAL STATE
   ========================= */
const state = {
  classData: null,
  teacherData: null,
  backendOk: false,
  teacherBackendOk: false,
  classSourceMode: "local-fallback",
  teacherSourceMode: "none",
  lastFetchAt: null,
};

/* =========================
   Helpers
   ========================= */
const $ = (id) => document.getElementById(id);
const clamp = (x, a=0, b=100) => Math.max(a, Math.min(b, x));
const setBar = (id, pct, weekend=false) => {
  const n = $(id); if (!n) return;
  n.style.width = clamp(pct).toFixed(2) + "%";
  weekend ? n.classList.add("weekend") : n.classList.remove("weekend");
};
const setText = (id, txt) => { const n=$(id); if(n) n.textContent = txt; };
const esc = (s) => String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

function localDate(y,m,d){ const dt=new Date(y,m-1,d); dt.setHours(0,0,0,0); return dt; }
function localDateEnd(y,m,d){ const dt=new Date(y,m-1,d); dt.setHours(23,59,59,999); return dt; }
function r(s,e){ return {s,e}; }

function toISO(d){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const da=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}
function formatDateCZ(d){
  const dd = String(d.getDate()).padStart(2,"0");
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const yy = d.getFullYear();
  return `${dd}.${mm}.${yy}`;
}
function fmtHm(hhmm){
  const [h,m]=String(hhmm).split(":");
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
}

function inBreak(iso){ return BREAKS.some(x => iso>=x.s && iso<=x.e); }
function isSchoolDay(d){
  const dow = d.getDay();
  if (dow===0 || dow===6) return false;
  const iso = toISO(d);
  if (DIRECTOR_DAYS.includes(iso)) return false;
  if (inBreak(iso)) return false;
  return true;
}
function countSchoolDays(start, end){
  const s = new Date(start); s.setHours(0,0,0,0);
  const e = new Date(end);   e.setHours(23,59,59,999);
  let c=0;
  const cur = new Date(s);
  while (cur <= e){
    if (isSchoolDay(cur)) c++;
    cur.setDate(cur.getDate()+1);
  }
  return c;
}
function calendarPctBetween(start, end, now){
  const total = end - start; if (total<=0) return 0;
  const passed = Math.min(Math.max(now-start, 0), total);
  return (passed/total)*100;
}
function rawPctBetween(start, end, now){
  const total = countSchoolDays(start, end);
  const clipped = now < start ? start : (now > end ? end : now);
  const passed = countSchoolDays(start, clipped);
  return total ? (passed/total)*100 : 0;
}
function rawDaysUntil(target, now){
  const start = new Date(now); start.setHours(0,0,0,0);
  const end = new Date(target); end.setHours(23,59,59,999);
  if (end < start) return -countSchoolDays(end, start);
  return countSchoolDays(start, end);
}
function getSchoolYearRange(now){
  const y = (now.getMonth()>=8) ? now.getFullYear() : now.getFullYear()-1;
  return { start: localDate(y,9,1), end: localDateEnd(y+1,6,30) };
}
function timeToMin(hhmm){
  const [h,m] = String(hhmm).split(":").map(Number);
  return h*60 + m;
}
function getTodayKey(now = new Date()){
  const d = now.getDay();
  return d===1?"Mon":d===2?"Tue":d===3?"Wed":d===4?"Thu":d===5?"Fri":null;
}
function dayKeyToCz(k){
  return ({Mon:"Po",Tue:"√öt",Wed:"St",Thu:"ƒåt",Fri:"P√°"})[k] || k;
}
function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

function normalizeTimes(times){
  if (!Array.isArray(times) || !times.length) return TIMES_FALLBACK;
  return times.slice(0,7).map(t => ({
    start: fmtHm(t.start ?? t.from ?? "07:55"),
    end: fmtHm(t.end ?? t.to ?? "08:40")
  }));
}
function normalizeDays(days){
  const empty = {Mon:[null,null,null,null,null,null,null],Tue:[null,null,null,null,null,null,null],Wed:[null,null,null,null,null,null,null],Thu:[null,null,null,null,null,null,null],Fri:[null,null,null,null,null,null,null]};
  if (!days || typeof days !== "object") return empty;
  for (const key of Object.keys(empty)){
    const arr = Array.isArray(days[key]) ? days[key] : [];
    empty[key] = Array.from({length:7}, (_,i) => arr[i] ?? null);
  }
  return empty;
}
function normalizeDataForUi(data, fallbackType="class"){
  if (!data || !data.days) {
    return {
      times: TIMES_FALLBACK,
      days: normalizeDays(SCHEDULE_FALLBACK),
      marks: [],
      events: [],
      source: { mode: "local-fallback" }
    };
  }
  return {
    times: normalizeTimes(data.times),
    days: normalizeDays(data.days),
    marks: Array.isArray(data.marks) ? data.marks : [],
    events: Array.isArray(data.events) ? data.events : [],
    source: data.source || { mode: fallbackType }
  };
}

/* =========================
   Theme + Settings
   ========================= */
function applyTheme(theme){
  const body = document.body;
  body.classList.remove("theme-light","theme-dark","theme-loona","theme-sobokill");
  body.classList.add("theme-" + theme);
  localStorage.setItem("sp_theme", theme);
  const sel = $("themeSelect");
  if (sel) sel.value = theme;
}
function applyUiScale(percent){
  const v = Math.max(85, Math.min(125, Number(percent)||100));
  document.body.style.setProperty("--uiScale", (v/100).toFixed(2));
  localStorage.setItem("sp_uiScale", String(v));
  if ($("uiScaleRange")) $("uiScaleRange").value = String(v);
  if ($("uiScaleLabel")) $("uiScaleLabel").textContent = `${v}%`;
}
function setToggleState(id, value){
  localStorage.setItem(`sp_${id}`, value ? "1" : "0");
}
function getToggleState(id, def=true){
  const v = localStorage.getItem(`sp_${id}`);
  if (v == null) return def;
  return v === "1";
}

function initSettings(){
  const btn = $("settingsBtn");
  const panel = $("settingsPanel");
  const toggleTT = $("toggleTimetable");
  const toggleDaily = $("toggleDaily");
  const toggleAddon = $("toggleAddon");
  const toggleEvents = $("toggleEvents");
  const toggleCafa = $("toggleCafa");
  const timetableBlock = $("timetableBlock");
  const dailyBlock = $("dailyBlock");
  const addonPanel = $("addonPanel");
  const eventsBlock = $("eventsBlock");
  const cafaBlock = $("cafaBlock");
  const themeSelect = $("themeSelect");
  const uiScaleRange = $("uiScaleRange");

  btn.addEventListener("click", () => panel.classList.toggle("hidden"));

  function syncVisibility(){
    timetableBlock.classList.toggle("hidden", !toggleTT.checked);
    dailyBlock.classList.toggle("hidden", !toggleDaily.checked);
    addonPanel.classList.toggle("hidden", !toggleAddon.checked);
    eventsBlock.classList.toggle("hidden", !toggleEvents.checked || !toggleAddon.checked);
    cafaBlock.classList.toggle("hidden", !toggleCafa.checked || !toggleAddon.checked);
  }

  [toggleTT, toggleDaily, toggleAddon, toggleEvents, toggleCafa].forEach(el => {
    el.addEventListener("change", () => {
      setToggleState(el.id, el.checked);
      syncVisibility();
    });
  });

  themeSelect.addEventListener("change", () => applyTheme(themeSelect.value));
  uiScaleRange.addEventListener("input", () => applyUiScale(uiScaleRange.value));

  toggleTT.checked = getToggleState("toggleTimetable", true);
  toggleDaily.checked = getToggleState("toggleDaily", true);
  toggleAddon.checked = getToggleState("toggleAddon", true);
  toggleEvents.checked = getToggleState("toggleEvents", true);
  toggleCafa.checked = getToggleState("toggleCafa", true);

  applyTheme(localStorage.getItem("sp_theme") || "dark");
  applyUiScale(localStorage.getItem("sp_uiScale") || 100);
  syncVisibility();
}

/* =========================
   Minecraft splash
   ========================= */
async function loadMinecraftSplash(){
  const el = $("mcSplash");
  if (!el) return;
  const fallback = [
    "Now with C√°fa Tracker!",
    "Suplov√°n√≠ detected!",
    "Bakal√°≈ôi moment",
    "Touch grass after class",
    "School grind never ends",
    "Powered by Johnny!",
    "Raw-Time supremacy"
  ];
  try {
    const res = await fetch("./MinecraftTextSource.txt?ts=" + Date.now(), { cache: "no-store" });
    if (!res.ok) throw new Error("source not found");
    const txt = await res.text();
    const lines = txt.split(/\r?\n/).map(x => x.trim()).filter(x => x && !x.startsWith("#"));
    el.textContent = (lines[Math.floor(Math.random()*lines.length)] || fallback[0]);
  } catch (e) {
    el.textContent = fallback[Math.floor(Math.random()*fallback.length)];
    console.warn("Splash load failed:", e);
  }
}

/* =========================
   Backend fetch + fallback
   ========================= */
async function fetchJsonSafe(url){
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}

function fallbackClassData(){
  return {
    ok:true,
    source:{mode:"local-fallback"},
    times: TIMES_FALLBACK,
    days: normalizeDays(SCHEDULE_FALLBACK),
    marks: [],
    events: []
  };
}
function fallbackTeacherData(){
  // Minimal fallback = unknown/off
  return {
    ok:true,
    source:{mode:"none"},
    times: TIMES_FALLBACK,
    days: {Mon:[null,null,null,null,null,null,null],Tue:[null,null,null,null,null,null,null],Wed:[null,null,null,null,null,null,null],Thu:[null,null,null,null,null,null,null],Fri:[null,null,null,null,null,null,null]},
    marks: [],
    events: []
  };
}

async function refreshBackendData(){
  let classErr = null, teacherErr = null;

  try {
    const classJson = await fetchJsonSafe(BACKEND_CLASS_API);
    state.classData = normalizeDataForUi(classJson, "class");
    state.backendOk = true;
    state.classSourceMode = classJson?.source?.mode || "class";
  } catch (e) {
    classErr = e;
    state.classData = normalizeDataForUi(fallbackClassData(), "class");
    state.backendOk = false;
    state.classSourceMode = "local-fallback";
  }

  try {
    const teacherJson = await fetchJsonSafe(BACKEND_TEACHER_API);
    state.teacherData = normalizeDataForUi(teacherJson, "teacher");
    state.teacherBackendOk = true;
    state.teacherSourceMode = teacherJson?.source?.mode || "teacher";
  } catch (e) {
    teacherErr = e;
    state.teacherData = normalizeDataForUi(fallbackTeacherData(), "teacher");
    state.teacherBackendOk = false;
    state.teacherSourceMode = "local-fallback";
  }

  state.lastFetchAt = new Date();

  const statusParts = [];
  statusParts.push(`Class: ${state.backendOk ? "OK" : "Fallback"}`);
  statusParts.push(`Teacher: ${state.teacherBackendOk ? "OK" : "Fallback"}`);
  setText("statusHint", "Status: " + statusParts.join(" ‚Ä¢ "));

  if (classErr) console.warn("Class API failed:", classErr);
  if (teacherErr) console.warn("Teacher API failed:", teacherErr);

  renderTimetable();
  renderEvents();
  renderCafaTrackerCard(state.teacherData);
}

/* =========================
   Daily progress (class timetable aware)
   ========================= */
function fmtLesson(x){
  if (!x) return null;
  const s = shortSubj(x.subj || x.subject || "");
  return x.room ? `${s || x.subj} (${x.room})` : (s || x.subj || "Hodina");
}
function countTodayLessons(arr){
  let last = -1;
  for (let i=0;i<arr.length;i++){
    if (arr[i]) last = i;
  }
  return Math.max(last+1, 0);
}
function setDailyBadge(kind, text){
  const b=$("dailyBadge");
  if (!b) return;
  b.className = "badge" + (kind ? (" "+kind) : "");
  b.textContent = text;
}

function updateDaily(now){
  const d = state.classData || normalizeDataForUi(fallbackClassData(),"class");
  const TIMES = d.times || TIMES_FALLBACK;
  const DAYS = d.days || normalizeDays(SCHEDULE_FALLBACK);

  const dow = now.getDay();
  const dayKey = (dow===1)?"Mon":(dow===2)?"Tue":(dow===3)?"Wed":(dow===4)?"Thu":(dow===5)?"Fri":null;

  if (!dayKey){
    setDailyBadge("free","Volno");
    setText("dailyText","Volno üòé");
    setBar("daybar",100);
    setText("daylabel","");
    setText("dailyDebug", `Weekend ‚Ä¢ ${formatDateCZ(now)}`);
    return;
  }

  const timesMin = TIMES.slice(0,7).map(t => ({ startMin: timeToMin(t.start), endMin: timeToMin(t.end) }));
  const lessons = (DAYS[dayKey] || []).slice(0, timesMin.length);
  const totalToday = Math.max(countTodayLessons(lessons), 0) || timesMin.length;

  const nowMin = now.getHours()*60 + now.getMinutes();
  const first = timesMin[0];
  const last = timesMin[totalToday-1] || timesMin[timesMin.length-1];

  if (nowMin > last.endMin){
    setDailyBadge("free","Volno");
    setText("dailyText","Volno üòé");
    setBar("daybar",100);
    setText("daylabel","");
    setText("dailyDebug", `${dayKey} ‚Ä¢ ${formatDateCZ(now)}`);
    return;
  }

  if (nowMin < first.startMin){
    setDailyBadge("live","Dnes");
    const next = fmtLesson(lessons[0]) || `Hodina 1/${totalToday}`;
    setText("dailyText",`Za chv√≠li zaƒçne: ${next}`);
    setBar("daybar",0);
    setText("daylabel",`Hodina 1/${totalToday} ‚Ä¢ start v ${fmtHm(TIMES[0].start)}`);
    setText("dailyDebug", `${dayKey} ‚Ä¢ ${formatDateCZ(now)}`);
    return;
  }

  for (let i=0;i<totalToday;i++){
    const t = timesMin[i];
    const cur = fmtLesson(lessons[i]) || `Hodina ${i+1}/${totalToday}`;
    const next = (i+1<totalToday) ? (fmtLesson(lessons[i+1]) || `Hodina ${i+2}/${totalToday}`) : null;

    if (nowMin >= t.startMin && nowMin <= t.endMin){
      const pct = ((nowMin - t.startMin) / Math.max(1,(t.endMin - t.startMin))) * 100;
      setDailyBadge("live","Pr√°vƒõ");
      setText("dailyText", next ? `Pr√°vƒõ: ${cur} ‚Ä¢ Dal≈°√≠: ${next}` : `Pr√°vƒõ: ${cur}`);
      setBar("daybar", pct);
      setText("daylabel", `Hodina ${i+1}/${totalToday} ‚Ä¢ ${fmtHm(TIMES[i].start)}‚Äì${fmtHm(TIMES[i].end)} ‚Ä¢ ${pct.toFixed(0)}%`);
      setText("dailyDebug", `${dayKey} ‚Ä¢ ${formatDateCZ(now)}`);
      return;
    }

    const nt = timesMin[i+1];
    if (nt && nowMin > t.endMin && nowMin < nt.startMin){
      setDailyBadge("live","Pauza");
      setText("dailyText", `N√°sleduje: ${next || "‚Äî"}`);
      setBar("daybar", 0);
      setText("daylabel", `Dal≈°√≠ hodina ${i+2}/${totalToday} v ${fmtHm(TIMES[i+1].start)}`);
      setText("dailyDebug", `${dayKey} ‚Ä¢ ${formatDateCZ(now)}`);
      return;
    }
  }

  setDailyBadge("free","Volno");
  setText("dailyText","Volno üòé");
  setBar("daybar",100);
  setText("daylabel","");
  setText("dailyDebug", `${dayKey} ‚Ä¢ ${formatDateCZ(now)}`);
}

/* =========================
   Timetable render (fancy local)
   ========================= */
function getMarkMap(marks){
  const map = new Map();
  (marks || []).forEach(m => {
    if (!m || !m.day || typeof m.idx !== "number") return;
    map.set(`${m.day}-${m.idx}`, m);
  });
  return map;
}

function dedupeEvents(items){
  const seen = new Set();
  const out = [];
  for (const x of items){
    const key = [
      (x.title||"").trim().toLowerCase(),
      (x.day||"").trim().toLowerCase(),
      x.idx ?? "",
      (x.note||"").trim().toLowerCase(),
      (x.room||"").trim().toLowerCase()
    ].join("|");
    if (seen.has(key)) continue;
    seen.add(key);
    out.push(x);
  }
  return out;
}

function buildEventItemsFromClassData(classData){
  const out = [];
  const times = (classData?.times || TIMES_FALLBACK).slice(0,7);
  const marks = Array.isArray(classData?.marks) ? classData.marks : [];
  const days = classData?.days || {};

  // 1) explicit events from backend
  if (Array.isArray(classData?.events)) {
    for (const ev of classData.events) {
      out.push({
        type: "event",
        title: ev.title || "Akce",
        day: ev.day || "",
        idx: typeof ev.idx === "number" ? ev.idx : null,
        note: ev.note || ev.desc || ev.subject || "Akce ≈°koly",
        room: ev.room || ""
      });
    }
  }

  // 2) marks (substitutions etc.)
  for (const m of marks){
    out.push({
      type: (m.type === "subst" ? "subst" : "event"),
      title: m.title || (m.type === "subst" ? "Suplov√°n√≠" : "Akce"),
      day: m.day || "",
      idx: typeof m.idx === "number" ? m.idx : null,
      note: m.note || "",
      room: m.room || ""
    });
  }

  // 3) infer "Akce ≈°koly" from empty subject cells / notes in class timetable (weekly/actual weirdness)
  const dayKeys = ["Mon","Tue","Wed","Thu","Fri"];
  for (const day of dayKeys){
    const arr = Array.isArray(days[day]) ? days[day] : [];
    for (let i=0;i<Math.min(7, arr.length);i++){
      const it = arr[i];
      if (!it) continue;
      const subj = String(it.subj || "").trim().toLowerCase();
      const note = String(it.note || "").trim().toLowerCase();
      if (subj.includes("akce ≈°koly") || note.includes("akce ≈°koly")) {
        out.push({
          type: "event",
          title: "Akce",
          day,
          idx: i,
          note: "Akce ≈°koly",
          room: it.room || ""
        });
      }
    }
  }

  // 4) remove duplicates
  const deduped = dedupeEvents(out);

  // 5) sort day/hour
  const order = {Mon:1,Tue:2,Wed:3,Thu:4,Fri:5};
  deduped.sort((a,b) => (order[a.day]||99) - (order[b.day]||99) || ((a.idx ?? 99) - (b.idx ?? 99)));

  return deduped;
}

function renderTimetable(){
  const box = $("ttFancy");
  if (!box) return;

  const d = state.classData || normalizeDataForUi(fallbackClassData(),"class");
  const TIMES = (d.times || TIMES_FALLBACK).slice(0,7);
  const DAYS = d.days || normalizeDays(SCHEDULE_FALLBACK);
  const marksMap = getMarkMap(d.marks || []);
  const now = new Date();
  const todayKey = getTodayKey(now);
  const nowMin = now.getHours()*60 + now.getMinutes();

  const dayNames = [
    {key:"Mon", label:"Po"},
    {key:"Tue", label:"√öt"},
    {key:"Wed", label:"St"},
    {key:"Thu", label:"ƒåt"},
    {key:"Fri", label:"P√°"},
  ];

  let html = "";

  html += `<div class="ttCorner">Den / Hod</div>`;
  for (let i=0;i<7;i++){
    const t = TIMES[i] || TIMES_FALLBACK[i];
    html += `
      <div class="ttHourHead">
        <div class="n">${i+1}</div>
        <div class="t">${esc(fmtHm(t.start))}-${esc(fmtHm(t.end))}</div>
      </div>
    `;
  }

  for (const day of dayNames){
    html += `<div class="ttDayHead">${day.label}</div>`;
    const arr = (DAYS[day.key] || []).slice(0,7);

    for (let i=0;i<7;i++){
      const item = arr[i] ?? null;
      const mark = marksMap.get(`${day.key}-${i}`);
      const t = TIMES[i] || TIMES_FALLBACK[i];
      const startMin = timeToMin(t.start), endMin = timeToMin(t.end);
      const isNow = (day.key === todayKey && nowMin >= startMin && nowMin <= endMin);

      if (!item){
        // if no lesson, but infer event slot on Wednesday first 3 hours bug-case from backend events list
        const inferredEvent = (buildEventItemsFromClassData(d) || []).find(e => e.day===day.key && e.idx===i && String(e.note||"").toLowerCase().includes("akce ≈°koly"));
        const classes = ["ttCell"];
        if (inferredEvent) classes.push("event");
        if (isNow) classes.push("now");
        if (!inferredEvent) classes.push("empty");

        if (inferredEvent){
          html += `
            <div class="${classes.join(" ")}" title="${esc(inferredEvent.note || "Akce ≈°koly")}">
              <div class="subj">A≈†K</div>
              <div class="meta">${esc(inferredEvent.note || "Akce ≈°koly")}</div>
              <div class="meta">${esc(inferredEvent.room || "")}</div>
            </div>
          `;
        } else {
          html += `<div class="${classes.join(" ")}"></div>`;
        }
        continue;
      }

      const subjFull = item.subj || "";
      const subjShort = shortSubj(subjFull);
      const room = item.room || "";
      const note = item.note || "";
      const isEvent = String(subjFull).toLowerCase().includes("akce ≈°koly") || String(note).toLowerCase().includes("akce ≈°koly");

      const classes = ["ttCell"];
      if (mark) classes.push("mark");
      if (isEvent) classes.push("event");
      if (isNow) classes.push("now");

      const title = [subjFull, room, item.teacher, item.class, note].filter(Boolean).join(" ‚Ä¢ ");

      html += `
        <div class="${classes.join(" ")}" title="${esc(title)}">
          <div class="subj">${esc(subjShort || subjFull || "‚Äî")}</div>
          <div class="meta">${esc(room)}</div>
          <div class="meta">${esc((item.class || item.teacher || note || "").slice(0,60))}</div>
        </div>
      `;
    }
  }

  box.innerHTML = html;

  const sourceMode = state.backendOk ? "Backend (Bakal√°≈ôi API)" : "Lok√°ln√≠ fallback";
  const classMode = state.classSourceMode ? ` ‚Ä¢ mode: ${state.classSourceMode}` : "";
  const eventsCount = buildEventItemsFromClassData(d).length;
  setText("ttSourceHint", `Zdroj: ${sourceMode}${classMode} ‚Ä¢ ud√°lost√≠: ${eventsCount}`);
}

/* =========================
   Ud√°losti (MAX ~3 visible + scroll)
   ========================= */
function renderEvents(){
  const box = $("eventsList");
  if (!box) return;

  const d = state.classData || normalizeDataForUi(fallbackClassData(),"class");
  const events = buildEventItemsFromClassData(d);
  const TIMES = (d.times || TIMES_FALLBACK).slice(0,7);

  if (!events.length){
    box.innerHTML = `
      <div class="eventItem">
        <div class="eventTitle">Nic nenalezeno</div>
        <div class="eventDesc">Backend aktu√°lnƒõ nevr√°til ≈°koln√≠ akce / zmƒõny pro tento rozvrh.</div>
      </div>
    `;
    return;
  }

  box.innerHTML = events.map(ev => {
    const cls = ev.type === "subst" ? "eventItem event-red" : "eventItem event-green";
    const idx = typeof ev.idx === "number" ? ev.idx : null;
    const t = idx != null ? TIMES[idx] : null;
    const when = idx != null && t
      ? `${dayKeyToCz(ev.day)} ‚Ä¢ hodina ${idx+1}/7 ‚Ä¢ ${fmtHm(t.start)}-${fmtHm(t.end)}${ev.room ? ` ‚Ä¢ ${ev.room}` : ""}`
      : `${dayKeyToCz(ev.day || "")}${ev.room ? ` ‚Ä¢ ${ev.room}` : ""}`;

    return `
      <div class="${cls}">
        <div class="eventTitle">${esc(ev.title || "Akce")}</div>
        <div class="eventSub">${esc(when)}</div>
        <div class="eventDesc">${esc(ev.note || "Akce ≈°koly")}</div>
      </div>
    `;
  }).join("");
}

/* =========================
   C√°fa Tracker (with "last seen" on break)
   ========================= */
function getCafaState(teacherData, now = new Date()){
  if (!teacherData || !teacherData.days || !teacherData.times) {
    return { mode:"offline", title:"C√°fa Tracker", line1:"Data nejsou dostupn√°", line2:"C√°fa se skr√Ωv√° ve st√≠nech." };
  }

  const dayKey = getTodayKey(now);
  if (!dayKey) {
    return { mode:"shadows", title:"C√°fa Tracker", line1:"Dnes nevyuƒçuje", line2:"C√°fa se skr√Ωv√° ve st√≠nech." };
  }

  const day = (teacherData.days[dayKey] || []).slice(0,7);
  const times = (teacherData.times || TIMES_FALLBACK).slice(0,7);
  const nowMin = now.getHours()*60 + now.getMinutes();

  let firstIdx = -1, lastIdx = -1;
  for (let i=0;i<Math.min(day.length,times.length);i++){
    if (day[i]) {
      if (firstIdx === -1) firstIdx = i;
      lastIdx = i;
    }
  }

  if (firstIdx === -1) {
    return { mode:"shadows", title:"C√°fa Tracker", line1:"Dnes nem√° v√Ωuku", line2:"C√°fa se skr√Ωv√° ve st√≠nech." };
  }

  const firstStart = timeToMin(times[firstIdx].start);
  const lastEnd = timeToMin(times[lastIdx].end);

  if (nowMin < firstStart){
    return { mode:"shadows", title:"C√°fa Tracker", line1:"Je≈°tƒõ nezaƒçal uƒçit", line2:"C√°fa se skr√Ωv√° ve st√≠nech." };
  }

  if (nowMin > lastEnd){
    return { mode:"shadows", title:"C√°fa Tracker", line1:"V√Ωuka skonƒçila", line2:"C√°fa se skr√Ωv√° ve st√≠nech." };
  }

  let lastSeen = null;

  for (let i=0;i<Math.min(day.length,times.length);i++){
    const lesson = day[i];
    const t = times[i];
    const start = timeToMin(t.start);
    const end = timeToMin(t.end);

    if (lesson && nowMin >= start) lastSeen = { idx:i, lesson, t };

    if (lesson && nowMin >= start && nowMin <= end){
      return {
        mode: "live",
        title: "C√°fa Tracker",
        line1: `Pr√°vƒõ uƒç√≠: ${shortSubj(lesson.subj) || lesson.subj || "P≈ôedmƒõt"}`,
        line2: `${lesson.class || "T≈ô√≠da"} ‚Ä¢ ${lesson.room || "?"} ‚Ä¢ ${fmtHm(t.start)}‚Äì${fmtHm(t.end)}`,
        meta: `Hodina ${i+1}/7`
      };
    }

    const nextT = times[i+1];
    if (nextT && nowMin > end && nowMin < timeToMin(nextT.start)){
      if (lastSeen?.lesson){
        return {
          mode: "break",
          title: "C√°fa Tracker",
          line1: "P≈ôest√°vka",
          line2: `Naposledy vidƒõn: ${lastSeen.lesson.class || "T≈ô√≠da"} ‚Ä¢ ${lastSeen.lesson.room || "?"}`,
          meta: `${shortSubj(lastSeen.lesson.subj) || lastSeen.lesson.subj || "P≈ôedmƒõt"} ‚Ä¢ hodina ${lastSeen.idx+1}/7`
        };
      }
      return {
        mode: "break",
        title: "C√°fa Tracker",
        line1: "P≈ôest√°vka",
        line2: "Naposledy vidƒõn: nezn√°mo",
        meta: ""
      };
    }
  }

  return { mode:"shadows", title:"C√°fa Tracker", line1:"C√°fa se skr√Ωv√° ve st√≠nech.", line2:"" };
}

function renderCafaTrackerCard(teacherData){
  const box = $("cafaTrackerBody");
  if (!box) return;

  const stateC = getCafaState(teacherData, new Date());

  const modeClass =
    stateC.mode === "live" ? "ct-live" :
    stateC.mode === "break" ? "ct-break" :
    stateC.mode === "shadows" ? "ct-shadows" : "ct-off";

  box.innerHTML = `
    <div class="cafaState ${modeClass}">
      <div class="cafaTitle">${esc(stateC.title || "C√°fa Tracker")}</div>
      <div class="cafaLine1">${esc(stateC.line1 || "")}</div>
      <div class="cafaLine2">${esc(stateC.line2 || "")}</div>
      ${stateC.meta ? `<div class="cafaMeta">${esc(stateC.meta)}</div>` : ``}
    </div>
  `;
}

/* =========================
   Main update
   ========================= */
function updateAll(){
  const now = new Date();
  const timeInDay = now.getHours()/24 + now.getMinutes()/1440;

  const dow = now.getDay();
  const weekend = (dow===0 || dow===6);
  const workIndex = (dow===1)?0:(dow===2)?1:(dow===3)?2:(dow===4)?3:(dow===5)?4:4;
  const weekPct = weekend ? 100 : ((workIndex + timeInDay)/5)*100;

  setBar("rt-week", weekPct, weekend);
  setText("rt-week-label", weekend ? "Weekend üòé" : `T√Ωden: ${weekPct.toFixed(1)}%`);
  setBar("raw-week", weekPct, false);
  setText("raw-week-label", `T√Ωden: ${weekPct.toFixed(1)}%`);

  const dim = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
  const monthPct = ((now.getDate()-1 + timeInDay)/dim)*100;
  setBar("rt-month", monthPct);
  setText("rt-month-label", `Mƒõs√≠c: ${monthPct.toFixed(1)}%`);

  const mStart = localDate(now.getFullYear(), now.getMonth()+1, 1);
  const mEnd   = localDateEnd(now.getFullYear(), now.getMonth()+1, dim);
  const monthRaw = rawPctBetween(mStart, mEnd, now);
  setBar("raw-month", monthRaw);
  setText("raw-month-label", `Mƒõs√≠c: ${monthRaw.toFixed(1)}%`);

  const yr = getSchoolYearRange(now);
  const yearPct = calendarPctBetween(yr.start, yr.end, now);
  setBar("rt-year", yearPct);
  setText("rt-year-label", `≈†koln√≠ rok: ${yearPct.toFixed(1)}%`);
  const yearRaw = rawPctBetween(yr.start, yr.end, now);
  setBar("raw-year", yearRaw);
  setText("raw-year-label", `≈†koln√≠ rok: ${yearRaw.toFixed(1)}%`);

  const totalPct = calendarPctBetween(HS_START, HS_END, now);
  setBar("rt-total", totalPct);
  setText("rt-total-label", `Celkem: ${totalPct.toFixed(1)}%`);
  const totalRaw = rawPctBetween(HS_START, HS_END, now);
  setBar("raw-total", totalRaw);
  setText("raw-total-label", `Celkem: ${totalRaw.toFixed(1)}%`);

  const daysUntil = Math.ceil((MATURITA_APPROX - now) / (1000*60*60*24));
  setText("rt-maturita-label", (daysUntil>=0)
    ? `Real-Time: ~${daysUntil} dn√≠`
    : `Real-Time: hotovo (${Math.abs(daysUntil)} dn√≠ zpƒõt)`);

  const rawDays = rawDaysUntil(MATURITA_APPROX, now);
  setText("raw-maturita-label", (rawDays>=0)
    ? `Raw-Time: ~${rawDays} ≈°koln√≠ch dn√≠`
    : `Raw-Time: hotovo (${Math.abs(rawDays)} ≈°koln√≠ch dn√≠ zpƒõt)`);

  const toggleDaily = $("toggleDaily");
  if (!toggleDaily || toggleDaily.checked) updateDaily(now);

  // refresh live highlights
  renderTimetable();
  renderCafaTrackerCard(state.teacherData);
}

/* =========================
   Boot
   ========================= */
async function boot(){
  initSettings();
  loadMinecraftSplash();

  // Pre-fill fallback so page never stays blank
  state.classData = normalizeDataForUi(fallbackClassData(),"class");
  state.teacherData = normalizeDataForUi(fallbackTeacherData(),"teacher");
  renderTimetable();
  renderEvents();
  renderCafaTrackerCard(state.teacherData);

  updateAll();

  // Load backend
  await refreshBackendData();
  updateAll();

  // Timers
  setInterval(updateAll, 30_000);
  setInterval(refreshBackendData, 5 * 60_000);
}

document.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>
