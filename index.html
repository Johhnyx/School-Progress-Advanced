<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>School Progress</title>

  <style>
    /* =========================
       THEMES via CSS variables
       ========================= */
    body{
      --bg:#f4f4f4;
      --card:#ffffff;
      --text:#222;
      --muted:#666;
      --shadow: rgba(0,0,0,0.06);
      --linebg:#e0e0e0;
      --green:#3bb54a;
      --orange:#ff9800;

      --btn:#111;
      --btnText:#fff;

      --badge:#eee;
      --badgeLive:#e8f5e9;
      --badgeFree:#fff3cd;
      --badgeErr:#fdecea;

      --border:#eee;

      /* Accent pro teƒçky / UI */
      --accent:#3bb54a;
      --accent2:#2f9a3c;
      --glow: rgba(59,181,74,0.35);

      /* Bakal√°≈ôi blue (pro ‚ÄûBakal√°≈ôi‚Äú slovo v title) */
      --bakalariBlue:#1e88e5;

      --bgImage: none;
      --bgOverlay: linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.0));

      --substBg: rgba(255, 80, 80, 0.18);
      --substBorder: rgba(255, 80, 80, 0.40);
      --cancelBg: rgba(255, 0, 60, 0.22);
      --cancelBorder: rgba(255, 0, 60, 0.55);
      --eventBg: rgba(59,181,74,0.22);
      --eventBorder: rgba(59,181,74,0.55);

      --ttSubjColor: rgba(20, 35, 60, 0.92);
      --ttSubjGlow: none;

      --uiScale: 1;
    }

    /* Dark theme */
    body.theme-dark{
      --bg:#0f1115;
      --card:#171a21;
      --text:#e7e9ee;
      --muted:#a6acb8;
      --shadow: rgba(0,0,0,0.35);
      --linebg:#2a2f3a;

      --btn:#e7e9ee;
      --btnText:#111;

      --badge:#232836;
      --badgeLive:#1f3a2a;
      --badgeFree:#3a311f;
      --badgeErr:#3a1f23;

      --border:#2a2f3a;

      --accent:#7de38a;
      --accent2:#3bb54a;
      --glow: rgba(125,227,138,0.30);

      --ttSubjColor: rgba(235, 240, 250, 0.95);
      --ttSubjGlow: none;
    }

    /* Loona theme */
    body.theme-loona{
      --bg:#08060b;
      --card: rgba(18, 12, 22, 0.78);
      --text:#ffe9f6;
      --muted:#d7a6c4;
      --shadow: rgba(0,0,0,0.55);
      --linebg: rgba(255, 70, 190, 0.18);

      --btn:#ff2ea6;
      --btnText:#120812;

      --badge: rgba(255, 46, 166, 0.18);
      --badgeLive: rgba(0, 255, 170, 0.12);
      --badgeFree: rgba(255, 190, 60, 0.16);
      --badgeErr: rgba(255, 80, 80, 0.16);

      --border: rgba(255, 70, 190, 0.20);

      --accent:#ff2ea6;
      --accent2:#ff6bd8;
      --glow: rgba(255,46,166,0.55);

      --bgImage: url("loona.png");
      --bgOverlay: linear-gradient(180deg, rgba(8,6,11,0.78), rgba(8,6,11,0.92));

      --substBg: rgba(255, 46, 166, 0.22);
      --substBorder: rgba(255, 46, 166, 0.52);
      --cancelBg: rgba(255, 0, 90, 0.28);
      --cancelBorder: rgba(255, 0, 90, 0.62);
      --eventBg: rgba(59,181,74,0.20);
      --eventBorder: rgba(59,181,74,0.55);

      --ttSubjColor: rgba(255, 107, 216, 0.98);
      --ttSubjGlow: 0 0 14px rgba(255, 46, 166, 0.35);
    }

    /* SOBOKILL theme */
    body.theme-sobokill{
      --bg:#070604;
      --card: rgba(18, 14, 8, 0.82);
      --text:#fff3dc;
      --muted:#d2b98b;
      --shadow: rgba(0,0,0,0.60);
      --linebg: rgba(212, 175, 55, 0.18);

      --btn:#d4af37;
      --btnText:#1a1206;

      --badge: rgba(212,175,55,0.16);
      --badgeLive: rgba(0, 210, 160, 0.12);
      --badgeFree: rgba(255,190,60,0.16);
      --badgeErr: rgba(255,80,80,0.16);

      --border: rgba(212,175,55,0.22);

      --accent:#d4af37;
      --accent2:#f1d07a;
      --glow: rgba(212,175,55,0.40);

      --bgImage: url("sobokill.png");
      --bgOverlay: linear-gradient(180deg, rgba(7,6,4,0.76), rgba(7,6,4,0.92));

      --substBg: rgba(212, 175, 55, 0.22);
      --substBorder: rgba(212, 175, 55, 0.50);
      --cancelBg: rgba(255, 0, 60, 0.24);
      --cancelBorder: rgba(255, 0, 60, 0.58);
      --eventBg: rgba(59,181,74,0.20);
      --eventBorder: rgba(59,181,74,0.55);

      --ttSubjColor: rgba(241, 208, 122, 0.98);
      --ttSubjGlow: 0 0 14px rgba(212, 175, 55, 0.30);
    }

    /* Ka≈°p√°rnaKart‚Ñ¢ theme (blue) */
    body.theme-kasparnakart{
      --bg:#061427;
      --card: rgba(10, 24, 48, 0.82);
      --text:#eaf3ff;
      --muted:#a6c4e6;
      --shadow: rgba(0,0,0,0.55);
      --linebg: rgba(0, 153, 255, 0.18);

      --btn:#0099ff;
      --btnText:#061427;

      --badge: rgba(0,153,255,0.16);
      --badgeLive: rgba(0, 210, 255, 0.14);
      --badgeFree: rgba(255,190,60,0.16);
      --badgeErr: rgba(255,80,80,0.16);

      --border: rgba(0,153,255,0.22);

      --accent:#0099ff;
      --accent2:#66ccff;
      --glow: rgba(0,153,255,0.45);

      --bgImage: url("KasparnaKart.png");
      --bgOverlay: linear-gradient(180deg, rgba(6,20,39,0.78), rgba(6,20,39,0.92));

      --substBg: rgba(0, 153, 255, 0.20);
      --substBorder: rgba(0, 153, 255, 0.50);
      --cancelBg: rgba(255, 0, 60, 0.22);
      --cancelBorder: rgba(255, 0, 60, 0.55);
      --eventBg: rgba(59,181,74,0.20);
      --eventBorder: rgba(59,181,74,0.55);

      --ttSubjColor: rgba(230, 247, 255, 0.98);
      --ttSubjGlow: 0 0 14px rgba(0,153,255,0.25);
    }

    /* Battle Cats theme */
    body.theme-battlecats{
      --bg:#fbf1d8;
      --card: rgba(255, 255, 255, 0.88);
      --text:#1a1a1a;
      --muted:#5b5142;
      --shadow: rgba(0,0,0,0.12);
      --linebg: rgba(0,0,0,0.12);

      --btn:#ffd84a;
      --btnText:#1a1a1a;

      --badge: rgba(0,0,0,0.06);
      --badgeLive: rgba(59,181,74,0.14);
      --badgeFree: rgba(255,190,60,0.18);
      --badgeErr: rgba(255,80,80,0.16);

      --border: rgba(0,0,0,0.14);

      --accent:#ffd84a;
      --accent2:#ffb000;
      --glow: rgba(255,216,74,0.45);

      --bgImage: url("BattleCats.png");
      --bgOverlay: linear-gradient(180deg, rgba(251,241,216,0.78), rgba(251,241,216,0.92));

      --substBg: rgba(255, 80, 80, 0.16);
      --substBorder: rgba(255, 80, 80, 0.40);
      --cancelBg: rgba(255, 0, 60, 0.16);
      --cancelBorder: rgba(255, 0, 60, 0.42);
      --eventBg: rgba(59,181,74,0.18);
      --eventBorder: rgba(59,181,74,0.45);

      --ttSubjColor: rgba(26, 26, 26, 0.95);
      --ttSubjGlow: none;
    }

    /* =========================
       BASE
       ========================= */
    *{ box-sizing:border-box; }
    body{
      font-family: Arial, sans-serif;
      margin:0;
      padding:24px;
      color:var(--text);
      background:
        var(--bgOverlay),
        var(--bgImage),
        radial-gradient(1200px 700px at 15% 15%, rgba(255,46,166,0.14), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(255,95,209,0.12), transparent 60%),
        radial-gradient(1000px 650px at 30% 90%, rgba(212,175,55,0.10), transparent 60%),
        var(--bg);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      transition: background .2s ease, color .2s ease;
    }

    .wrap{
      max-width:1320px;
      margin:0 auto;
      transform: scale(var(--uiScale));
      transform-origin: top center;
      width: calc(100% / var(--uiScale));
      transition: transform .15s ease;
    }
    @media (max-width:980px){
      .wrap{ transform:none; width:100%; }
      body{ padding:16px; }
      body{ background-attachment: scroll; } /* mobil fix */
    }

    /* ===== Minecraft splash (centered under title) ===== */
    @font-face{
      font-family: "Monocraft";
      src: url("./Monocraft.ttf") format("truetype");
      font-display: swap;
    }
    .titleWrap{
      position: relative;
      margin: 0 0 14px 0;
      display:flex;
      flex-direction: column;
      justify-content:center;
      align-items:center;
    }
    h1{
      margin:0;
      text-align:center;
      font-weight:900;
      letter-spacing:0.2px;
      text-shadow: 0 0 0 transparent;
    }
    body.theme-loona h1,
    body.theme-sobokill h1,
    body.theme-kasparnakart h1,
    body.theme-battlecats h1{
      text-shadow: 0 0 18px var(--glow);
    }

    .mcSplash{
      margin-top: 6px;
      text-align: center;
      color: #ffd43b;
      text-shadow: 2px 2px 0 #4a3700; /* ≈æ√°dn√Ω extra glow nav√≠c */
      font-family: "Monocraft", monospace;
      font-size: 13px;
      line-height: 1.15;
      white-space: nowrap;
      pointer-events: none;
      user-select: none;
      animation: mcSplashPulse .55s ease-in-out infinite alternate;
      max-width: 92%;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    @keyframes mcSplashPulse{
      from { transform: scale(0.95); opacity: 0.92; }
      to   { transform: scale(1.05); opacity: 1; }
    }
    @media (max-width:980px){
      .mcSplash{ font-size: 10px; margin-top: 5px; }
    }

    /* ===== six seven easter egg (HAND EMOTE) ===== */
    .ss{
      display:inline-flex;
      gap: 2px;
      align-items: baseline;
      position: relative;
      will-change: transform, filter;
    }
    .ss .d{ display:inline-block; will-change: transform; }
    .ss.hot{
      filter: drop-shadow(0 0 10px rgba(255, 140, 0, 0.85)) drop-shadow(0 0 18px rgba(255, 90, 0, 0.55));
    }
    .ss.hot .d6{ animation: ssUpDownA .55s ease-in-out 2; }
    .ss.hot .d7{ animation: ssUpDownB .55s ease-in-out 2; }
    @keyframes ssUpDownA{
      0%{transform:translateY(0)} 25%{transform:translateY(-7px)} 50%{transform:translateY(0)}
      75%{transform:translateY(7px)} 100%{transform:translateY(0)}
    }
    @keyframes ssUpDownB{
      0%{transform:translateY(0)} 25%{transform:translateY(7px)} 50%{transform:translateY(0)}
      75%{transform:translateY(-7px)} 100%{transform:translateY(0)}
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      margin-bottom:12px;
      gap:10px;
    }
    .btn{
      border:none;
      padding:10px 12px;
      border-radius:10px;
      background:var(--btn);
      color:var(--btnText);
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
      box-shadow: 0 0 0 transparent;
    }
    body.theme-loona .btn,
    body.theme-sobokill .btn,
    body.theme-kasparnakart .btn,
    body.theme-battlecats .btn{
      box-shadow: 0 0 18px var(--glow);
    }

    .block{
      background:var(--card);
      padding:16px 16px 12px;
      border-radius:12px;
      margin:12px 0;
      border: 1px solid var(--border);
      box-shadow:0 2px 10px var(--shadow);
      backdrop-filter: blur(10px);
      min-width: 0;
    }
    body.theme-loona .block,
    body.theme-sobokill .block,
    body.theme-kasparnakart .block,
    body.theme-battlecats .block{
      box-shadow: 0 6px 26px rgba(0,0,0,0.55), 0 0 0.5px rgba(255,255,255,0.05);
    }

    .rowTitle{
      margin:0 0 10px 0;
      font-size:18px;
      font-weight:900;
      color: var(--text);
    }
    body.theme-loona .rowTitle,
    body.theme-sobokill .rowTitle,
    body.theme-kasparnakart .rowTitle,
    body.theme-battlecats .rowTitle{
      color: var(--accent2);
    }

    .hint{ margin:10px 0 0 0; color:var(--muted); font-size:13px; line-height:1.35; font-weight:900; }
    .label{ margin:10px 0 0 0; font-weight:900; }
    .hidden{ display:none !important; }

    .field{
      display:flex;
      align-items:center;
      gap:10px;
      margin:10px 0 6px;
      font-weight:900;
      flex-wrap: wrap;
    }
    select, input[type="range"]{ accent-color: var(--accent); }
    select{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background: transparent;
      color: var(--text);
      font-weight:900;
      outline:none;
    }

    .toggle{ display:flex; align-items:center; gap:10px; margin:8px 0; font-weight:900; }

    .scaleRow{
      display:flex;
      align-items:center;
      gap:10px;
      margin:10px 0 6px;
      font-weight:900;
      flex-wrap:wrap;
    }
    .scaleRow input[type="range"]{ flex:1 1 240px; min-width:180px; }
    .scaleValue{ min-width:56px; text-align:right; color: var(--muted); font-weight:900; }

    .line{ position:relative; width:100%; height:3px; background:var(--linebg); border-radius:999px; overflow:hidden; }
    .fill{ position:absolute; left:0; top:0; height:100%; width:0%; background:var(--green); border-radius:999px; transition: width 0.35s ease; }
    .fill.weekend{ background:var(--orange); }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; min-width:0; }
    .colHead{ text-align:center; font-weight:900; color:var(--muted); margin:0 0 8px 0; font-size:13px; letter-spacing:0.3px; }
    @media (max-width:980px){ .grid2{ grid-template-columns: 1fr; } }

    .mainLayout{
      display:grid;
      grid-template-columns: minmax(0, 1fr) 320px;
      gap:14px;
      align-items:start;
      min-width: 0;
    }
    @media (max-width:1180px){
      .mainLayout{ grid-template-columns: 1fr; }
      .addonCol{ order:2; }
    }

    /* DAILY */
    .dailyRow{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .badge{ padding:6px 10px; border-radius:999px; background:var(--badge); font-weight:900; font-size:13px; }
    .badge.live{ background:var(--badgeLive); }
    .badge.free{ background:var(--badgeFree); }
    .badge.err{ background:var(--badgeErr); }
    .dailyText{ font-weight:900; }

    /* SETTINGS STATUS: glow green/red */
    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border: 1px solid var(--border);
      font-weight:1000;
      font-size: 12px;
      background: rgba(255,255,255,0.05);
    }
    .dot{
      width:8px; height:8px; border-radius:999px;
      background: #aaa;
      box-shadow: none;
    }
    .dot.ok{
      background: rgba(59,181,74,0.95);
      box-shadow: 0 0 14px rgba(59,181,74,0.55);
    }
    .dot.bad{
      background: rgba(255,0,60,0.95);
      box-shadow: 0 0 14px rgba(255,0,60,0.55);
    }

    /* ADDON / INFO PANEL */
    .addonCol{ display:flex; flex-direction:column; gap:12px; opacity:0.95; min-width:0; }
    .addonHead{ display:none; } /* odstranƒõno: "Info Panel" */
    .addonCard{
      padding: 12px 12px 10px;
    }
    .addonTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .addonTitle{
      font-weight:1000;
      font-size:16px;
      margin:0;
      color: var(--accent2);
    }
    .addonPills{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* Carousel pages container (fixed height + internal scroll) */
    .panelViewport{
      position: relative;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: rgba(255,255,255,0.03);
      height: 320px;               /* ‚úÖ FIX: nikdy se nezvƒõt≈°√≠ */
      overflow: hidden;            /* ‚úÖ ≈æ√°dn√© roztahov√°n√≠ */
      min-width: 0;
    }
    @media (max-width:1180px){
      .panelViewport{ height: 300px; }
    }

    .panelPages{
      display:flex;
      width: 300%;
      height: 100%;
      transform: translateX(0%);
      transition: transform .22s ease;
    }
    .panelPage{
      width: 33.3333%;
      padding-right: 10px;
      height: 100%;
      overflow: hidden;
      min-width:0;
    }
    .panelInnerScroll{
      height: 100%;
      overflow: auto;             /* ‚úÖ scroll uvnit≈ô */
      padding-right: 6px;
      min-width:0;
    }
    .panelInnerScroll::-webkit-scrollbar{ width: 10px; }
    .panelInnerScroll::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,0.14);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }
    .panelInnerScroll::-webkit-scrollbar-track{ background: transparent; }

    /* Dots at bottom (theme colored) */
    .dots{
      position:absolute;
      left:0; right:0; bottom:8px;
      display:flex;
      justify-content:center;
      gap:8px;
      pointer-events:auto;
      opacity: 0.95;
    }
    .dotBtn{
      width:7px; height:7px;
      border-radius:999px;
      background: rgba(255,255,255,0.22);
      border: 1px solid rgba(255,255,255,0.12);
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
    }
    body:not(.theme-battlecats) .dotBtn{
      background: rgba(255,255,255,0.20);
    }
    .dotBtn.active{
      background: var(--accent);
      box-shadow: 0 0 16px var(--glow);
      transform: scale(1.15);
    }

    /* EVENTS LIST */
    .stackList{ display:flex; flex-direction:column; gap:8px; min-width:0; }
    .stackItem{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.03);
      border-radius:10px;
      padding:10px;
      min-width:0;
      overflow:hidden;
    }
    .stackItem.muted{ color:var(--muted); font-weight:900; text-align:center; }
    .stackItem.event{ border-color: var(--eventBorder); background: linear-gradient(180deg, rgba(59,181,74,0.10), rgba(59,181,74,0.04)); }
    .stackItem.subst{ border-color: var(--substBorder); background: linear-gradient(180deg, rgba(255,80,80,0.12), rgba(255,80,80,0.05)); }
    .stackItem.cancel{ border-color: var(--cancelBorder); background: linear-gradient(180deg, rgba(255,0,60,0.12), rgba(255,0,60,0.05)); }
    .eventTitle{ font-weight:1000; font-size:13px; margin-bottom:4px; }
    .eventMeta{ font-weight:900; font-size:11px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .eventDesc{ margin-top:6px; font-size:11px; font-weight:900; color:var(--muted); line-height:1.35; word-break: break-word; }

    /* Sanity */
    .sanityWrap{ display:flex; flex-direction:column; gap:10px; }
    .sanityTopRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .sanityMeterLabel{
      font-weight:1000;
      color: var(--muted);
      font-size: 12px;
    }
    .sanityValue{
      font-weight:1000;
      font-size: 14px;
    }
    .sanityCanvas{
      width:100%;
      height:140px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(0,0,0,0.05);
    }
    body.theme-battlecats .sanityCanvas{ background: rgba(255,255,255,0.7); }
    .feelRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .feelBtn{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 10px;
      padding:8px 10px;
      font-weight:1000;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease;
      user-select:none;
    }
    .feelBtn:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(0,0,0,0.18); }
    .kakaoRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      padding-top: 2px;
    }
    .kakaoWarn{
      font-weight:1000;
      color: rgba(255,0,60,0.95);
      text-shadow: 0 0 12px rgba(255,0,60,0.35);
    }
    .kakaoBtn{
      border:none;
      border-radius:10px;
      padding:10px 12px;
      background: rgba(255,190,60,0.95);
      color:#1a1206;
      font-weight:1000;
      cursor:pointer;
      box-shadow: 0 0 18px rgba(255,190,60,0.25);
      display:none;
    }
    .kakaoBtn.show{ display:inline-block; }

    /* Leaderboard */
    .lbRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      border-radius: 10px;
      padding:10px;
      font-weight:1000;
    }
    .lbName{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .lbVal{ color: var(--muted); }

    /* Tracker card (separate from carousel) */
    .trackerCard{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.03);
      border-radius:12px;
      padding:12px;
      min-width:0;
    }
    .trackerBadge{
      display:inline-block;
      padding:5px 9px;
      border-radius:999px;
      background:var(--badge);
      font-weight:1000;
      font-size:11px;
      margin-bottom:8px;
    }
    .trackerMain{ font-weight:1000; line-height:1.35; margin-bottom:6px; }
    .trackerSub{ color:var(--muted); font-weight:900; font-size:11px; line-height:1.35; }

    /* TIMETABLE */
    .timetable .tt-top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
      flex-wrap: wrap;
    }
    .tt-sub{ color: var(--muted); font-weight: 900; font-size: 12px; margin-top: 2px; }
    .tt-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      white-space:nowrap;
    }
    .tt-gridWrap{ overflow:auto; padding-bottom: 4px; }
    .tt-grid{
      display:grid;
      grid-template-columns: 48px repeat(var(--cols), minmax(120px, 1fr));
      gap:10px;
      min-width: 940px;
    }
    .tt-corner{ height:44px; }

    .tt-h{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background: rgba(255,255,255,0.04);
      text-align:center;
      font-weight: 900;
    }
    .tt-h span{
      display:block;
      font-size: 11px;
      font-weight: 900;
      color: var(--muted);
      margin-top: 4px;
      white-space:nowrap;
    }

    .tt-day{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 0;
      text-align:center;
      font-weight: 900;
      color: var(--muted);
      background: rgba(255,255,255,0.03);
    }

    .tt-cell{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background: rgba(255,255,255,0.04);
      box-shadow: 0 2px 10px var(--shadow);
      position: relative;
      overflow: hidden;
      min-height: 78px;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .tt-cell:hover{
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
    }

    /* Current hour outline (orange) */
    .tt-now{
      outline: 2px solid rgba(255, 152, 0, 0.95);
      outline-offset: -2px;
      box-shadow: 0 0 0 1px rgba(255, 152, 0, 0.25) inset, 0 0 18px rgba(255, 152, 0, 0.35);
    }

    .tt-topline{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      font-weight: 1000;
      font-size: 11px;
      color: var(--muted);
      opacity: 0.95;
    }

    .tt-subj{
      font-weight: 1000;
      letter-spacing: .2px;
      margin-top: 6px;
      font-size: 22px;
      color: var(--ttSubjColor) !important;
      text-shadow: var(--ttSubjGlow);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .tt-teacher{
      font-weight: 900;
      color: var(--muted);
      font-size: 11px;
      margin-top: 8px;
      opacity: 0.95;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .tt-empty{
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--muted);
      font-weight: 900;
      background: rgba(255,255,255,0.02);
      box-shadow: none;
    }

    .tt-event{
      border-color: var(--eventBorder);
      background: var(--eventBg);
      box-shadow: 0 0 0 1px var(--eventBorder) inset, 0 0 18px rgba(59,181,74,0.25);
    }
    .tt-subst{
      border-color: var(--substBorder);
      background: var(--substBg);
      box-shadow: 0 0 0 1px var(--substBorder) inset, 0 0 22px rgba(255,80,80,0.30);
    }
    .tt-cancel{
      border-color: var(--cancelBorder);
      background:
        repeating-linear-gradient(
          135deg,
          rgba(255,255,255,0.14) 0px,
          rgba(255,255,255,0.14) 10px,
          rgba(0,0,0,0.00) 10px,
          rgba(0,0,0,0.00) 20px
        ),
        var(--cancelBg);
      box-shadow: 0 0 0 1px var(--cancelBorder) inset, 0 0 24px rgba(255,0,60,0.28);
    }

    /* Tooltip */
    .tt-tooltip{
      position: fixed;
      z-index: 9999;
      max-width: 360px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(20, 20, 26, 0.92);
      color: #fff;
      box-shadow: 0 12px 40px rgba(0,0,0,0.35);
      backdrop-filter: blur(10px);
      font-weight: 900;
      font-size: 12px;
      line-height: 1.35;
      transform: translate(12px, 12px);
      display:none;
      pointer-events:none;
    }
    .tt-tooltip .t-title{
      font-size: 13px;
      letter-spacing: .2px;
      margin-bottom: 6px;
    }
    .tt-tooltip .t-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      border-top: 1px solid rgba(255,255,255,0.10);
      padding-top: 6px;
      margin-top: 6px;
    }
    .tt-tooltip .k{ color: rgba(255,255,255,0.70); }
    .tt-tooltip .v{ color: #fff; text-align:right; }

    .footer{
      margin-top: 18px;
      padding: 14px 0 4px;
      text-align: center;
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      letter-spacing: .2px;
      user-select: none;
      line-height: 1.6;
    }
    .footer a{
      color: inherit;
      text-decoration: none;
      border-bottom: 1px dashed rgba(255,255,255,0.25);
      opacity: 0.95;
    }
    .footer a:hover{ opacity: 1; border-bottom-style: solid; }
    .footer .footerBy{ font-size: 13px; }
    .footer .footerSep{ opacity: .55; margin: 0 6px; }

    /* Mobile fixes for panel */
    @media (max-width:640px){
      .mainLayout{ gap: 10px; }
      .panelViewport{ height: 290px; }
      .addonCol{ gap: 10px; }
    }
  </style>
</head>

<body class="theme-dark">
  <div class="wrap">
    <div class="titleWrap">
      <h1 id="pageTitle">School Progress</h1>
      <div id="mcSplash" class="mcSplash">Loading splash‚Ä¶</div>
    </div>

    <div class="topbar">
      <button id="settingsBtn" class="btn" type="button">Nastaven√≠ ‚öôÔ∏è</button>
    </div>

    <div id="settingsPanel" class="block hidden">
      <div class="rowTitle">Nastaven√≠</div>

      <div class="field">
        <span>Theme</span>
        <select id="themeSelect" aria-label="Theme">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
          <option value="loona">Loona</option>
          <option value="sobokill">SOBOKILL</option>
          <option value="kasparnakart">Ka≈°p√°rnaKart‚Ñ¢</option>
          <option value="battlecats">Battle Cats</option>
        </select>
      </div>

      <div class="field">
        <span>Mode</span>
        <select id="modeSelect" aria-label="Mode">
          <option value="normal">Normal</option>
          <option value="nonchalant">Nonchalant Mode</option>
          <option value="freaky">Freaky Mode</option>
        </select>
      </div>

      <div class="scaleRow">
        <span>Velikost UI</span>
        <input type="range" id="uiScaleRange" min="85" max="120" step="1" value="100" />
        <span id="uiScaleValue" class="scaleValue">100%</span>
      </div>

      <label class="toggle"><input type="checkbox" id="toggleTimetable" checked /> <span>Zobrazit rozvrh</span></label>
      <label class="toggle"><input type="checkbox" id="toggleDaily" checked /> <span>Zobrazit denn√≠ progres</span></label>
      <label class="toggle"><input type="checkbox" id="toggleInfo" checked /> <span>Zobrazit Info Panel</span></label>
      <label class="toggle"><input type="checkbox" id="toggleTracker" checked /> <span>Zobrazit Tracker</span></label>

      <div class="hint" style="margin-top:10px;">
        <span class="statusPill">
          <span id="dotClass" class="dot"></span>
          <span id="statusClass">Rozvrh: ‚Äî</span>
        </span>
        <span class="statusPill" style="margin-left:10px;">
          <span id="dotTeacher" class="dot"></span>
          <span id="statusTeacher">Tracker: ‚Äî</span>
        </span>
      </div>

      <p class="hint" id="statusHint" style="margin-top:10px;">Status: OK</p>
    </div>

    <div class="mainLayout">
      <div class="grid2">
        <div>
          <div class="colHead">Real-Time</div>

          <div class="block">
            <div class="rowTitle">T√Ωden</div>
            <div class="line"><div class="fill" id="rt-week"></div></div>
            <p class="label" id="rt-week-label"></p>
          </div>

          <div class="block">
            <div class="rowTitle">Mƒõs√≠c</div>
            <div class="line"><div class="fill" id="rt-month"></div></div>
            <p class="label" id="rt-month-label"></p>
          </div>

          <div class="block">
            <div class="rowTitle">≈†koln√≠ rok</div>
            <div class="line"><div class="fill" id="rt-year"></div></div>
            <p class="label" id="rt-year-label"></p>
          </div>

          <div class="block">
            <div class="rowTitle">Celkem</div>
            <div class="line"><div class="fill" id="rt-total"></div></div>
            <p class="label" id="rt-total-label"></p>
          </div>

          <div class="block">
            <div class="rowTitle">Maturita</div>
            <p class="label" id="rt-maturita-label"></p>
          </div>
        </div>

        <div>
          <div class="colHead">Raw-Time</div>

          <div class="block">
            <div class="rowTitle">T√Ωden</div>
            <div class="line"><div class="fill" id="raw-week"></div></div>
            <p class="label" id="raw-week-label"></p>
          </div>

          <div class="block">
            <div class="rowTitle">Mƒõs√≠c</div>
            <div class="line"><div class="fill" id="raw-month"></div></div>
            <p class="label" id="raw-month-label"></p>
          </div>

          <div class="block">
            <div class="rowTitle">≈†koln√≠ rok</div>
            <div class="line"><div class="fill" id="raw-year"></div></div>
            <p class="label" id="raw-year-label"></p>
          </div>

          <div class="block">
            <div class="rowTitle">Celkem</div>
            <div class="line"><div class="fill" id="raw-total"></div></div>
            <p class="label" id="raw-total-label"></p>
          </div>

          <div class="block">
            <div class="rowTitle">Maturita</div>
            <p class="label" id="raw-maturita-label"></p>
          </div>
        </div>
      </div>

      <aside id="addonPanel" class="addonCol">
        <!-- CAROUSEL: Ud√°losti / Sanity / Leaderboard -->
        <div class="block addonCard" id="infoBlock">
          <div class="addonTop">
            <div class="addonTitle" id="infoTitle">Ud√°losti</div>
            <div class="addonPills">
              <span class="statusPill">
                <span id="dotInfo" class="dot"></span>
                <span id="infoSrc">‚Äî</span>
              </span>
            </div>
          </div>

          <div class="panelViewport" id="panelViewport">
            <div class="panelPages" id="panelPages">
              <!-- Page 1: Events -->
              <div class="panelPage">
                <div class="panelInnerScroll">
                  <div id="eventsList" class="stackList">
                    <div class="stackItem muted">Naƒç√≠t√°n√≠‚Ä¶</div>
                  </div>
                </div>
              </div>

              <!-- Page 2: Sanity -->
              <div class="panelPage">
                <div class="panelInnerScroll">
                  <div class="sanityWrap">
                    <div class="sanityTopRow">
                      <div>
                        <div class="sanityMeterLabel">Sanity Meter</div>
                        <div class="sanityValue" id="sanityValue">‚Äî</div>
                      </div>
                      <div class="sanityMeterLabel" id="sanityMeta">‚Äî</div>
                    </div>

                    <canvas id="sanityCanvas" class="sanityCanvas" width="900" height="300"></canvas>

                    <div class="sanityMeterLabel">Jak se c√≠t√≠≈° teƒè (jen bƒõhem hodiny)?</div>
                    <div class="feelRow" id="feelRow">
                      <button class="feelBtn" data-feel="1" type="button">üòÑ VIBIN</button>
                      <button class="feelBtn" data-feel="2" type="button">üôÇ OK</button>
                      <button class="feelBtn" data-feel="3" type="button">üòê MEH</button>
                      <button class="feelBtn" data-feel="4" type="button">üòµ COOKED</button>
                    </div>

                    <div class="kakaoRow">
                      <div class="kakaoWarn" id="kakaoWarn" style="display:none;">Bƒö≈Ω SI KOUPIT KAKAJ√çƒåKO</div>
                      <button class="kakaoBtn" id="kakaoBtn" type="button">U≈æ jsem si ho dal ‚òï</button>
                    </div>

                    <div class="hint">
                      Historie se ukl√°d√° do za≈ô√≠zen√≠ na 14 dn√≠ (emoji + label + sanity %).
                      Mimo ≈°kolu po 16:00 se ≈æiv√Ω re≈æim skryje, z≈Østane jen historie.
                    </div>

                    <div class="stackList" id="sanityHistory" style="margin-top:8px;">
                      <div class="stackItem muted">Historie: naƒç√≠t√°n√≠‚Ä¶</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Page 3: Leaderboard -->
              <div class="panelPage">
                <div class="panelInnerScroll">
                  <div class="stackList" id="lbList">
                    <div class="stackItem muted">Naƒç√≠t√°n√≠ leaderboardu‚Ä¶</div>
                  </div>
                  <div class="hint" style="margin-top:10px;">
                    Zdroj: <b>LeaderboardAb.txt</b> v GitHubu (ve stejn√© slo≈æce).
                  </div>
                </div>
              </div>
            </div>

            <div class="dots" id="dots">
              <div class="dotBtn active" data-page="0" title="Ud√°losti"></div>
              <div class="dotBtn" data-page="1" title="Sanity"></div>
              <div class="dotBtn" data-page="2" title="Leaderboard"></div>
            </div>
          </div>
        </div>

        <!-- Tracker -->
        <div class="block" id="cafaBlock">
          <div class="rowTitle">C√°fa Tracker</div>
          <div class="trackerCard">
            <div class="trackerBadge" id="cafaBadge">C√°fa</div>
            <div class="trackerMain" id="cafaMain">Naƒç√≠t√°n√≠‚Ä¶</div>
            <div class="trackerSub" id="cafaSub">‚Äî</div>
          </div>
        </div>
      </aside>
    </div>

    <div id="dailyBlock" class="block">
      <div class="rowTitle">Denn√≠ progres</div>
      <div class="dailyRow">
        <div class="badge" id="dailyBadge">Rozvrh</div>
        <div class="dailyText" id="dailyText">‚Äî</div>
      </div>
      <div class="line" style="margin-top:10px;">
        <div class="fill" id="daybar"></div>
      </div>
      <p class="label" id="daylabel"></p>
      <p class="hint" id="dailyDebug"></p>
    </div>

    <div id="timetableBlock" class="block timetable">
      <div class="tt-top">
        <div>
          <div class="rowTitle">Rozvrh</div>
          <div class="tt-sub" id="ttSub">DE3A ‚Ä¢ T√Ωdenn√≠ p≈ôehled</div>
        </div>
        <div class="tt-meta">
          <span class="tt-badge" id="ttUpdated">
            <span id="dotTt" class="dot"></span>
            <span id="ttUpdatedText">Aktualizov√°no: ‚Äî</span>
          </span>
        </div>
      </div>

      <div class="tt-gridWrap">
        <div class="tt-grid" id="ttGrid" style="--cols: 7;"></div>
      </div>
    </div>

    <div class="footer">
      <div class="footerBy">Created By Johnny Hotovost Corporation, LLC</div>
      <div>
        <span>¬© 2026 All rights reserved</span>
        <span class="footerSep">‚Ä¢</span>
        <span>Version <span id="verText">1.2.27</span></span>
        <span class="footerSep">‚Ä¢</span>
        <a href="https://ko-fi.com/johnny74802" target="_blank" rel="noopener noreferrer">Support on Ko-fi</a>
      </div>
    </div>
  </div>

  <div class="tt-tooltip" id="ttTooltip" aria-hidden="true"></div>

<script>
  /* =========================
     API CONFIG
     ========================= */
  const WORKER_BASE = "https://bakalariapi.janpilat-bp.workers.dev";
  const BACKEND_CLASS_API   = `${WORKER_BASE}/api/timetable?class=5A&type=Actual`;
  const BACKEND_TEACHER_API = `${WORKER_BASE}/api/timetable?teacher=UV069&type=Actual`;

  const CLASS_NAME = "DE3A";
  const VERSION = "1.2.27";

  /* =========================
     Minecraft splash
     ========================= */
  async function loadMinecraftSplash(){
    const el = document.getElementById("mcSplash");
    if (!el) return;

    const fallback = [
      "Now with C√°fa Tracker!",
      "Suplov√°n√≠ detected!",
      "Bakal√°≈ôi moment",
      "Touch grass after class",
      "School grind never ends",
      "Raw-Time supremacy"
    ];

    try{
      const res = await fetch("./MinecraftTextSource.txt?ts=" + Date.now(), { cache: "no-store" });
      if (!res.ok) throw new Error("source not found");
      const txt = await res.text();
      const lines = txt.split(/\r?\n/).map(x => x.trim()).filter(x => x && !x.startsWith("#"));
      el.textContent = lines.length ? lines[Math.floor(Math.random()*lines.length)] : fallback[0];
    }catch(e){
      el.textContent = fallback[Math.floor(Math.random()*fallback.length)];
    }
  }

  /* =========================
     Mode (Nonchalant/Freaky) + blue Bakal√°≈ôi
     ========================= */
  function applyTitleMode(mode){
    const titleEl = document.getElementById("pageTitle");
    if (!titleEl) return;

    if (mode === "nonchalant"){
      const blue = getComputedStyle(document.body).getPropertyValue("--bakalariBlue").trim() || "#1e88e5";
      titleEl.innerHTML = `<span style="color:${blue};">Bakal√°≈ôi</span>, kdyby nebyly mid`;
    } else if (mode === "freaky"){
      titleEl.textContent = "Kdy to utrpen√≠ skonƒç√≠";
    } else {
      titleEl.textContent = "School Progress";
    }

    localStorage.setItem("sp_mode", mode);
    const sel = document.getElementById("modeSelect");
    if (sel) sel.value = mode;
    scheduleSixSevenScan();
  }

  function initModeSelector(){
    const sel = document.getElementById("modeSelect");
    if (!sel) return;

    sel.addEventListener("change", () => applyTitleMode(sel.value));
    const saved = localStorage.getItem("sp_mode") || "normal";
    applyTitleMode(saved);
  }

  /* =========================
     SUBJECT SHORT MAP + combos
     ========================= */
  const SUBJECT_SHORT = {
    "Matematika":"MAT",
    "ƒåesk√Ω jazyk a literatura":"ƒåJL",
    "Elektrotechnika":"ELT",
    "Softwarov√© aplikace":"SWA",
    "Poƒç√≠taƒçov√© s√≠tƒõ a komunikace":"PSK",
    "Z√°kladn√≠ programov√© vybaven√≠":"ZPG",
    "V√Ωvoj aplikac√≠":"VYA",
    "V√Ωpoƒçetn√≠ technika":"VYT",
    "Ekonomie":"EKO",
    "Obƒçansk√° nauka":"OBN",
    "Fyzika":"FYZ",
    "Technick√© kreslen√≠":"TEK",
    "Tƒõlesn√° v√Ωchova":"TV",
    "Nƒõmeck√Ω jazyk":"NEJ",
    "Rusk√Ω jazyk":"RUJ",
    "Anglick√Ω jazyk":"ANJ",
    "Akce ≈°koly":"A≈†K",
    "Akce skoly":"A≈†K",
  };

  function baseShort(one){
    const x = String(one||"").trim();
    if (!x) return "";
    if (SUBJECT_SHORT[x]) return SUBJECT_SHORT[x];
    const noDia = x.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    return noDia.replace(/[^A-Za-z]/g,"").slice(0,3).toUpperCase() || x.slice(0,3).toUpperCase();
  }

  // Zachov√° ANJ1/ANJ2 + RUJ/NEJ (z group/class hintu)
  function shortSubj(full, clsHint=""){
    const s = String(full || "").trim();
    if (!s) return "";

    const split = s.includes(" / ") ? s.split(" / ") : (s.includes("/") ? s.split("/") : null);
    if (!split) return baseShort(s);

    const shorts = split.map(p => baseShort(p)).filter(Boolean);
    const uniq = [...new Set(shorts)];

    if (uniq.length === 1 && clsHint){
      const c = String(clsHint).trim();
      if (c.includes(" / ") || c.includes("/")){
        const parts = c.includes(" / ") ? c.split(" / ") : c.split("/");
        const fixed = parts.map(x => String(x).trim()).filter(Boolean);
        if (fixed.length >= 2 && fixed.every(x => x.toUpperCase().startsWith(uniq[0]))){
          return fixed.join("/");
        }
      }
    }
    return shorts.join("/");
  }

  /* =========================
     TIMES
     ========================= */
  const TIMES = [
    {start:"07:55", end:"08:40"},
    {start:"08:50", end:"09:35"},
    {start:"09:50", end:"10:35"},
    {start:"10:45", end:"11:30"},
    {start:"11:35", end:"12:20"},
    {start:"12:50", end:"13:35"},
    {start:"13:40", end:"14:25"},
  ];
  function timeToMin(hhmm){ const [h,m] = hhmm.split(":").map(Number); return h*60 + m; }
  const TIMES_MIN = TIMES.map(t => ({ startMin: timeToMin(t.start), endMin: timeToMin(t.end) }));

  // Obƒõdov√° pauza 12:20‚Äì12:50
  const LUNCH_START = timeToMin("12:20");
  const LUNCH_END   = timeToMin("12:50");

  /* =========================
     PROGRESS DATA
     ========================= */
  function localDate(y,m,d){ const dt=new Date(y,m-1,d); dt.setHours(0,0,0,0); return dt; }
  function localDateEnd(y,m,d){ const dt=new Date(y,m-1,d); dt.setHours(23,59,59,999); return dt; }
  function r(s,e){ return {s,e}; }

  const HS_START = localDate(2023, 9, 4);
  const HS_END   = localDateEnd(2027, 6, 30);
  const MATURITA_APPROX = localDateEnd(2027, 5, 1);

  const BREAKS = [
    r("2023-10-26","2023-10-27"),
    r("2023-12-23","2024-01-02"),
    r("2024-02-02","2024-02-02"),
    r("2024-02-26","2024-03-03"),
    r("2024-07-01","2024-08-31"),
    r("2024-10-29","2024-10-30"),
    r("2024-12-23","2025-01-03"),
    r("2025-01-31","2025-01-31"),
    r("2025-03-03","2025-03-09"),
    r("2025-07-01","2025-08-31"),
    r("2025-10-27","2025-10-29"),
    r("2025-12-22","2026-01-02"),
    r("2026-01-30","2026-01-30"),
    r("2026-03-09","2026-03-15"),
    r("2026-07-01","2026-08-31"),
    r("2026-10-29","2026-10-30"),
    r("2026-12-23","2027-01-03"),
    r("2027-01-29","2027-01-29"),
    r("2027-02-01","2027-02-07"),
  ];
  const DIRECTOR_DAYS = [];

  /* =========================
     STATE
     ========================= */
  const state = {
    classDays: null,
    classMarks: [],
    classEvents: [],
    classSource: "loading",

    teacherDays: null,
    teacherSource: "loading",

    infoPage: 0, // 0 events, 1 sanity, 2 leaderboard
  };

  /* =========================
     DOM helpers
     ========================= */
  const $ = (id) => document.getElementById(id);
  const clamp = (x, a=0, b=100) => Math.max(a, Math.min(b, x));
  const setBar = (id, pct, weekend=false) => {
    const n = $(id); if (!n) return;
    n.style.width = clamp(pct).toFixed(2) + "%";
    weekend ? n.classList.add("weekend") : n.classList.remove("weekend");
  };
  const setText = (id, txt) => { const n=$(id); if(n) n.textContent = txt; };

  function toISO(d){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const da=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }
  function formatDateCZ(d){
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}.${mm}.${yy}`;
  }
  function formatDateCZDateTime(d){
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${formatDateCZ(d)} ${hh}:${mi}`;
  }

  function inBreak(iso){ return BREAKS.some(x => iso>=x.s && iso<=x.e); }
  function isSchoolDay(d){
    const dow = d.getDay();
    if (dow===0 || dow===6) return false;
    const iso = toISO(d);
    if (DIRECTOR_DAYS.includes(iso)) return false;
    if (inBreak(iso)) return false;
    return true;
  }
  function countSchoolDays(start, end){
    const s = new Date(start); s.setHours(0,0,0,0);
    const e = new Date(end);   e.setHours(23,59,59,999);
    let c=0;
    const cur = new Date(s);
    while (cur <= e){
      if (isSchoolDay(cur)) c++;
      cur.setDate(cur.getDate()+1);
    }
    return c;
  }
  function calendarPctBetween(start, end, now){
    const total = end - start; if (total<=0) return 0;
    const passed = Math.min(Math.max(now-start, 0), total);
    return (passed/total)*100;
  }
  function rawPctBetween(start, end, now){
    const total = countSchoolDays(start, end);
    const clipped = now < start ? start : (now > end ? end : now);
    const passed = countSchoolDays(start, clipped);
    return total ? (passed/total)*100 : 0;
  }
  function rawDaysUntil(target, now){
    const start = new Date(now); start.setHours(0,0,0,0);
    const end = new Date(target); end.setHours(23,59,59,999);
    if (end < start) return -countSchoolDays(end, start);
    return countSchoolDays(start, end);
  }
  function getSchoolYearRange(now){
    const y = (now.getMonth()>=8) ? now.getFullYear() : now.getFullYear()-1;
    return { start: localDate(y,9,1), end: localDateEnd(y+1,6,30) };
  }

  function dayKeyFromDate(d){
    const dow = d.getDay();
    return (dow===1)?"Mon":(dow===2)?"Tue":(dow===3)?"Wed":(dow===4)?"Thu":(dow===5)?"Fri":null;
  }
  function dayLabelCz(dayKey){
    return ({Mon:"Po", Tue:"√öt", Wed:"St", Thu:"ƒåt", Fri:"P√°"})[dayKey] || dayKey || "‚Äî";
  }
  function hasAnyLesson(days){
    return Object.values(days || {}).some(arr => Array.isArray(arr) && arr.some(x => x && x.subj));
  }

  function setOnlinePills(){
    const dotClass = $("dotClass");
    const dotTeacher = $("dotTeacher");
    const statusClass = $("statusClass");
    const statusTeacher = $("statusTeacher");

    const okClass = state.classSource === "Bakal√°≈ô√≠";
    const okTeacher = state.teacherSource === "Bakal√°≈ô√≠";

    dotClass.className = "dot " + (okClass ? "ok" : "bad");
    dotTeacher.className = "dot " + (okTeacher ? "ok" : "bad");

    statusClass.textContent = "Rozvrh: " + state.classSource;
    statusTeacher.textContent = "Tracker: " + state.teacherSource;

    const dotTt = $("dotTt");
    dotTt.className = "dot " + (okClass ? "ok" : "bad");

    const dotInfo = $("dotInfo");
    dotInfo.className = "dot " + (okClass ? "ok" : "bad");
    $("infoSrc").textContent = okClass ? "Bakal√°≈ô√≠" : "Local";
  }

  function statusText(){
    $("statusHint").textContent = `Status: OK ‚Ä¢ Rozvrh: ${state.classSource} ‚Ä¢ Tracker: ${state.teacherSource}`;
    setOnlinePills();
  }

  /* =========================
     Theme + settings + scale
     ========================= */
  function applyTheme(theme){
    const body = document.body;
    body.classList.remove("theme-light","theme-dark","theme-loona","theme-sobokill","theme-kasparnakart","theme-battlecats");
    body.classList.add("theme-" + theme);
    localStorage.setItem("sp_theme", theme);

    const sel = $("themeSelect");
    if (sel) sel.value = theme;

    // refresh dots color by CSS variables only (active dot uses --accent)
  }

  function applyUiScale(percent){
    const p = Math.max(85, Math.min(120, Number(percent) || 100));
    document.body.style.setProperty("--uiScale", String(p / 100));
    $("uiScaleRange").value = String(p);
    $("uiScaleValue").textContent = `${p}%`;
    localStorage.setItem("sp_ui_scale", String(p));
    scheduleSixSevenScan();
  }

  function setInfoPanelVisible(){
    const showInfo = $("toggleInfo").checked;
    $("infoBlock").classList.toggle("hidden", !showInfo);

    const showTracker = $("toggleTracker").checked;
    $("cafaBlock").classList.toggle("hidden", !showTracker);

    const any = showInfo || showTracker;
    $("addonPanel").classList.toggle("hidden", !any);
  }

  function initSettings(){
    $("settingsBtn").addEventListener("click", () => $("settingsPanel").classList.toggle("hidden"));

    $("themeSelect").addEventListener("change", () => applyTheme($("themeSelect").value));
    $("uiScaleRange").addEventListener("input", () => applyUiScale($("uiScaleRange").value));

    $("toggleTimetable").addEventListener("change", () => {
      $("timetableBlock").classList.toggle("hidden", !$("toggleTimetable").checked);
      localStorage.setItem("sp_toggle_tt", $("toggleTimetable").checked ? "1" : "0");
      scheduleSixSevenScan();
    });
    $("toggleDaily").addEventListener("change", () => {
      $("dailyBlock").classList.toggle("hidden", !$("toggleDaily").checked);
      localStorage.setItem("sp_toggle_daily", $("toggleDaily").checked ? "1" : "0");
      scheduleSixSevenScan();
    });
    $("toggleInfo").addEventListener("change", () => {
      localStorage.setItem("sp_toggle_info", $("toggleInfo").checked ? "1" : "0");
      setInfoPanelVisible();
      scheduleSixSevenScan();
    });
    $("toggleTracker").addEventListener("change", () => {
      localStorage.setItem("sp_toggle_tracker", $("toggleTracker").checked ? "1" : "0");
      setInfoPanelVisible();
      scheduleSixSevenScan();
    });

    // load saved
    applyTheme(localStorage.getItem("sp_theme") || "dark");
    applyUiScale(localStorage.getItem("sp_ui_scale") || 100);

    const savedTT = localStorage.getItem("sp_toggle_tt");
    const savedDaily = localStorage.getItem("sp_toggle_daily");
    const savedInfo = localStorage.getItem("sp_toggle_info");
    const savedTracker = localStorage.getItem("sp_toggle_tracker");

    if (savedTT !== null) $("toggleTimetable").checked = savedTT === "1";
    if (savedDaily !== null) $("toggleDaily").checked = savedDaily === "1";
    if (savedInfo !== null) $("toggleInfo").checked = savedInfo === "1";
    if (savedTracker !== null) $("toggleTracker").checked = savedTracker === "1";

    $("timetableBlock").classList.toggle("hidden", !$("toggleTimetable").checked);
    $("dailyBlock").classList.toggle("hidden", !$("toggleDaily").checked);

    setInfoPanelVisible();
  }

  /* =========================
     Info panel carousel (3 pages)
     ========================= */
  function setInfoPage(pageIdx){
    state.infoPage = Math.max(0, Math.min(2, Number(pageIdx)||0));
    $("panelPages").style.transform = `translateX(${-state.infoPage*33.3333}%)`;

    const titles = ["Ud√°losti","Sanity","Leaderboard"];
    $("infoTitle").textContent = titles[state.infoPage];

    document.querySelectorAll(".dotBtn").forEach(btn => {
      btn.classList.toggle("active", Number(btn.dataset.page) === state.infoPage);
    });

    localStorage.setItem("sp_info_page", String(state.infoPage));
    scheduleSixSevenScan();
  }

  function initInfoPanel(){
    const saved = localStorage.getItem("sp_info_page");
    if (saved !== null) state.infoPage = Number(saved)||0;

    $("dots").addEventListener("click", (e) => {
      const t = e.target;
      if (t && t.classList.contains("dotBtn")){
        setInfoPage(t.dataset.page);
      }
    });

    setInfoPage(state.infoPage);
  }

  /* =========================
     Tooltip
     ========================= */
  const tooltip = $("ttTooltip");
  function showTooltip(html, x, y){
    tooltip.innerHTML = html;
    tooltip.style.left = x + "px";
    tooltip.style.top = y + "px";
    tooltip.style.display = "block";
    tooltip.setAttribute("aria-hidden", "false");
  }
  function moveTooltip(x, y){
    tooltip.style.left = x + "px";
    tooltip.style.top = y + "px";
  }
  function hideTooltip(){
    tooltip.style.display = "none";
    tooltip.setAttribute("aria-hidden", "true");
  }
  document.addEventListener("click", () => hideTooltip());

  function tooltipHTML(data){
    return `
      <div class="t-title">${data.dayLabel} ‚Ä¢ ${data.dateLong} ‚Ä¢ Hodina ${data.hourIdx+1}/7 (${data.time})</div>
      <div class="t-row"><div class="k">T≈ô√≠da</div><div class="v">${data.className || "-"}</div></div>
      <div class="t-row"><div class="k">P≈ôedmƒõt</div><div class="v">${data.subjFull || "-"}</div></div>
      <div class="t-row"><div class="k">Uƒçebna</div><div class="v">${data.room || "-"}</div></div>
      <div class="t-row"><div class="k">Uƒçitel</div><div class="v">${data.teacher || "-"}</div></div>
      ${data.cls ? `<div class="t-row"><div class="k">Skupina</div><div class="v">${data.cls}</div></div>` : ``}
      ${data.type ? `<div class="t-row"><div class="k">Typ</div><div class="v">${data.type}</div></div>` : ``}
      ${data.note ? `<div class="t-row"><div class="k">Popis</div><div class="v">${data.note}</div></div>` : ``}
      ${data.source ? `<div class="t-row"><div class="k">Zdroj</div><div class="v">${data.source}</div></div>` : ``}
    `;
  }

  /* =========================
     DATA pickers
     ========================= */
  function getClassDays(){
    if (state.classDays && hasAnyLesson(state.classDays)) return state.classDays;
    return { Mon:Array(7).fill(null), Tue:Array(7).fill(null), Wed:Array(7).fill(null), Thu:Array(7).fill(null), Fri:Array(7).fill(null) };
  }
  function getTeacherDays(){
    if (state.teacherDays && hasAnyLesson(state.teacherDays)) return state.teacherDays;
    return { Mon:Array(7).fill(null), Tue:Array(7).fill(null), Wed:Array(7).fill(null), Thu:Array(7).fill(null), Fri:Array(7).fill(null) };
  }

  /* =========================
     TIMETABLE render
     ========================= */
  function markForCell(dayKey, idx){
    return (state.classMarks || []).find(m => m.day===dayKey && m.idx===idx) || null;
  }

  function renderTimetable(){
    const days = getClassDays();
    const grid = $("ttGrid");
    grid.style.setProperty("--cols", TIMES.length);
    grid.innerHTML = "";

    const now = new Date();

    const corner = document.createElement("div");
    corner.className = "tt-corner";
    grid.appendChild(corner);

    TIMES.forEach((t, i) => {
      const h = document.createElement("div");
      h.className = "tt-h";
      h.innerHTML = `${i+1}<br><span>${t.start}‚Äì${t.end}</span>`;
      grid.appendChild(h);
    });

    const dayOrder = [
      {key:"Mon", label:"Po"},
      {key:"Tue", label:"√öt"},
      {key:"Wed", label:"St"},
      {key:"Thu", label:"ƒåt"},
      {key:"Fri", label:"P√°"},
    ];

    for (const d of dayOrder){
      const dayCell = document.createElement("div");
      dayCell.className = "tt-day";
      dayCell.textContent = d.label;
      grid.appendChild(dayCell);

      for (let i=0;i<TIMES.length;i++){
        const base = (days[d.key] && days[d.key][i]) ? days[d.key][i] : null;
        const mk = markForCell(d.key, i);

        const cell = document.createElement("div");
        cell.className = "tt-cell";
        cell.dataset.day = d.key;
        cell.dataset.idx = String(i);

        if (!base && !mk){
          cell.classList.add("tt-empty");
          cell.textContent = "‚Äî";
          grid.appendChild(cell);
          continue;
        }

        let type = "";
        if (mk?.type === "event") { cell.classList.add("tt-event"); type = "Akce"; }
        if (mk?.type === "subst") { cell.classList.add("tt-subst"); type = "Suplov√°n√≠"; }
        if (mk?.type === "cancel") { cell.classList.add("tt-cancel"); type = "Odpadlo"; }

        const subjFull = base?.subj || (mk?.type==="event" ? "Akce" : "");
        const room = base?.room || mk?.room || "";
        const teacher = base?.teacher || "";
        const cls = base?.class || "";
        const note = mk?.note || base?.note || "";

        const subjShort = shortSubj(subjFull, cls);

        const topline = document.createElement("div");
        topline.className = "tt-topline";
        topline.innerHTML = `<span class="cls">${CLASS_NAME}</span><span class="room">${room || ""}</span>`;
        cell.appendChild(topline);

        const subjEl = document.createElement("div");
        subjEl.className = "tt-subj";
        subjEl.textContent = subjShort || "‚Äî";
        cell.appendChild(subjEl);

        const teacherEl = document.createElement("div");
        teacherEl.className = "tt-teacher";
        teacherEl.textContent = teacher || "";
        cell.appendChild(teacherEl);

        const tdata = {
          dayLabel: d.label,
          dateLong: formatDateCZ(now),
          hourIdx: i,
          time: `${TIMES[i].start}‚Äì${TIMES[i].end}`,
          className: CLASS_NAME,
          subjFull,
          room,
          teacher,
          cls,
          note,
          type,
          source: state.classSource
        };

        cell.addEventListener("mouseenter", (e) => showTooltip(tooltipHTML(tdata), e.clientX, e.clientY));
        cell.addEventListener("mousemove", (e) => moveTooltip(e.clientX, e.clientY));
        cell.addEventListener("mouseleave", () => hideTooltip());

        cell.addEventListener("click", (e) => {
          e.stopPropagation();
          const visible = tooltip.style.display === "block";
          if (visible) hideTooltip();
          else showTooltip(tooltipHTML(tdata), e.clientX || (window.innerWidth/2), e.clientY || (window.innerHeight/2));
        });

        grid.appendChild(cell);
      }
    }

    $("ttUpdatedText").textContent = `Aktualizov√°no: ${formatDateCZDateTime(new Date())} ‚Ä¢ ${state.classSource}`;
    updateTimetableNowHighlight();
    scheduleSixSevenScan();
  }

  function updateTimetableNowHighlight(){
    const now = new Date();
    const todayKey = dayKeyFromDate(now);
    const nowMin = now.getHours()*60 + now.getMinutes();

    document.querySelectorAll("#ttGrid .tt-cell[data-day][data-idx]").forEach(cell => {
      const day = cell.dataset.day;
      const idx = Number(cell.dataset.idx);
      const t = TIMES_MIN[idx];
      const isNow = (todayKey === day && t && nowMin >= t.startMin && nowMin <= t.endMin);
      cell.classList.toggle("tt-now", !!isNow);
    });
  }

  /* =========================
     EVENTS page
     ========================= */
  function renderEventsPanel(){
    const list = $("eventsList");
    list.innerHTML = "";

    const dayOrderMap = {Mon:1, Tue:2, Wed:3, Thu:4, Fri:5};
    const evs = Array.isArray(state.classEvents) ? state.classEvents : [];
    const marks = Array.isArray(state.classMarks) ? state.classMarks : [];

    if (!evs.length && !marks.length){
      const empty = document.createElement("div");
      empty.className = "stackItem muted";
      empty.textContent = "≈Ω√°dn√© ud√°losti (zat√≠m)";
      list.appendChild(empty);
      scheduleSixSevenScan();
      return;
    }

    const evSorted = [...evs].sort((a,b) => (dayOrderMap[a.dayKey]-dayOrderMap[b.dayKey]) || String(a.begin||"").localeCompare(String(b.begin||"")));
    for (const e of evSorted){
      const item = document.createElement("div");
      item.className = "stackItem event";

      const title = document.createElement("div");
      title.className = "eventTitle";
      title.textContent = e.name || "Akce";

      const meta = document.createElement("div");
      meta.className = "eventMeta";
      meta.textContent = `${e.dayText || dayLabelCz(e.dayKey) || "‚Äî"}${(e.begin && e.end) ? ` ‚Ä¢ ${e.begin}‚Äì${e.end}` : ""}`;

      const desc = document.createElement("div");
      desc.className = "eventDesc";
      desc.textContent = e.info || "";

      item.appendChild(title);
      item.appendChild(meta);
      if (e.info) item.appendChild(desc);
      list.appendChild(item);
    }

    const markSorted = [...marks].sort((a,b) => (dayOrderMap[a.day]-dayOrderMap[b.day]) || (a.idx-b.idx));
    for (const ev of markSorted){
      if (ev.type === "event") continue;

      const item = document.createElement("div");
      item.className = "stackItem " + (ev.type || "");

      const title = document.createElement("div");
      title.className = "eventTitle";
      title.textContent = ev.type === "subst" ? "Suplov√°n√≠" : "Odpadlo";

      const meta = document.createElement("div");
      meta.className = "eventMeta";
      meta.textContent = `${dayLabelCz(ev.day)} ‚Ä¢ hodina ${ev.idx+1}/7 ‚Ä¢ ${TIMES[ev.idx]?.start || ""}‚Äì${TIMES[ev.idx]?.end || ""}${ev.room ? " ‚Ä¢ "+ev.room : ""}`;

      const desc = document.createElement("div");
      desc.className = "eventDesc";
      desc.textContent = ev.note || "";

      item.appendChild(title);
      item.appendChild(meta);
      if (ev.note) item.appendChild(desc);
      list.appendChild(item);
    }

    scheduleSixSevenScan();
  }

  /* =========================
     CAFA TRACKER (clean)
     ========================= */
  function updateCafaTracker(now){
    const badge = $("cafaBadge");
    const main = $("cafaMain");
    const sub = $("cafaSub");

    const dayKey = dayKeyFromDate(now);
    const days = getTeacherDays();
    const src = state.teacherSource;

    const nowMin = now.getHours()*60 + now.getMinutes();

    // mimo ≈°kolu po 16:00 -> pryƒç (jak jsi chtƒõl)
    if (now.getHours() >= 16){
      main.textContent = "C√°fa se skr√Ωv√° ve st√≠nech üòé";
      sub.textContent = `${formatDateCZ(now)} ‚Ä¢ ${src}`;
      scheduleSixSevenScan();
      return;
    }

    if (!dayKey){
      main.textContent = "C√°fa se skr√Ωv√° ve st√≠nech üòé";
      sub.textContent = `V√≠kend ‚Ä¢ ${formatDateCZ(now)} ‚Ä¢ ${src}`;
      scheduleSixSevenScan();
      return;
    }

    const arr = days[dayKey] || Array(7).fill(null);

    // obƒõdov√° pauza
    if (nowMin >= LUNCH_START && nowMin < LUNCH_END){
      // najdi posledn√≠ vidƒõn√≠ (posledn√≠ hodina kter√° skonƒçila)
      let lastIdx = null;
      for (let i=0;i<7;i++){
        if (TIMES_MIN[i].endMin <= nowMin) lastIdx = i;
      }
      const last = (lastIdx !== null) ? arr[lastIdx] : null;

      main.textContent = "Obƒõdov√° pauza üçΩÔ∏è";
      sub.textContent = last
        ? `Naposledy: ${shortSubj(last.subj, last.class||"")} ‚Ä¢ ${last.room||"‚Äî"} ‚Ä¢ ${last.class||"‚Äî"} ‚Ä¢ ${src}`
        : `${dayLabelCz(dayKey)} ‚Ä¢ ${src}`;
      scheduleSixSevenScan();
      return;
    }

    let curIdx = null;
    for (let i=0;i<7;i++){
      const t = TIMES_MIN[i];
      if (nowMin >= t.startMin && nowMin <= t.endMin){ curIdx=i; break; }
    }

    if (curIdx === null){
      main.textContent = "C√°fa se skr√Ωv√° ve st√≠nech üòé";
      sub.textContent = `${dayLabelCz(dayKey)} ‚Ä¢ mimo hodiny ‚Ä¢ ${src}`;
      scheduleSixSevenScan();
      return;
    }

    const l = arr[curIdx];
    if (!l){
      main.textContent = "C√°fa se skr√Ωv√° ve st√≠nech üòé";
      sub.textContent = `${dayLabelCz(dayKey)} ‚Ä¢ hodina ${curIdx+1}/7 ‚Ä¢ ${TIMES[curIdx].start}‚Äì${TIMES[curIdx].end} ‚Ä¢ ${src}`;
      scheduleSixSevenScan();
      return;
    }

    // clean output: p≈ôedmƒõt + uƒçebna + t≈ô√≠da
    main.textContent = `${shortSubj(l.subj, l.class||"")} ‚Ä¢ ${l.room || "‚Äî"} ‚Ä¢ ${l.class || "‚Äî"}`;
    sub.textContent = `${dayLabelCz(dayKey)} ‚Ä¢ hodina ${curIdx+1}/7 ‚Ä¢ ${TIMES[curIdx].start}‚Äì${TIMES[curIdx].end} ‚Ä¢ ${src}`;
    scheduleSixSevenScan();
  }

  /* =========================
     DAILY PROGRESS (with lunch pause)
     ========================= */
  function setDailyBadge(kind, text){
    const b=$("dailyBadge");
    b.className = "badge" + (kind ? (" "+kind) : "");
    b.textContent = text;
  }

  function fmtLesson(x){
    if (!x) return null;
    const room = x.room ? ` (${x.room})` : "";
    return `${shortSubj(x.subj, x.class||"")}${room}`;
  }

  function countTodayLessons(arr){
    let last = -1;
    for (let i=0;i<arr.length;i++){
      if (arr[i] && arr[i].subj) last = i;
    }
    return Math.max(last+1, 0) || 7;
  }

  function updateDaily(now){
    const dayKey = dayKeyFromDate(now);
    const days = getClassDays();
    const nowMin = now.getHours()*60 + now.getMinutes();

    if (!dayKey){
      setDailyBadge("free","Volno");
      setText("dailyText","Volno üòé");
      setBar("daybar",100);
      setText("daylabel","");
      setText("dailyDebug", `Weekend ‚Ä¢ ${formatDateCZ(now)}`);
      scheduleSixSevenScan();
      return;
    }

    // obƒõdov√° pauza
    if (nowMin >= LUNCH_START && nowMin < LUNCH_END){
      setDailyBadge("live","Obƒõd");
      setText("dailyText","Obƒõdov√° pauza üçΩÔ∏è");
      setBar("daybar", 0);
      setText("daylabel", `12:20‚Äì12:50`);
      setText("dailyDebug", `${dayKey} ‚Ä¢ ${formatDateCZ(now)}`);
      scheduleSixSevenScan();
      return;
    }

    const lessons = (days[dayKey] || []).slice(0, 7);
    const totalToday = countTodayLessons(lessons);

    const first = TIMES_MIN[0];
    const last = TIMES_MIN[totalToday-1] || TIMES_MIN[6];

    if (nowMin > last.endMin){
      setDailyBadge("free","Volno");
      setText("dailyText","Volno üòé");
      setBar("daybar",100);
      setText("daylabel","");
      setText("dailyDebug", `${dayKey} ‚Ä¢ ${formatDateCZ(now)}`);
      scheduleSixSevenScan();
      return;
    }

    if (nowMin < first.startMin){
      setDailyBadge("live","Dnes");
      const next = fmtLesson(lessons[0]) || `Hodina 1/${totalToday}`;
      setText("dailyText",`Za chv√≠li zaƒçne: ${next}`);
      setBar("daybar",0);
      setText("daylabel",`Hodina 1/${totalToday} ‚Ä¢ start v ${TIMES[0].start}`);
      setText("dailyDebug", `${dayKey} ‚Ä¢ ${formatDateCZ(now)}`);
      scheduleSixSevenScan();
      return;
    }

    for (let i=0;i<totalToday;i++){
      const t = TIMES_MIN[i];
      const cur = fmtLesson(lessons[i]) || `Hodina ${i+1}/${totalToday}`;
      const next = (i+1<totalToday) ? (fmtLesson(lessons[i+1]) || `Hodina ${i+2}/${totalToday}`) : null;

      if (nowMin >= t.startMin && nowMin <= t.endMin){
        const pct = ((nowMin - t.startMin) / Math.max(1,(t.endMin - t.startMin))) * 100;
        setDailyBadge("live","Pr√°vƒõ");
        setText("dailyText", next ? `Pr√°vƒõ: ${cur} ‚Ä¢ Dal≈°√≠: ${next}` : `Pr√°vƒõ: ${cur}`);
        setBar("daybar", pct);
        setText("daylabel", `Hodina ${i+1}/${totalToday} ‚Ä¢ ${TIMES[i].start}‚Äì${TIMES[i].end} ‚Ä¢ ${pct.toFixed(0)}%`);
        setText("dailyDebug", `${dayKey} ‚Ä¢ ${formatDateCZ(now)}`);
        scheduleSixSevenScan();
        return;
      }

      const nt = TIMES_MIN[i+1];
      if (nt && nowMin > t.endMin && nowMin < nt.startMin){
        setDailyBadge("live","Pauza");
        setText("dailyText", `N√°sleduje: ${next}`);
        setBar("daybar", 0);
        setText("daylabel", `Dal≈°√≠ hodina ${i+2}/${totalToday} v ${TIMES[i+1].start}`);
        setText("dailyDebug", `${dayKey} ‚Ä¢ ${formatDateCZ(now)}`);
        scheduleSixSevenScan();
        return;
      }
    }

    setDailyBadge("free","Volno");
    setText("dailyText","Volno üòé");
    setBar("daybar",100);
    setText("daylabel","");
    setText("dailyDebug", `${dayKey} ‚Ä¢ ${formatDateCZ(now)}`);
    scheduleSixSevenScan();
  }

  /* =========================
     PROGRESS BARS
     ========================= */
  function updateProgressBars(){
    const now = new Date();
    const timeInDay = now.getHours()/24 + now.getMinutes()/1440;

    const dow = now.getDay();
    const weekend = (dow===0 || dow===6);
    const workIndex = (dow===1)?0:(dow===2)?1:(dow===3)?2:(dow===4)?3:(dow===5)?4:4;
    const weekPct = weekend ? 100 : ((workIndex + timeInDay)/5)*100;

    setBar("rt-week", weekPct, weekend);
    setText("rt-week-label", weekend ? "Weekend üòé" : `T√Ωden: ${weekPct.toFixed(1)}%`);
    setBar("raw-week", weekPct, false);
    setText("raw-week-label", `T√Ωden: ${weekPct.toFixed(1)}%`);

    const dim = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
    const monthPct = ((now.getDate()-1 + timeInDay)/dim)*100;
    setBar("rt-month", monthPct);
    setText("rt-month-label", `Mƒõs√≠c: ${monthPct.toFixed(1)}%`);

    const mStart = localDate(now.getFullYear(), now.getMonth()+1, 1);
    const mEnd   = localDateEnd(now.getFullYear(), now.getMonth()+1, dim);
    const monthRaw = rawPctBetween(mStart, mEnd, now);
    setBar("raw-month", monthRaw);
    setText("raw-month-label", `Mƒõs√≠c: ${monthRaw.toFixed(1)}%`);

    const yr = getSchoolYearRange(now);
    const yearPct = calendarPctBetween(yr.start, yr.end, now);
    setBar("rt-year", yearPct);
    setText("rt-year-label", `≈†koln√≠ rok: ${yearPct.toFixed(1)}%`);
    const yearRaw = rawPctBetween(yr.start, yr.end, now);
    setBar("raw-year", yearRaw);
    setText("raw-year-label", `≈†koln√≠ rok: ${yearRaw.toFixed(1)}%`);

    const totalPct = calendarPctBetween(HS_START, HS_END, now);
    setBar("rt-total", totalPct);
    setText("rt-total-label", `Celkem: ${totalPct.toFixed(1)}%`);
    const totalRaw = rawPctBetween(HS_START, HS_END, now);
    setBar("raw-total", totalRaw);
    setText("raw-total-label", `Celkem: ${totalRaw.toFixed(1)}%`);

    const daysUntil = Math.ceil((MATURITA_APPROX - now) / (1000*60*60*24));
    setText("rt-maturita-label", (daysUntil>=0)
      ? `Real-Time: ~${daysUntil} dn√≠`
      : `Real-Time: hotovo (${Math.abs(daysUntil)} dn√≠ zpƒõt)`
    );

    const rawDays = rawDaysUntil(MATURITA_APPROX, now);
    setText("raw-maturita-label", (rawDays>=0)
      ? `Raw-Time: ~${rawDays} ≈°koln√≠ch dn√≠`
      : `Raw-Time: hotovo (${Math.abs(rawDays)} ≈°koln√≠ch dn√≠ zpƒõt)`
    );

    scheduleSixSevenScan();
  }

  /* =========================
     BACKEND SYNC
     ========================= */
  async function fetchJsonSafe(url){
    try{
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }catch(err){
      return { __error: String(err?.message || err) };
    }
  }

  async function syncBackend(){
    const c = await fetchJsonSafe(BACKEND_CLASS_API);
    if (!c.__error && c.ok && c.days && hasAnyLesson(c.days)){
      state.classDays = c.days;
      state.classMarks = Array.isArray(c.marks) ? c.marks : [];
      state.classEvents = Array.isArray(c.events) ? c.events : [];
      state.classSource = "Bakal√°≈ô√≠";
    } else {
      state.classSource = "Lok√°ln√≠";
    }

    const t = await fetchJsonSafe(BACKEND_TEACHER_API);
    if (!t.__error && t.ok && t.days && hasAnyLesson(t.days)){
      state.teacherDays = t.days;
      state.teacherSource = "Bakal√°≈ô√≠";
    } else {
      state.teacherSource = "Lok√°ln√≠";
    }

    statusText();
    renderTimetable();
    renderEventsPanel();
    updateCafaTracker(new Date());
    updateDaily(new Date());
    // sanity depends on lesson time, so refresh draw
    sanityTick(new Date());
    scheduleSixSevenScan();
  }

  /* =========================
     six seven wrapper (idempotent) + hand emote
     ========================= */
  let ssScanTimer = null;
  function scheduleSixSevenScan(){
    if (ssScanTimer) clearTimeout(ssScanTimer);
    ssScanTimer = setTimeout(() => {
      try { wrapSixSeven(document.querySelector(".wrap")); } catch {}
    }, 80);
  }

  function wrapSixSeven(root){
    if (!root) return;
    const SKIP_TAGS = new Set(["SCRIPT","STYLE","NOSCRIPT","TEXTAREA","INPUT","SELECT","OPTION"]);
    const reHit = /6\s*\/\s*7|6\.7|67/;

    const patterns = [
      /6\s*\/\s*7/g,
      /6\.7(?:\.\d{2,4})?/g,
      /67/g
    ];

    const makeSS = (txt) => {
      const wrap = document.createElement("span");
      wrap.className = "ss";
      wrap.setAttribute("data-ss", "1");

      const clean = String(txt).replace(/\s+/g,"");
      const s6 = document.createElement("span"); s6.className = "d d6"; s6.textContent = "6";
      const mid = document.createElement("span"); mid.className = "d";
      if (clean.includes("/")) mid.textContent = "/";
      else if (clean.includes(".")) mid.textContent = ".";
      else mid.textContent = "";
      const s7 = document.createElement("span"); s7.className = "d d7"; s7.textContent = "7";

      wrap.appendChild(s6);
      if (mid.textContent) wrap.appendChild(mid);
      wrap.appendChild(s7);
      return wrap;
    };

    const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
      acceptNode(node){
        const p = node.parentNode;
        if (!p || SKIP_TAGS.has(p.nodeName)) return NodeFilter.FILTER_REJECT;
        if (p.closest && p.closest(".tt-tooltip")) return NodeFilter.FILTER_REJECT;
        if (p.closest && p.closest(".ss")) return NodeFilter.FILTER_REJECT;
        if (!node.nodeValue || !reHit.test(node.nodeValue)) return NodeFilter.FILTER_REJECT;
        return NodeFilter.FILTER_ACCEPT;
      }
    });

    const nodes = [];
    while (walker.nextNode()) nodes.push(walker.currentNode);

    for (const textNode of nodes){
      const original = textNode.nodeValue;
      let parts = [{ text: original, isMatch: false }];

      for (const re of patterns){
        const nextParts = [];
        for (const part of parts){
          if (part.isMatch){ nextParts.push(part); continue; }
          const s = part.text;
          let last = 0, m;
          re.lastIndex = 0;
          while ((m = re.exec(s)) !== null){
            if (m.index > last) nextParts.push({ text: s.slice(last, m.index), isMatch:false });
            nextParts.push({ text: m[0], isMatch:true });
            last = m.index + m[0].length;
          }
          if (last < s.length) nextParts.push({ text: s.slice(last), isMatch:false });
        }
        parts = nextParts;
      }

      if (!parts.some(p => p.isMatch)) continue;

      const frag = document.createDocumentFragment();
      for (const p of parts){
        if (!p.isMatch) frag.appendChild(document.createTextNode(p.text));
        else frag.appendChild(makeSS(p.text));
      }
      textNode.parentNode.replaceChild(frag, textNode);
    }
  }

  function triggerSixSevenEmote(){
    const els = document.querySelectorAll(".ss[data-ss='1']");
    if (!els.length) return;
    els.forEach(el => {
      el.classList.remove("hot");
      void el.offsetWidth;
      el.classList.add("hot");
    });
    setTimeout(() => els.forEach(el => el.classList.remove("hot")), 1200);
  }

  /* =========================
     SANITY METER + 14-day history
     ========================= */
  const SANITY_KEY = "sp_sanity_log_v1";
  const SANITY_BASE = 100;
  const SANITY_PILL_BOOST = 30;

  // falls naturally. "feel" increases fall rate (worse => faster).
  function sanityDecayPerMinute(feel){
    // feel: 1 vibin -> 0.06/min, 2 ok -> 0.10/min, 3 meh -> 0.16/min, 4 cooked -> 0.24/min
    if (feel===1) return 0.06;
    if (feel===2) return 0.10;
    if (feel===3) return 0.16;
    return 0.24;
  }

  function sanityLabel(feel){
    if (feel===1) return { emoji:"üòÑ", text:"VIBIN" };
    if (feel===2) return { emoji:"üôÇ", text:"OK" };
    if (feel===3) return { emoji:"üòê", text:"MEH" };
    return { emoji:"üòµ", text:"COOKED" };
  }

  function loadSanityLog(){
    try{
      const raw = localStorage.getItem(SANITY_KEY);
      if (!raw) return [];
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return [];
      return arr;
    }catch{ return []; }
  }
  function saveSanityLog(arr){
    localStorage.setItem(SANITY_KEY, JSON.stringify(arr));
  }

  function pruneSanityLog(arr){
    const cutoff = Date.now() - 14*24*60*60*1000;
    return arr.filter(x => x && x.t >= cutoff);
  }

  function getCurrentSchoolHourIndex(now){
    const dayKey = dayKeyFromDate(now);
    if (!dayKey) return null;

    const nowMin = now.getHours()*60 + now.getMinutes();
    // exclude lunch
    if (nowMin >= LUNCH_START && nowMin < LUNCH_END) return "lunch";

    for (let i=0;i<7;i++){
      const t = TIMES_MIN[i];
      if (nowMin >= t.startMin && nowMin <= t.endMin) return i;
    }
    return null;
  }

  function isLiveSanityAllowed(now){
    // only during school day time window; after 16:00 no live
    if (now.getHours() >= 16) return false;
    const idx = getCurrentSchoolHourIndex(now);
    return idx !== null && idx !== "lunch";
  }

  function ensureSanityCanvasSize(){
    const canvas = $("sanityCanvas");
    if (!canvas) return;
    const rect = canvas.getBoundingClientRect();
    const dpr = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    canvas.width = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    const ctx = canvas.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  function computeSanitySeries(now){
    // Build a day series based on log + decay model.
    const log = pruneSanityLog(loadSanityLog());
    const dayISO = formatDateCZ(now);
    const start = new Date(now); start.setHours(7,55,0,0);
    const end = new Date(now); end.setHours(16,0,0,0);

    // initial sanity:
    let sanity = SANITY_BASE;

    // apply kakao boosts in log by day
    // log items shape:
    // { t, type:"feel", feel, hourIdx, label, sanityAt }
    // { t, type:"kakao", boost }
    const itemsToday = log.filter(x => {
      const d = new Date(x.t);
      return formatDateCZ(d) === dayISO;
    }).sort((a,b)=>a.t-b.t);

    // We'll simulate minute by minute (coarse) using last known feel (default 2).
    let feel = 2;
    let ptr = 0;

    const points = [];
    const stepMs = 2*60*1000; // every 2 minutes
    for (let t = start.getTime(); t <= Math.min(end.getTime(), now.getTime()); t += stepMs){
      while (ptr < itemsToday.length && itemsToday[ptr].t <= t){
        const it = itemsToday[ptr];
        if (it.type === "feel") feel = it.feel || feel;
        if (it.type === "kakao") sanity = Math.min(100, sanity + (it.boost || SANITY_PILL_BOOST));
        ptr++;
      }
      // decay
      const mins = stepMs / (60*1000);
      sanity = Math.max(0, sanity - sanityDecayPerMinute(feel)*mins);
      points.push({ t, sanity, feel });
    }

    return { points, lastSanity: (points.at(-1)?.sanity ?? sanity), lastFeel: (points.at(-1)?.feel ?? feel), log };
  }

  function drawSanity(now){
    const canvas = $("sanityCanvas");
    if (!canvas) return;

    const ctx = canvas.getContext("2d");
    const rect = canvas.getBoundingClientRect();

    // clear
    ctx.clearRect(0,0,rect.width,rect.height);

    // background
    ctx.fillStyle = "rgba(0,0,0,0.06)";
    ctx.fillRect(0,0,rect.width,rect.height);

    const { points, lastSanity, lastFeel } = computeSanitySeries(now);

    // axes
    ctx.strokeStyle = "rgba(255,255,255,0.10)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(8, 8);
    ctx.lineTo(8, rect.height-8);
    ctx.lineTo(rect.width-8, rect.height-8);
    ctx.stroke();

    // line color by sanity
    const accent = getComputedStyle(document.body).getPropertyValue("--accent").trim() || "#3bb54a";
    ctx.strokeStyle = accent;
    ctx.lineWidth = 2;

    const maxX = rect.width-16;
    const maxY = rect.height-16;
    const toX = (i) => 8 + (i/(Math.max(1, points.length-1))) * maxX;
    const toY = (s) => 8 + (1 - (s/100)) * maxY;

    if (points.length){
      ctx.beginPath();
      ctx.moveTo(toX(0), toY(points[0].sanity));
      for (let i=1;i<points.length;i++){
        ctx.lineTo(toX(i), toY(points[i].sanity));
      }
      ctx.stroke();

      // current dot
      ctx.fillStyle = "rgba(255,152,0,0.95)";
      ctx.beginPath();
      ctx.arc(toX(points.length-1), toY(points.at(-1).sanity), 4, 0, Math.PI*2);
      ctx.fill();
    }

    // text
    const feelLabel = sanityLabel(lastFeel);
    $("sanityValue").textContent = `${Math.round(lastSanity)}% ‚Ä¢ ${feelLabel.emoji} ${feelLabel.text}`;

    const live = isLiveSanityAllowed(now);
    $("sanityMeta").textContent = live ? "LIVE (bƒõ≈æ√≠ bƒõhem hodiny)" : "MIMO ≈†KOLU (jen historie)";

    // kakao button
    const warn = $("kakaoWarn");
    const btn = $("kakaoBtn");
    if (live && lastSanity <= 25){
      warn.style.display = "block";
      btn.classList.add("show");
    } else {
      warn.style.display = "none";
      btn.classList.remove("show");
    }
  }

  function renderSanityHistory(){
    const box = $("sanityHistory");
    if (!box) return;

    const log = pruneSanityLog(loadSanityLog()).sort((a,b)=>b.t-a.t);

    if (!log.length){
      box.innerHTML = `<div class="stackItem muted">≈Ω√°dn√° historie (zat√≠m)</div>`;
      return;
    }

    // show last ~14 entries to keep it clean
    const take = log.slice(0, 20);

    box.innerHTML = "";
    for (const it of take){
      const d = new Date(it.t);
      const t = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
      const dd = formatDateCZ(d);

      const row = document.createElement("div");
      row.className = "stackItem";

      if (it.type === "feel"){
        const lab = sanityLabel(it.feel || 3);
        row.innerHTML = `<div class="eventTitle">${lab.emoji} ${lab.text}</div>
                         <div class="eventMeta">${dd} ‚Ä¢ ${t} ‚Ä¢ hodina ${String((it.hourIdx||0)+1)}/7</div>
                         <div class="eventDesc">Sanity: ${Math.round(it.sanityAt ?? 0)}%</div>`;
      } else if (it.type === "kakao"){
        row.innerHTML = `<div class="eventTitle">‚òï Kakaj√≠ƒçko</div>
                         <div class="eventMeta">${dd} ‚Ä¢ ${t}</div>
                         <div class="eventDesc">+${it.boost || SANITY_PILL_BOOST}% sanity</div>`;
      } else {
        row.innerHTML = `<div class="eventTitle">Z√°znam</div><div class="eventMeta">${dd} ‚Ä¢ ${t}</div>`;
      }

      box.appendChild(row);
    }
  }

  function writeSanityFeel(feel, now){
    // allow only during hour
    if (!isLiveSanityAllowed(now)) return;

    const idx = getCurrentSchoolHourIndex(now);
    if (typeof idx !== "number") return;

    // compute current sanity at time now
    const { lastSanity } = computeSanitySeries(now);
    const lab = sanityLabel(feel);

    let log = pruneSanityLog(loadSanityLog());
    log.push({
      t: now.getTime(),
      type: "feel",
      feel,
      hourIdx: idx,
      label: `${lab.emoji} ${lab.text}`,
      sanityAt: lastSanity
    });
    log = pruneSanityLog(log);
    saveSanityLog(log);

    drawSanity(now);
    renderSanityHistory();
    scheduleSixSevenScan();
  }

  function writeKakao(now){
    if (!isLiveSanityAllowed(now)) return;

    let log = pruneSanityLog(loadSanityLog());
    log.push({
      t: now.getTime(),
      type: "kakao",
      boost: SANITY_PILL_BOOST
    });
    log = pruneSanityLog(log);
    saveSanityLog(log);

    drawSanity(now);
    renderSanityHistory();
    scheduleSixSevenScan();
  }

  function sanityTick(now){
    ensureSanityCanvasSize();
    drawSanity(now);
    renderSanityHistory();
  }

  function initSanity(){
    ensureSanityCanvasSize();
    window.addEventListener("resize", () => {
      ensureSanityCanvasSize();
      drawSanity(new Date());
    });

    $("feelRow").addEventListener("click", (e) => {
      const b = e.target;
      if (b && b.classList.contains("feelBtn")){
        writeSanityFeel(Number(b.dataset.feel), new Date());
      }
    });
    $("kakaoBtn").addEventListener("click", () => writeKakao(new Date()));
  }

  /* =========================
     LEADERBOARD (LeaderboardAb.txt)
     ========================= */
  async function loadLeaderboard(){
    const box = $("lbList");
    if (!box) return;

    try{
      const res = await fetch("./LeaderboardAb.txt?ts=" + Date.now(), { cache:"no-store" });
      if (!res.ok) throw new Error("not found");
      const txt = await res.text();

      const lines = txt.split(/\r?\n/).map(x=>x.trim()).filter(Boolean).filter(x=>!x.startsWith("#"));
      if (!lines.length){
        box.innerHTML = `<div class="stackItem muted">Leaderboard pr√°zdn√Ω</div>`;
        return;
      }

      // format supported:
      // Name - 12
      // Name: 12
      // Name,12
      const rows = [];
      for (const line of lines){
        let name="", val="";
        if (line.includes(" - ")){
          [name,val] = line.split(" - ");
        } else if (line.includes(":")){
          [name,val] = line.split(":");
        } else if (line.includes(",")){
          [name,val] = line.split(",");
        } else {
          name = line;
          val = "";
        }
        name = String(name||"").trim();
        val = String(val||"").trim();
        rows.push({ name, val });
      }

      box.innerHTML = "";
      for (const r of rows){
        const div = document.createElement("div");
        div.className = "lbRow";
        div.innerHTML = `<div class="lbName">${escapeHtml(r.name)}</div><div class="lbVal">${escapeHtml(r.val)}</div>`;
        box.appendChild(div);
      }
    }catch(e){
      box.innerHTML = `<div class="stackItem muted">Nepovedlo se naƒç√≠st LeaderboardAb.txt</div>`;
    }
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  /* =========================
     six-seven emote timer
     ========================= */
  function triggerSixSevenEmote(){
    const els = document.querySelectorAll(".ss[data-ss='1']");
    if (!els.length) return;
    els.forEach(el => {
      el.classList.remove("hot");
      void el.offsetWidth;
      el.classList.add("hot");
    });
    setTimeout(() => els.forEach(el => el.classList.remove("hot")), 1200);
  }

  /* =========================
     BACKEND DATA pull + UI refresh
     ========================= */
  async function fetchAndApply(){
    await syncBackend();
    await loadLeaderboard();
  }

  /* =========================
     BOOT + LOOP
     ========================= */
  function tick(){
    const now = new Date();

    updateProgressBars();
    if ($("toggleDaily").checked) updateDaily(now);

    if ($("toggleTracker").checked) updateCafaTracker(now);

    // keep highlight accurate without rerender
    updateTimetableNowHighlight();

    // sanity tick always (it just switches to history mode)
    sanityTick(now);
  }

  function boot(){
    $("verText").textContent = VERSION;

    initSettings();
    initModeSelector();
    initInfoPanel();
    initSanity();
    loadMinecraftSplash();

    state.classSource = "loading";
    state.teacherSource = "loading";
    statusText();

    renderTimetable();
    renderEventsPanel();
    loadLeaderboard();

    tick();

    fetchAndApply();

    scheduleSixSevenScan();
    setInterval(triggerSixSevenEmote, 10_000);

    setInterval(tick, 30_000);
    setInterval(fetchAndApply, 5 * 60_000);
  }

  document.addEventListener("DOMContentLoaded", boot);
</script>
</body>
</html>